<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Costin-Andrei Taulescu &amp; Panagiotis Valsamis">
<meta name="dcterms.date" content="2026-01-27">

<title>Time Series Forecasting: Walmart Sales Analysis Part 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Part2_files/libs/clipboard/clipboard.min.js"></script>
<script src="Part2_files/libs/quarto-html/quarto.js"></script>
<script src="Part2_files/libs/quarto-html/popper.min.js"></script>
<script src="Part2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Part2_files/libs/quarto-html/anchor.min.js"></script>
<link href="Part2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Part2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Part2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Part2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Part2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#evaluation-metric" id="toc-evaluation-metric" class="nav-link" data-scroll-target="#evaluation-metric">Evaluation Metric</a></li>
  <li><a href="#procedure" id="toc-procedure" class="nav-link" data-scroll-target="#procedure">Procedure</a></li>
  <li><a href="#setup-and-imports" id="toc-setup-and-imports" class="nav-link" data-scroll-target="#setup-and-imports">Setup and Imports</a></li>
  <li><a href="#step-1-importing-and-visualizing-the-data-of-store-2" id="toc-step-1-importing-and-visualizing-the-data-of-store-2" class="nav-link" data-scroll-target="#step-1-importing-and-visualizing-the-data-of-store-2">Step 1: Importing and Visualizing the Data of Store 2</a></li>
  <li><a href="#statistical-testing-for-trend-using-run_trend_analysis-python-script" id="toc-statistical-testing-for-trend-using-run_trend_analysis-python-script" class="nav-link" data-scroll-target="#statistical-testing-for-trend-using-run_trend_analysis-python-script">Statistical Testing for Trend using run_trend_analysis python script</a></li>
  <li><a href="#sec-question1" id="toc-sec-question1" class="nav-link" data-scroll-target="#sec-question1">Question 1</a>
  <ul class="collapse">
  <li><a href="#fitting-tes-and-grid-searching-for-parameters" id="toc-fitting-tes-and-grid-searching-for-parameters" class="nav-link" data-scroll-target="#fitting-tes-and-grid-searching-for-parameters">Fitting TES and grid searching for parameters</a>
  <ul class="collapse">
  <li><a href="#using-additive-seasonality" id="toc-using-additive-seasonality" class="nav-link" data-scroll-target="#using-additive-seasonality">Using Additive Seasonality</a></li>
  <li><a href="#multiplicative-seasonality" id="toc-multiplicative-seasonality" class="nav-link" data-scroll-target="#multiplicative-seasonality">Multiplicative Seasonality</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul></li>
  <li><a href="#part-3.2.2" id="toc-part-3.2.2" class="nav-link" data-scroll-target="#part-3.2.2">Part 3.2.2</a></li>
  <li><a href="#part-3.3-new-strategy-to-improve-the-forecastings" id="toc-part-3.3-new-strategy-to-improve-the-forecastings" class="nav-link" data-scroll-target="#part-3.3-new-strategy-to-improve-the-forecastings">Part 3.3 â€“ New Strategy to improve the forecastings</a>
  <ul class="collapse">
  <li><a href="#understanding-the-dampening-strategy" id="toc-understanding-the-dampening-strategy" class="nav-link" data-scroll-target="#understanding-the-dampening-strategy">Understanding the Dampening Strategy</a></li>
  </ul></li>
  <li><a href="#grid-search-to-find-the-optimal-dampening-factor-that-can-provide-a-bigger-number-of-rebate-months" id="toc-grid-search-to-find-the-optimal-dampening-factor-that-can-provide-a-bigger-number-of-rebate-months" class="nav-link" data-scroll-target="#grid-search-to-find-the-optimal-dampening-factor-that-can-provide-a-bigger-number-of-rebate-months">Grid Search to find the optimal dampening factor that can provide a bigger number of rebate months</a></li>
  <li><a href="#limitations-and-considerations" id="toc-limitations-and-considerations" class="nav-link" data-scroll-target="#limitations-and-considerations">Limitations and Considerations</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="Part2.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Time Series Forecasting: Walmart Sales Analysis Part 2</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Optimized TES model, defining bracket +-X% and recommending different strategy approaches</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Costin-Andrei Taulescu &amp; Panagiotis Valsamis </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 27, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>In the following part of the project, we will use one store from our data with aggregated sales information for all its deparments. The goal is to create a model that will be able to predict as much accurate as possible the sales on the horizon of two weeks. If we are able to predict with high accuracy then we will know the order that needs to be placed in order to satisfy the demand and the main goal is to maximize a rebate laid out in a contract between the store and its supplier.</p>
</section>
<section id="evaluation-metric" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-metric">Evaluation Metric</h2>
<p>The evaluation metric we will use will be the sum of forecasts for every month minus the sum of the actuals divided by the sum of the actuals. The sum will be 4 or 5 weeks depending on the month and if the final percentage is between a range that will be determined later we will get the rebate.</p>
<p><strong>Formula</strong></p>
<p><span class="math display">\[\rho_m = \frac{\sum_i f_i - \sum_i a_i}{\sum_i a_i}\]</span></p>
<p><strong>NOTE</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<pre><code>If pm is +10% on the one week, and -10% on the other week in the end of the month it will cancel out.</code></pre>
</div>
</div>
</section>
<section id="procedure" class="level2">
<h2 class="anchored" data-anchor-id="procedure">Procedure</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>We will use the last 6 weeks of the data as testing data. So we will train the data based on the other weeks. We will use grid search to optimize the TES algorithm and find the best possible model that can perform good in two week horizons.</p></li>
<li><p>Based on the optimized model we found before we will retrain the whole dataset and will calculate each month performance of the last whole year, we will calculate the X% range, in which just the 6/12 months of the last year will be in that range. If we are able to predict the sales in that range we will get the rebate. After this, we will try to define a strategy that can be performed in order to include more of these months in the range and maximize the chances of getting the rebate. This strategy might not be statistically proved, but it might be more intuitive based on the data that we have. For example, one intuition might be if our model overperforms in the first two weeks of the month and underperforms in the last two weeks of the month, we might want to adjust our forecast for the last two weeks based on the error that we had in the first two weeks(like to reduce a percentage on every first two weeks and add a percentage of every two last weeks on each month).</p></li>
</ul>
</div>
</div>
<hr>
</section>
<section id="setup-and-imports" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-imports">Setup and Imports</h2>
<div id="912a228a" class="cell" data-execution_count="1">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> locale</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>locale.setlocale(locale.LC_TIME, <span class="st">"English_United States.1252"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>, <span class="dv">6</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-1-importing-and-visualizing-the-data-of-store-2" class="level2">
<h2 class="anchored" data-anchor-id="step-1-importing-and-visualizing-the-data-of-store-2">Step 1: Importing and Visualizing the Data of Store 2</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>As we also used on the first part of the project, we will use the store 2 data(just to have some different data exploration from part 1), after aggregated for all its departments. We will visualize the aggregated time series in order to see its main characteristics. We expect clear seasonality and not trend on the data(based on our findings from part 1).</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Data Preprocessing:</strong></p>
<ul>
<li>Leave last 6 weeks out</li>
<li>Remove negative values</li>
<li>Aggregate sales for all departments</li>
</ul>
</div>
</div>
<div id="0aa66313" class="cell" data-execution_count="2">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_and_prepare_data(filepath, store_id<span class="op">=</span><span class="dv">2</span>, test_weeks<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Load Walmart data and prepare it for a specific store.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    filepath : str, path to the CSV file</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    store_id : int, store ID to extract</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    test_weeks : int, number of weeks to reserve for testing</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame, training data</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    test_df : DataFrame, testing data</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    df_full : DataFrame, complete data for reference</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"STEP 2: LOADING DATA FOR STORE </span><span class="sc">{</span>store_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for specific store</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">'Store'</span>] <span class="op">==</span> store_id].copy()</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert Date to datetime</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>])</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">'Date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle negative sales</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"Weekly_Sales"</span>] <span class="op">=</span> df[<span class="st">"Weekly_Sales"</span>].where(df[<span class="st">"Weekly_Sales"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to store level (sum across all departments)</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    df_store <span class="op">=</span> df.groupby(<span class="st">'Date'</span>).agg({</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Weekly_Sales'</span>: <span class="st">'sum'</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'IsHoliday'</span>: <span class="st">'first'</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add time features</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Year'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.year</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Month'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.month</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Week'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.isocalendar().week</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" Data loaded successfully!"</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_store)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  First day of week: </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split into train and test</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    split_point <span class="op">=</span> <span class="bu">len</span>(df_store) <span class="op">-</span> test_weeks</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    train_df <span class="op">=</span> df_store.iloc[:split_point].copy()</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    test_df <span class="op">=</span> df_store.iloc[split_point:].copy()</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Data split:"</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training: </span><span class="sc">{</span><span class="bu">len</span>(train_df)<span class="sc">}</span><span class="ss"> weeks (</span><span class="sc">{</span>train_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>train_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Testing:  </span><span class="sc">{</span><span class="bu">len</span>(test_df)<span class="sc">}</span><span class="ss"> weeks (</span><span class="sc">{</span>test_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>test_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic statistics</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Training data statistics:"</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean:   </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span>mean()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Std:    </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span>std()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Min:    </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Max:    </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_df, test_df, df_store</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>train_df,test_df,df_store <span class="op">=</span> load_and_prepare_data(<span class="st">"../data/train.csv"</span>, store_id<span class="op">=</span><span class="dv">2</span>, test_weeks<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
STEP 2: LOADING DATA FOR STORE 2
============================================================
 Data loaded successfully!
  Date range: 2010-02-05 00:00:00 to 2012-10-26 00:00:00
  Total weeks: 143
  First day of week: Friday

 Data split:
  Training: 137 weeks (2010-02-05 00:00:00 to 2012-09-14 00:00:00)
  Testing:  6 weeks (2012-09-21 00:00:00 to 2012-10-26 00:00:00)

 Training data statistics:
  Mean:   1,928,684.34
  Std:    241,920.08
  Min:    1,650,394.44
  Max:    3,436,154.68</code></pre>
</div>
</div>
<div id="eba56649" class="cell" data-execution_count="3">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_training_data(train_df):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create comprehensive visualizations of training data for Jupyter notebook.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with columns ['Date', 'Weekly_Sales', 'Month', 'Year']</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VISUALIZING TRAINING DATA"</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with subplots</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">2</span>, hspace<span class="op">=</span><span class="fl">0.3</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Complete time series</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    ax1.plot(train_df[<span class="st">'Date'</span>], train_df[<span class="st">'Weekly_Sales'</span>], </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, markersize<span class="op">=</span><span class="dv">4</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">'Complete Time Series - Training Data'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">3</span>))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m'</span>))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax1.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add mean line</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    mean_sales <span class="op">=</span> train_df[<span class="st">'Weekly_Sales'</span>].mean()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(mean_sales, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="ss">f'Mean: $</span><span class="sc">{</span>mean_sales<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Sales by Month (Boxplot)</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    month_order <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>))</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    month_names <span class="op">=</span> [<span class="st">'Jan'</span>, <span class="st">'Feb'</span>, <span class="st">'Mar'</span>, <span class="st">'Apr'</span>, <span class="st">'May'</span>, <span class="st">'Jun'</span>, </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'Jul'</span>, <span class="st">'Aug'</span>, <span class="st">'Sep'</span>, <span class="st">'Oct'</span>, <span class="st">'Nov'</span>, <span class="st">'Dec'</span>]</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    box_data <span class="op">=</span> [train_df[train_df[<span class="st">'Month'</span>] <span class="op">==</span> m][<span class="st">'Weekly_Sales'</span>].values </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> m <span class="kw">in</span> month_order]</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    bp <span class="op">=</span> ax2.boxplot(box_data, labels<span class="op">=</span>month_names, patch_artist<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                     boxprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'lightblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                     medianprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>                     whiskerprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'gray'</span>),</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>                     capprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'gray'</span>))</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Sales Distribution by Month'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Month'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax2.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight holiday months</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, month <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="dv">11</span>, <span class="dv">12</span>], start<span class="op">=</span><span class="dv">10</span>):  <span class="co"># Nov=10, Dec=11 (0-indexed)</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        bp[<span class="st">'boxes'</span>][i].set_facecolor(<span class="st">'coral'</span>)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        bp[<span class="st">'boxes'</span>][i].set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Average Sales by Month (Bar Chart)</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    monthly_avg <span class="op">=</span> train_df.groupby(<span class="st">'Month'</span>)[<span class="st">'Weekly_Sales'</span>].mean().reindex(month_order)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'coral'</span> <span class="cf">if</span> m <span class="kw">in</span> [<span class="dv">11</span>, <span class="dv">12</span>] <span class="cf">else</span> <span class="st">'steelblue'</span> <span class="cf">for</span> m <span class="kw">in</span> month_order]</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax3.bar(month_names, monthly_avg.values, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Average Sales by Month'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'Month'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Average Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax3.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels on bars</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> bar.get_height()</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>        ax3.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'$</span><span class="sc">{</span>height<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss">M'</span>,</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Yearly Comparison</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">sorted</span>(train_df[<span class="st">'Year'</span>].unique()):</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        year_data <span class="op">=</span> train_df[train_df[<span class="st">'Year'</span>] <span class="op">==</span> year].copy()</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        year_data <span class="op">=</span> year_data.sort_values(<span class="st">'Date'</span>)</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create week of year</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        year_data[<span class="st">'WeekOfYear'</span>] <span class="op">=</span> year_data[<span class="st">'Date'</span>].dt.isocalendar().week</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        ax4.plot(year_data[<span class="st">'WeekOfYear'</span>], year_data[<span class="st">'Weekly_Sales'</span>], </span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>                <span class="st">'o-'</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">4</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Sales by Week of Year (Yearly Comparison)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>    ax4.set_xlabel(<span class="st">'Week of Year'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    ax4.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Sales Statistics Table</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    ax5.axis(<span class="st">'off'</span>)</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate statistics</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    stats_data <span class="op">=</span> []</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Overall Statistics'</span>, <span class="st">''</span>])</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Mean'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Median'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>median()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Std Dev'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>std()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Min'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Max'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">''</span>, <span class="st">''</span>])</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'By Year'</span>, <span class="st">''</span>])</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">sorted</span>(train_df[<span class="st">'Year'</span>].unique()):</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>        year_data <span class="op">=</span> train_df[train_df[<span class="st">'Year'</span>] <span class="op">==</span> year]</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>        stats_data.append([<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> Mean'</span>, <span class="ss">f'$</span><span class="sc">{</span>year_data[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">''</span>, <span class="st">''</span>])</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Seasonality'</span>, <span class="st">''</span>])</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Nov-Dec Avg'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[train_df[<span class="st">"Month"</span>].isin([<span class="dv">11</span>,<span class="dv">12</span>])][<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Other Months Avg'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="op">~</span>train_df[<span class="st">"Month"</span>].isin([<span class="dv">11</span>,<span class="dv">12</span>])][<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax5.table(cellText<span class="op">=</span>stats_data, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style the table</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(stats_data)):</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>        cell <span class="op">=</span> table[(i, <span class="dv">0</span>)]</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stats_data[i][<span class="dv">0</span>] <span class="kw">in</span> [<span class="st">'Overall Statistics'</span>, <span class="st">'By Year'</span>, <span class="st">'Seasonality'</span>]:</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>            cell.set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>            cell.set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>            cell.set_facecolor(<span class="st">'#E7E6E6'</span> <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'white'</span>)</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>    ax5.set_title(<span class="st">'Summary Statistics'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="ss">f'Training Data Analysis (</span><span class="sc">{</span>train_df[<span class="st">"Date"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>train_df[<span class="st">"Date"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)<span class="sc">}</span><span class="ss">)'</span>,</span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Visualization complete!"</span>)</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_monthly_breakdown(train_df):</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a><span class="co">    Create individual plots for each month across all years.</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with training data</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CREATING MONTHLY BREAKDOWN"</span>)</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with 12 subplots (one per month)</span></span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">16</span>))</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.flatten()</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>    month_names <span class="op">=</span> [<span class="st">'January'</span>, <span class="st">'February'</span>, <span class="st">'March'</span>, <span class="st">'April'</span>, <span class="st">'May'</span>, <span class="st">'June'</span>,</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'July'</span>, <span class="st">'August'</span>, <span class="st">'September'</span>, <span class="st">'October'</span>, <span class="st">'November'</span>, <span class="st">'December'</span>]</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month_num, (ax, month_name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes, month_names), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>        month_data <span class="op">=</span> train_df[train_df[<span class="st">'Month'</span>] <span class="op">==</span> month_num].copy()</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(month_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Group by year for this month</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">sorted</span>(month_data[<span class="st">'Year'</span>].unique()):</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>                year_month_data <span class="op">=</span> month_data[month_data[<span class="st">'Year'</span>] <span class="op">==</span> year].sort_values(<span class="st">'Date'</span>)</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Use day of month for x-axis</span></span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>                year_month_data[<span class="st">'Day'</span>] <span class="op">=</span> year_month_data[<span class="st">'Date'</span>].dt.day</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>                ax.plot(year_month_data[<span class="st">'Day'</span>], year_month_data[<span class="st">'Weekly_Sales'</span>],</span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'o-'</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>            ax.set_title(month_name, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>            ax.set_xlabel(<span class="st">'Day of Month'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>            ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>            ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>            ax.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format y-axis</span></span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>            ax.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'$</span><span class="sc">{</span>x<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.1f}</span><span class="ss">M'</span>))</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Highlight if holiday month</span></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> month_num <span class="kw">in</span> [<span class="dv">11</span>, <span class="dv">12</span>]:</span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>                ax.set_facecolor(<span class="st">'#fff4e6'</span>)</span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">'No Data'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>                   transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>            ax.set_xticks([])</span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>            ax.set_yticks([])</span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="ss">f'Monthly Sales Breakdown - All Years'</span>, </span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Monthly breakdown complete!"</span>)</span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>visualize_training_data(train_df)</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>plot_monthly_breakdown(train_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
VISUALIZING TRAINING DATA
============================================================</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-4-output-2.png" width="1414" height="1079" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Visualization complete!

============================================================
CREATING MONTHLY BREAKDOWN
============================================================</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-4-output-4.png" width="1717" height="1533" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Monthly breakdown complete!</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Notes:</strong></p>
<ul>
<li>Based on the first image, with the whole time series (and more with the time series grouping by year) help us to undestand that there seems to be clear seasonality on the data, with peaks around the end of each year and lower sales on the middle of the year. There is no clear trend on the data, so we will not need to difference the data for trend removal(however we will test it with the same statistical models we used on part 1, to be sure that our first impression is correct).</li>
<li>The second image, provide us with a zoomed in version of the months of data(with grouping by year as well), where we can see more clearly the seasonality in every month seperately.</li>
<li>The table on the first plot, provide us with the main statistics of the data, where we can see that the mean is higher than the median, so there is some positive skewness on the data, which is also visible on the histogram plot.</li>
<li>November and December seems to be the months with the highest sales, while January seems to be the month with the lowest sales.</li>
<li>Based on the mean of each year, we can <strong>not</strong> claim that there is a decreasing trend</li>
<li>It is worth mentioning to take into consideration the last week of November in every year, where there is a clear peak in sales, which is probably due to Black Friday sales.</li>
<li>There is clear peak in December, probably due to Christmas sales.</li>
<li>It is worth mentioning that in every month except November, the last week of the month seems to have lower sales than the other weeks of the month.</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="statistical-testing-for-trend-using-run_trend_analysis-python-script" class="level2">
<h2 class="anchored" data-anchor-id="statistical-testing-for-trend-using-run_trend_analysis-python-script">Statistical Testing for Trend using run_trend_analysis python script</h2>
<div id="8ed45217" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> run_trend_analysis <span class="im">import</span> analyze_series</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass only the Weekly_Sales column, not the entire DataFrame</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>analyze_series(train_df[<span class="st">'Weekly_Sales'</span>], series_name<span class="op">=</span><span class="st">"Store 1 Training Data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
######################################################################
COMPREHENSIVE TREND ANALYSIS FOR: Store 1 Training Data
######################################################################

Data points: 137
Mean: 1928684.34
Std Dev: 241035.54
Min: 1650394.44
Max: 3436154.68

======================================================================
1. MANN-KENDALL TEST (Non-parametric)
======================================================================
Trend: no trend
Test Statistic (S): -634.0
p-value: 0.238837
Tau (correlation): -0.068055
z-score: -1.177899

 RESULT: No significant trend (p &gt;= 0.05)

======================================================================
2. AUGMENTED DICKEY-FULLER (ADF) TEST
======================================================================
ADF Statistic: -3.632909
p-value: 0.005162
Lags used: 6
Number of observations: 130

Critical Values:
  1%: -3.482
  5%: -2.884
  10%: -2.579

 RESULT: Series is stationary (p &lt; 0.05)
   No unit root â†’ Suggests NO trend

======================================================================
3. KPSS TEST (Kwiatkowski-Phillips-Schmidt-Shin)
======================================================================
KPSS Test (with trend):
KPSS Statistic: 0.053766
p-value: 0.100000
Lags used: 4

Critical Values:
  10%: 0.119
  5%: 0.146
  2.5%: 0.176
  1%: 0.216

 RESULT: Series is trend stationary (p &gt;= 0.05)
   Null hypothesis not rejected â†’ NO significant trend

======================================================================
4. LINEAR REGRESSION TEST
======================================================================
Slope: -328.489395
Intercept: 1951021.62
R-squared: 0.002905
p-value: 0.531634
Standard Error: 523.798359

95% Confidence Interval for slope: [-1364.401365, 707.422575]

 RESULT: No significant linear trend (p &gt;= 0.05)

======================================================================
5. COX-STUART TEST (Non-parametric)
======================================================================
Number of pairs: 68
Plus signs (+): 31 (second half &gt; first half)
Minus signs (-): 37 (second half &lt; first half)
Ties: 0
p-value: 0.544612

 RESULT: No significant trend (p &gt;= 0.05)

======================================================================
6. SPEARMAN'S RANK CORRELATION TEST (Bonus)
======================================================================
Spearman's rho: -0.086681
p-value: 0.313849

 RESULT: No significant monotonic trend (p &gt;= 0.05)

======================================================================
SUMMARY OF RESULTS
======================================================================

Trend Detection Tests:
  Mann-Kendall: no trend (p=0.2388)
  Linear Regression: No Trend (p=0.5316)
  Cox-Stuart: No Trend (p=0.5446)
  Spearman: No Trend (p=0.3138)

Stationarity Tests:
  ADF: Stationary (p=0.0052)
  KPSS: Trend Stationary (p=0.1000)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>{'mann_kendall': Mann_Kendall_Test(trend='no trend', h=np.False_, p=np.float64(0.2388367980146735), z=np.float64(-1.177899190096128), Tau=np.float64(-0.06805495920996135), s=np.float64(-634.0), var_s=288796.0, slope=np.float64(-334.9469135802478), intercept=np.float64(1903528.750123457)),
 'adf': (np.float64(-3.632908538595409),
  np.float64(0.005162172372729846),
  6,
  130,
  {'1%': np.float64(-3.4816817173418295),
   '5%': np.float64(-2.8840418343195267),
   '10%': np.float64(-2.578770059171598)},
  np.float64(3379.2610933517135)),
 'kpss': (np.float64(0.05376614062759631),
  np.float64(0.1),
  4,
  {'10%': 0.119, '5%': 0.146, '2.5%': 0.176, '1%': 0.216}),
 'linear_regression': {'slope': np.float64(-328.4893946832941),
  'intercept': np.float64(1951021.6170866392),
  'p_value': np.float64(0.5316335569158772),
  'r_squared': np.float64(0.0029048070660622066),
  'std_err': np.float64(523.7983592507323)},
 'cox_stuart': {'plus': np.int64(31),
  'minus': np.int64(37),
  'p_value': np.float64(0.5446122234192592)},
 'spearman': {'rho': np.float64(-0.08668116564302648),
  'p_value': np.float64(0.3138492333843639)}}</code></pre>
</div>
</div>
<p><strong>Statistical Test Results:</strong></p>
<ul>
<li>6 different trend tests performed (ADF, KPSS, Mann-Kendall, Linear Regression, Cox-Stuart, Spearman)</li>
<li><strong>Conclusion</strong>: No significant trend detected (p-values indicate stationarity)</li>
<li><strong>Implication</strong>: We set Î²=0 in our Holt-Winters model</li>
<li><strong>Justification</strong>: Data shows strong seasonality but no systematic growth/decline over time</li>
</ul>
<hr>
</section>
<section id="sec-question1" class="level1">
<h1>Question 1</h1>
<section id="fitting-tes-and-grid-searching-for-parameters" class="level2">
<h2 class="anchored" data-anchor-id="fitting-tes-and-grid-searching-for-parameters">Fitting TES and grid searching for parameters</h2>
<section id="using-additive-seasonality" class="level3">
<h3 class="anchored" data-anchor-id="using-additive-seasonality">Using Additive Seasonality</h3>
<div id="379d2944" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OPTIMIZE PARAMETERS AND GENERATE HORIZON-2 FORECASTS</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Same as in part1</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> TSE(y_true,y_pred):</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>((y_true <span class="op">-</span> y_pred)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hw_seasonal_no_trend(y,alpha,gamma,m):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Holt-Winters Seasonal Method without Trend</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    y: time series data</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha: level smoothing parameter</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma: seasonal smoothing parameter</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">    m:season length</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span><span class="bu">len</span>(y)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialization</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    level <span class="op">=</span> np.mean(y[:m])  <span class="co"># Mean of first seasonal cycle</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    seasonals <span class="op">=</span> <span class="bu">list</span>(y[:m] <span class="op">-</span> level)  <span class="co"># Seasonal components for first cycle</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    fitted <span class="op">=</span> [np.nan]<span class="op">*</span>n</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(m,n):</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        fitted[t] <span class="op">=</span> level <span class="op">+</span> seasonals[t <span class="op">-</span>  m]</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        new_level <span class="op">=</span> alpha <span class="op">*</span> (y[t] <span class="op">-</span> seasonals[t <span class="op">-</span> m]) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> level</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        new_seasonal <span class="op">=</span> gamma <span class="op">*</span> (y[t] <span class="op">-</span> new_level) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> gamma) <span class="op">*</span> seasonals[t <span class="op">-</span> m]</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        level <span class="op">=</span> new_level</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        seasonals.append(new_seasonal)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(fitted), level, seasonals</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_hw_additive(train_df, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Optimize Holt-Winters ADDITIVE model (no trend) for Part 2.</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses your existing hw_seasonal_no_trend function.</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma)</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co">    best_model : tuple (level, seasonals)</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="co">    best_tse : float</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMIZING HOLT-WINTERS (ADDITIVE, NO TREND)"</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> train_df[<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define parameter ranges</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    alphas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    gammas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    best_tse <span class="op">=</span> np.inf</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training data: </span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="sc">}</span><span class="ss"> Ã— </span><span class="sc">{</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="op">*</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> combinations..."</span>)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid search</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gamma <span class="kw">in</span> gammas:</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>                fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend(y_train, alpha, gamma, m)</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate TSE on valid data</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>                valid_idx <span class="op">=</span> <span class="op">~</span>np.isnan(fitted)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>                tse <span class="op">=</span> TSE(y_train[valid_idx], fitted[valid_idx])</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> tse <span class="op">&lt;</span> best_tse:</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>                    best_tse <span class="op">=</span> tse</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>                    best_params <span class="op">=</span> (alpha, gamma)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>                    best_model <span class="op">=</span> (level, seasonals)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Optimization complete!"</span>)</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMAL PARAMETERS"</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î± (level):    </span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î³ (seasonal): </span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î² (trend):    0.000 (fixed, no trend)"</span>)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training TSE: </span><span class="sc">{</span>best_tse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training RMSE: </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(best_tse<span class="op">/</span><span class="bu">len</span>(y_train))<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_params, best_model, best_tse</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_horizon2_forecasts_hw(train_df, test_df, best_params, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate HORIZON-2 forecasts for test period using Holt-Winters.</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="co">    This is different from Part 1:</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="co">    - Part 1: horizon-1 (one week ahead)</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="co">    - Part 2: horizon-2 (TWO weeks ahead)</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with training data</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="co">    test_df : DataFrame with test data  </span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma) from optimization</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="co">    season_length : int, 52 for weekly data</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="co">    results_df : DataFrame with Date, Actual, Forecast_H2</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics : dict with MAE, MAPE, RMSE</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GENERATING HORIZON-2 FORECASTS FOR TEST SET"</span>)</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine train and test</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>    full_data <span class="op">=</span> pd.concat([train_df, test_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>    split_point <span class="op">=</span> <span class="bu">len</span>(train_df)</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>    forecasts_h2 <span class="op">=</span> []</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>    actuals <span class="op">=</span> []</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generating horizon-2 forecasts for </span><span class="sc">{</span><span class="bu">len</span>(test_df)<span class="sc">}</span><span class="ss"> test weeks..."</span>)</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(test_df)):</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use data up to current point (including i weeks of test data)</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>        current_data <span class="op">=</span> full_data.iloc[:split_point <span class="op">+</span> i][<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit model</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>        fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend(current_data, alpha_best, gamma_best, m)</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate 2-week ahead forecast</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>        seasonals <span class="op">=</span> np.array(seasonals)</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Horizon-2 forecast (2 weeks ahead)</span></span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>        seasonal_index_h2 <span class="op">=</span> <span class="bu">len</span>(seasonals) <span class="op">-</span> m <span class="op">+</span> <span class="dv">1</span>  <span class="co"># +1 for horizon-2</span></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>        forecast_h2 <span class="op">=</span> level <span class="op">+</span> seasonals[seasonal_index_h2]</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>        forecasts_h2.append(forecast_h2)</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>        actuals.append(test_df.iloc[i][<span class="st">'Weekly_Sales'</span>])</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>        dates.append(test_df.iloc[i][<span class="st">'Date'</span>])</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results dataframe</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Date'</span>: dates,</span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: actuals,</span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: forecasts_h2</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]))</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>    mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]) <span class="op">/</span> results_df[<span class="st">'Actual'</span>])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(np.mean((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAE'</span>: mae,</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAPE'</span>: mape,</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>        <span class="st">'RMSE'</span>: rmse</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Horizon-2 forecasts generated!"</span>)</span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HORIZON-2 FORECAST ACCURACY (TEST SET)"</span>)</span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE:  $</span><span class="sc">{</span>mae<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAPE: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  RMSE: $</span><span class="sc">{</span>rmse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df, metrics</span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_horizon2_results(results_df, best_params):</span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize horizon-2 forecast results.</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Forecasts vs Actuals</span></span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_df[<span class="st">'Date'</span>], results_df[<span class="st">'Actual'</span>], </span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Actual Sales'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'black'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_df[<span class="st">'Date'</span>], results_df[<span class="st">'Forecast_H2'</span>], </span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>             <span class="st">'s--'</span>, label<span class="op">=</span><span class="st">'Horizon-2 Forecasts'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'steelblue'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Horizon-2 Forecasts vs Actuals (Test Period)</span><span class="ch">\n</span><span class="ss">Î±=</span><span class="sc">{</span>alpha_best<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>gamma_best<span class="sc">:.3f}</span><span class="ss">, Î²=0.000 (no trend)'</span>, </span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">11</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax1.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add error bands</span></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(results_df)):</span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>        ax1.plot([results_df[<span class="st">'Date'</span>].iloc[i], results_df[<span class="st">'Date'</span>].iloc[i]], </span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a>                [results_df[<span class="st">'Actual'</span>].iloc[i], results_df[<span class="st">'Forecast_H2'</span>].iloc[i]],</span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>                <span class="st">'r--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: Errors</span></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>    errors <span class="op">=</span> results_df[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> results_df[<span class="st">'Actual'</span>]</span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>    abs_errors <span class="op">=</span> np.<span class="bu">abs</span>(errors)</span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> e <span class="op">&gt;=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> e <span class="kw">in</span> errors]</span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>    ax2.bar(results_df[<span class="st">'Date'</span>], errors, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.6</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, linestyle<span class="op">=</span><span class="st">'-'</span>)</span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Forecast Errors (Forecast - Actual)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Error ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a>    ax2.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax2.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add mean absolute error line</span></span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> np.mean(abs_errors)</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(mae, color<span class="op">=</span><span class="st">'blue'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'MAE = $</span><span class="sc">{</span>mae<span class="sc">:,.0f}</span><span class="ss">'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="op">-</span>mae, color<span class="op">=</span><span class="st">'blue'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a>    ax2.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="multiplicative-seasonality" class="level3">
<h3 class="anchored" data-anchor-id="multiplicative-seasonality">Multiplicative Seasonality</h3>
<div id="772f11a6" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hw_seasonal_no_trend_multiplicative(y, alpha, gamma, m):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Holt-Winters Seasonal Method without Trend - Multiplicative Seasonality</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    y: time series data</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha: level smoothing parameter</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma: seasonal smoothing parameter</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    m: season length</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(y)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialization</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    level <span class="op">=</span> np.mean(y[:m])</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    seasonals <span class="op">=</span> <span class="bu">list</span>(y[:m] <span class="op">/</span> level)  <span class="co"># Multiplicative: divide instead of subtract</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    fitted <span class="op">=</span> [np.nan] <span class="op">*</span> n</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(m, n):</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        fitted[t] <span class="op">=</span> level <span class="op">*</span> seasonals[t <span class="op">-</span> m]  <span class="co"># Multiplicative: multiply instead of add</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update level (deseasonalize by dividing)</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        new_level <span class="op">=</span> alpha <span class="op">*</span> (y[t] <span class="op">/</span> seasonals[t <span class="op">-</span> m]) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> level</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update seasonal component (ratio)</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        new_seasonal <span class="op">=</span> gamma <span class="op">*</span> (y[t] <span class="op">/</span> new_level) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> gamma) <span class="op">*</span> seasonals[t <span class="op">-</span> m]</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        level <span class="op">=</span> new_level</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        seasonals.append(new_seasonal)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(fitted), level, seasonals</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># MULTIPLICATIVE VERSION</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_hw_multiplicative(train_df, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Optimize Holt-Winters MULTIPLICATIVE model (no trend) for Part 2.</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses your existing hw_seasonal_multiplicative_no_trend function.</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma)</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co">    best_model : tuple (level, seasonals)</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co">    best_tse : float</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMIZING HOLT-WINTERS (MULTIPLICATIVE, NO TREND)"</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> train_df[<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define parameter ranges</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    alphas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    gammas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    best_tse <span class="op">=</span> np.inf</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training data: </span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="sc">}</span><span class="ss"> Ã— </span><span class="sc">{</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="op">*</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> combinations..."</span>)</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid search</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gamma <span class="kw">in</span> gammas:</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>                fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend_multiplicative(</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>                    y_train, alpha, gamma, m</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate TSE on valid data</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>                valid_idx <span class="op">=</span> <span class="op">~</span>np.isnan(fitted)</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>                tse <span class="op">=</span> TSE(y_train[valid_idx], fitted[valid_idx])</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> tse <span class="op">&lt;</span> best_tse:</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>                    best_tse <span class="op">=</span> tse</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>                    best_params <span class="op">=</span> (alpha, gamma)</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>                    best_model <span class="op">=</span> (level, seasonals)</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">âœ“ Optimization complete!"</span>)</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMAL PARAMETERS"</span>)</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î± (level):    </span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î³ (seasonal): </span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î² (trend):    0.000 (fixed, no trend)"</span>)</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training TSE: </span><span class="sc">{</span>best_tse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training RMSE: </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(best_tse<span class="op">/</span><span class="bu">len</span>(y_train))<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_params, best_model, best_tse</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_horizon2_forecasts_multiplicative(train_df, test_df, best_params, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate HORIZON-2 forecasts using MULTIPLICATIVE seasonality.</span></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with training data</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a><span class="co">    test_df : DataFrame with test data  </span></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma) from optimization</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a><span class="co">    season_length : int, 52 for weekly data</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a><span class="co">    results_df : DataFrame with Date, Actual, Forecast_H2</span></span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics : dict with MAE, MAPE, RMSE</span></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GENERATING HORIZON-2 FORECASTS (MULTIPLICATIVE)"</span>)</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine train and test</span></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    full_data <span class="op">=</span> pd.concat([train_df, test_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>    split_point <span class="op">=</span> <span class="bu">len</span>(train_df)</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>    forecasts_h2 <span class="op">=</span> []</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>    actuals <span class="op">=</span> []</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generating horizon-2 forecasts for </span><span class="sc">{</span><span class="bu">len</span>(test_df)<span class="sc">}</span><span class="ss"> test weeks..."</span>)</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(test_df)):</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use data up to current point</span></span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>        current_data <span class="op">=</span> full_data.iloc[:split_point <span class="op">+</span> i][<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit model</span></span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>        fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend_multiplicative(</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>            current_data, alpha_best, gamma_best, m</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate 2-week ahead forecast</span></span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>        seasonals <span class="op">=</span> np.array(seasonals)</span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Horizon-2 forecast (2 weeks ahead) - MULTIPLICATIVE</span></span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>        seasonal_index_h2 <span class="op">=</span> <span class="bu">len</span>(seasonals) <span class="op">-</span> m <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>        forecast_h2 <span class="op">=</span> level <span class="op">*</span> seasonals[seasonal_index_h2]  <span class="co"># Multiply instead of add</span></span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>        forecasts_h2.append(forecast_h2)</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>        actuals.append(test_df.iloc[i][<span class="st">'Weekly_Sales'</span>])</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>        dates.append(test_df.iloc[i][<span class="st">'Date'</span>])</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results dataframe</span></span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Date'</span>: dates,</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: actuals,</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: forecasts_h2</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]))</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>    mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]) <span class="op">/</span> results_df[<span class="st">'Actual'</span>])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(np.mean((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAE'</span>: mae,</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAPE'</span>: mape,</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>        <span class="st">'RMSE'</span>: rmse</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Horizon-2 forecasts generated!"</span>)</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HORIZON-2 FORECAST ACCURACY (TEST SET)"</span>)</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE:  $</span><span class="sc">{</span>mae<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAPE: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  RMSE: $</span><span class="sc">{</span>rmse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df, metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="comparison" class="level3">
<h3 class="anchored" data-anchor-id="comparison">Comparison</h3>
<div id="a387e5b5" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># COMPARISON FUNCTION</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_additive_vs_multiplicative(train_df, test_df, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare Additive vs Multiplicative seasonality models.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    comparison_dict : dict with results for both models</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"#"</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"COMPARING ADDITIVE VS MULTIPLICATIVE SEASONALITY"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"#"</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== ADDITIVE MODEL =====</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL 1: ADDITIVE SEASONALITY"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    params_add, model_add, tse_add <span class="op">=</span> optimize_hw_additive(train_df, season_length)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    results_add, metrics_add <span class="op">=</span> generate_horizon2_forecasts_hw(train_df, test_df, params_add, season_length)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== MULTIPLICATIVE MODEL =====</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL 2: MULTIPLICATIVE SEASONALITY"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    params_mult, model_mult, tse_mult <span class="op">=</span> optimize_hw_multiplicative(train_df, season_length)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    results_mult, metrics_mult <span class="op">=</span> generate_horizon2_forecasts_multiplicative(train_df, test_df, params_mult, season_length)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== COMPARISON =====</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL COMPARISON SUMMARY"</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model'</span>: [<span class="st">'Additive'</span>, <span class="st">'Multiplicative'</span>],</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Î± (level)'</span>: [params_add[<span class="dv">0</span>], params_mult[<span class="dv">0</span>]],</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Î³ (seasonal)'</span>: [params_add[<span class="dv">1</span>], params_mult[<span class="dv">1</span>]],</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Train TSE'</span>: [tse_add, tse_mult],</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Train RMSE'</span>: [np.sqrt(tse_add<span class="op">/</span><span class="bu">len</span>(train_df)), np.sqrt(tse_mult<span class="op">/</span><span class="bu">len</span>(train_df))],</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test MAE'</span>: [metrics_add[<span class="st">'MAE'</span>], metrics_mult[<span class="st">'MAE'</span>]],</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test MAPE'</span>: [metrics_add[<span class="st">'MAPE'</span>], metrics_mult[<span class="st">'MAPE'</span>]],</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test RMSE'</span>: [metrics_add[<span class="st">'RMSE'</span>], metrics_mult[<span class="st">'RMSE'</span>]]</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> comparison_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine winner</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> metrics_add[<span class="st">'MAE'</span>] <span class="op">&lt;</span> metrics_mult[<span class="st">'MAE'</span>]:</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        winner <span class="op">=</span> <span class="st">'ADDITIVE'</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>        improvement <span class="op">=</span> ((metrics_mult[<span class="st">'MAE'</span>] <span class="op">-</span> metrics_add[<span class="st">'MAE'</span>]) <span class="op">/</span> metrics_mult[<span class="st">'MAE'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">WINNER: ADDITIVE SEASONALITY"</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   MAE improvement: </span><span class="sc">{</span>improvement<span class="sc">:.2f}</span><span class="ss">% better than multiplicative"</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>        winner <span class="op">=</span> <span class="st">'MULTIPLICATIVE'</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        improvement <span class="op">=</span> ((metrics_add[<span class="st">'MAE'</span>] <span class="op">-</span> metrics_mult[<span class="st">'MAE'</span>]) <span class="op">/</span> metrics_add[<span class="st">'MAE'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">WINNER: MULTIPLICATIVE SEASONALITY"</span>)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   MAE improvement: </span><span class="sc">{</span>improvement<span class="sc">:.2f}</span><span class="ss">% better than additive"</span>)</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'additive'</span>: {</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">'params'</span>: params_add,</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model_add,</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">'results'</span>: results_add,</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">'metrics'</span>: metrics_add</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'multiplicative'</span>: {</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">'params'</span>: params_mult,</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model_mult,</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">'results'</span>: results_mult,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">'metrics'</span>: metrics_mult</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'winner'</span>: winner,</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">'comparison_df'</span>: comparison_df</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_additive_vs_multiplicative(comparison_dict):</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize comparison between additive and multiplicative models.</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    results_add <span class="op">=</span> comparison_dict[<span class="st">'additive'</span>][<span class="st">'results'</span>]</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    results_mult <span class="op">=</span> comparison_dict[<span class="st">'multiplicative'</span>][<span class="st">'results'</span>]</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    params_add <span class="op">=</span> comparison_dict[<span class="st">'additive'</span>][<span class="st">'params'</span>]</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    params_mult <span class="op">=</span> comparison_dict[<span class="st">'multiplicative'</span>][<span class="st">'params'</span>]</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Additive Forecasts</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_add[<span class="st">'Date'</span>], results_add[<span class="st">'Actual'</span>], </span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Actual'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_add[<span class="st">'Date'</span>], results_add[<span class="st">'Forecast_H2'</span>], </span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>             <span class="st">'s--'</span>, label<span class="op">=</span><span class="st">'Forecast'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Additive Model (Î±=</span><span class="sc">{</span>params_add[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>params_add[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">)'</span>, </span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Weekly Sales ($)'</span>)</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>    ax1.legend()</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax1.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: Multiplicative Forecasts</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>    ax2.plot(results_mult[<span class="st">'Date'</span>], results_mult[<span class="st">'Actual'</span>], </span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Actual'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>    ax2.plot(results_mult[<span class="st">'Date'</span>], results_mult[<span class="st">'Forecast_H2'</span>], </span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>             <span class="st">'s--'</span>, label<span class="op">=</span><span class="st">'Forecast'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'coral'</span>)</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f'Multiplicative Model (Î±=</span><span class="sc">{</span>params_mult[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>params_mult[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">)'</span>, </span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Weekly Sales ($)'</span>)</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>    ax2.legend()</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>    ax2.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax2.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Error Comparison</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>    errors_add <span class="op">=</span> np.<span class="bu">abs</span>(results_add[<span class="st">'Actual'</span>] <span class="op">-</span> results_add[<span class="st">'Forecast_H2'</span>])</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>    errors_mult <span class="op">=</span> np.<span class="bu">abs</span>(results_mult[<span class="st">'Actual'</span>] <span class="op">-</span> results_mult[<span class="st">'Forecast_H2'</span>])</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.arange(<span class="bu">len</span>(results_add))</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>    ax3.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, errors_add, width, label<span class="op">=</span><span class="st">'Additive'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    ax3.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, errors_mult, width, label<span class="op">=</span><span class="st">'Multiplicative'</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Absolute Errors Comparison'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'Week Index'</span>)</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Absolute Error ($)'</span>)</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>    ax3.legend()</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Metrics Comparison</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>    metrics_add <span class="op">=</span> comparison_dict[<span class="st">'additive'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>    metrics_mult <span class="op">=</span> comparison_dict[<span class="st">'multiplicative'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>    metrics_names <span class="op">=</span> [<span class="st">'MAE'</span>, <span class="st">'MAPE (%)'</span>, <span class="st">'RMSE'</span>]</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>    additive_vals <span class="op">=</span> [metrics_add[<span class="st">'MAE'</span>], metrics_add[<span class="st">'MAPE'</span>], metrics_add[<span class="st">'RMSE'</span>]]</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    mult_vals <span class="op">=</span> [metrics_mult[<span class="st">'MAE'</span>], metrics_mult[<span class="st">'MAPE'</span>], metrics_mult[<span class="st">'RMSE'</span>]]</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.arange(<span class="bu">len</span>(metrics_names))</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    bars1 <span class="op">=</span> ax4.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, additive_vals, width, label<span class="op">=</span><span class="st">'Additive'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>    bars2 <span class="op">=</span> ax4.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, mult_vals, width, label<span class="op">=</span><span class="st">'Multiplicative'</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Performance Metrics Comparison'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Value'</span>)</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>    ax4.set_xticks(x)</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>    ax4.set_xticklabels(metrics_names)</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>    ax4.legend()</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>    ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels on bars</span></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bars <span class="kw">in</span> [bars1, bars2]:</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> bar.get_height()</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>            ax4.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f'</span><span class="sc">{</span>height<span class="sc">:.0f}</span><span class="ss">'</span>,</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Additive vs Multiplicative Seasonality Comparison'</span>, </span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b6a23567" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN COMPLETE COMPARISON</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare both models</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>comparison_results <span class="op">=</span> compare_additive_vs_multiplicative(train_df, test_df)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize comparison</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>plot_additive_vs_multiplicative(comparison_results)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>winner <span class="op">=</span> comparison_results[<span class="st">'winner'</span>]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Best model: </span><span class="sc">{</span>winner<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the best model's results for Step 2</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> winner <span class="op">==</span> <span class="st">'ADDITIVE'</span>:</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> comparison_results[<span class="st">'additive'</span>][<span class="st">'params'</span>]</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    best_results <span class="op">=</span> comparison_results[<span class="st">'additive'</span>][<span class="st">'results'</span>]</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    best_metrics <span class="op">=</span> comparison_results[<span class="st">'additive'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> comparison_results[<span class="st">'multiplicative'</span>][<span class="st">'params'</span>]</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    best_results <span class="op">=</span> comparison_results[<span class="st">'multiplicative'</span>][<span class="st">'results'</span>]</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    best_metrics <span class="op">=</span> comparison_results[<span class="st">'multiplicative'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Best parameters: Î±=</span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MAE: $</span><span class="sc">{</span>best_metrics[<span class="st">'MAE'</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MAPE: </span><span class="sc">{</span>best_metrics[<span class="st">'MAPE'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
######################################################################
COMPARING ADDITIVE VS MULTIPLICATIVE SEASONALITY
######################################################################

======================================================================
MODEL 1: ADDITIVE SEASONALITY
======================================================================
============================================================
OPTIMIZING HOLT-WINTERS (ADDITIVE, NO TREND)
============================================================

Training data: 137 weeks
Testing 19 Ã— 19 = 361 combinations...

 Optimization complete!

============================================================
OPTIMAL PARAMETERS
============================================================
  Î± (level):    0.150
  Î³ (seasonal): 0.750
  Î² (trend):    0.000 (fixed, no trend)

Training TSE: 567,286,960,444.85
Training RMSE: 64,348.90

============================================================
GENERATING HORIZON-2 FORECASTS FOR TEST SET
============================================================

Generating horizon-2 forecasts for 6 test weeks...

 Horizon-2 forecasts generated!

============================================================
HORIZON-2 FORECAST ACCURACY (TEST SET)
============================================================
  MAE:  $100,628.92
  MAPE: 5.43%
  RMSE: $125,758.93

======================================================================
MODEL 2: MULTIPLICATIVE SEASONALITY
======================================================================
============================================================
OPTIMIZING HOLT-WINTERS (MULTIPLICATIVE, NO TREND)
============================================================

Training data: 137 weeks
Testing 19 Ã— 19 = 361 combinations...

âœ“ Optimization complete!

============================================================
OPTIMAL PARAMETERS
============================================================
  Î± (level):    0.150
  Î³ (seasonal): 0.700
  Î² (trend):    0.000 (fixed, no trend)

Training TSE: 536,670,064,607.86
Training RMSE: 62,588.34

============================================================
GENERATING HORIZON-2 FORECASTS (MULTIPLICATIVE)
============================================================

Generating horizon-2 forecasts for 6 test weeks...

Horizon-2 forecasts generated!

============================================================
HORIZON-2 FORECAST ACCURACY (TEST SET)
============================================================
  MAE:  $102,362.52
  MAPE: 5.53%
  RMSE: $127,490.37

======================================================================
MODEL COMPARISON SUMMARY
======================================================================

         Model  Î± (level)  Î³ (seasonal)    Train TSE   Train RMSE      Test MAE  Test MAPE     Test RMSE
      Additive       0.15          0.75 5.672870e+11 64348.898461 100628.918746   5.433193 125758.933558
Multiplicative       0.15          0.70 5.366701e+11 62588.335508 102362.524037   5.527820 127490.371018

WINNER: ADDITIVE SEASONALITY
   MAE improvement: 1.69% better than multiplicative</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-9-output-2.png" width="1718" height="1151" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best model: ADDITIVE

Best parameters: Î±=0.150, Î³=0.750
Test MAE: $100,628.92
Test MAPE: 5.43%</code></pre>
</div>
</div>
</section>
</section>
<section id="part-3.2.2" class="level2">
<h2 class="anchored" data-anchor-id="part-3.2.2">Part 3.2.2</h2>
<ul>
<li>For this part we reimport the data and preprocess them. We are not splitting them into train and test set since we are only interested in finding the +-X % by using the TES model that we found above.</li>
<li>The same store again as well</li>
<li>We will define the KPI metric, which is needed for further analysis</li>
<li>Based on the last 12 months we will determing the +- X% in which just 6/12 are inside it</li>
</ul>
<div id="9f48825e" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_full_historical_data(filepath, store_id<span class="op">=</span><span class="dv">2</span>): <span class="co"># Same function as before but without splitting</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Load ALL historical data (no test split) for rebate analysis.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    filepath : str, path to CSV file</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    store_id : int, store ID</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">    df_full : DataFrame with all historical data</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"LOADING FULL HISTORICAL DATA FOR STORE </span><span class="sc">{</span>store_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for specific store</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">'Store'</span>] <span class="op">==</span> store_id].copy()</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert Date to datetime</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>])</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">'Date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle negative sales</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"Weekly_Sales"</span>] <span class="op">=</span> df[<span class="st">"Weekly_Sales"</span>].where(df[<span class="st">"Weekly_Sales"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to store level</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    df_store <span class="op">=</span> df.groupby(<span class="st">'Date'</span>).agg({</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Weekly_Sales'</span>: <span class="st">'sum'</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'IsHoliday'</span>: <span class="st">'first'</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add time features</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Year'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.year</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Month'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.month</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Week'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.isocalendar().week</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'YearMonth'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Data loaded!"</span>)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_store)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_store</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="40845c1e" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that uses the first 52 weeks to train and then starting retraining using rolling window</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_all_horizon2_forecasts(df_historical, best_params, season_length<span class="op">=</span><span class="dv">52</span>): </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate horizon-2 forecasts for ALL historical data using rolling window.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    df_historical : DataFrame with all historical data</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma)</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    season_length : int, 52 for weekly data</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df : DataFrame with forecasts for all weeks</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GENERATING HORIZON-2 FORECASTS FOR ALL HISTORICAL DATA"</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    forecasts_h2 <span class="op">=</span> []</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    actuals <span class="op">=</span> []</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generating forecasts using rolling window..."</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_historical)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start from week 52 (need at least one season for initialization)</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and forecast horizon-2 ahead</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(m, <span class="bu">len</span>(df_historical) <span class="op">-</span> <span class="dv">1</span>):  <span class="co"># -1 because we need i+1 to exist</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use all data up to week i</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        current_data <span class="op">=</span> df_historical.iloc[:i][<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit model</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend(current_data, alpha_best, gamma_best, m)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate horizon-2 forecast</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        seasonals <span class="op">=</span> np.array(seasonals)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        seasonal_index_h2 <span class="op">=</span> <span class="bu">len</span>(seasonals) <span class="op">-</span> m <span class="op">+</span> <span class="dv">1</span>  <span class="co"># +1 for horizon-2</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        forecast_h2 <span class="op">=</span> level <span class="op">+</span> seasonals[seasonal_index_h2]</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The forecast is for week i+1 (horizon-2 from perspective of week i-1)</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        forecast_week_index <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> forecast_week_index <span class="op">&lt;</span> <span class="bu">len</span>(df_historical):</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>            forecasts_h2.append(forecast_h2)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            actuals.append(df_historical.iloc[forecast_week_index][<span class="st">'Weekly_Sales'</span>])</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>            dates.append(df_historical.iloc[forecast_week_index][<span class="st">'Date'</span>])</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results dataframe</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    forecast_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Date'</span>: dates,</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: actuals,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: forecasts_h2</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add time features</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'Year'</span>] <span class="op">=</span> forecast_df[<span class="st">'Date'</span>].dt.year</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'Month'</span>] <span class="op">=</span> forecast_df[<span class="st">'Date'</span>].dt.month</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'YearMonth'</span>] <span class="op">=</span> forecast_df[<span class="st">'Date'</span>].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Generated </span><span class="sc">{</span><span class="bu">len</span>(forecast_df)<span class="sc">}</span><span class="ss"> horizon-2 forecasts"</span>)</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>forecast_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>forecast_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> forecast_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="f0347c1d" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_all_monthly_rho(forecast_df):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate monthly Ï for ALL months in the data.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Formula: Ï_m = (Î£ forecasts - Î£ actuals) / Î£ actuals</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df : DataFrame with Date, Actual, Forecast_H2</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_rho_df : DataFrame with monthly Ï values for all months</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CALCULATING MONTHLY Ï FOR ALL HISTORICAL MONTHS"</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by month and calculate sums</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> forecast_df.groupby(<span class="st">'YearMonth'</span>).agg({</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: <span class="st">'sum'</span>,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: <span class="st">'sum'</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Ï for each month</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho'</span>] <span class="op">=</span> (monthly_stats[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> monthly_stats[<span class="st">'Actual'</span>]) <span class="op">/</span> monthly_stats[<span class="st">'Actual'</span>]</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_pct'</span>] <span class="op">=</span> monthly_stats[<span class="st">'rho'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count weeks per month</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    weeks_per_month <span class="op">=</span> forecast_df.groupby(<span class="st">'YearMonth'</span>).size().reset_index(name<span class="op">=</span><span class="st">'num_weeks'</span>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> monthly_stats.merge(weeks_per_month, on<span class="op">=</span><span class="st">'YearMonth'</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Calculated Ï for </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats)<span class="sc">}</span><span class="ss"> total months"</span>)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>monthly_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>monthly_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="b96a7451" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> determine_bracket_from_last_12_months(monthly_stats_all):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Determine Â±X% bracket using ONLY the last 12 months, where 6/12 qualify.</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_all : DataFrame with monthly Ï for ALL months</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float, the bracket percentage</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">    last_12_stats : DataFrame, stats for last 12 months</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_all : DataFrame, all months with qualification flag</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"DETERMINING BRACKET BASED ON LAST 12 MONTHS"</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the last 12 months</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    last_12_stats <span class="op">=</span> monthly_stats_all.tail(<span class="dv">12</span>).copy()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total months in data: </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Using last 12 months for bracket determination:"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  From: </span><span class="sc">{</span>last_12_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  To:   </span><span class="sc">{</span>last_12_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display last 12 months</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LAST 12 MONTHS (used for determining bracket):"</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    display_df <span class="op">=</span> last_12_stats[[<span class="st">'YearMonth'</span>, <span class="st">'Actual'</span>, <span class="st">'Forecast_H2'</span>, <span class="st">'rho_pct'</span>, <span class="st">'num_weeks'</span>]].copy()</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'YearMonth'</span>] <span class="op">=</span> display_df[<span class="st">'YearMonth'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'Actual'</span>] <span class="op">=</span> display_df[<span class="st">'Actual'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'$</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'Forecast_H2'</span>] <span class="op">=</span> display_df[<span class="st">'Forecast_H2'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'$</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'rho_pct'</span>] <span class="op">=</span> display_df[<span class="st">'rho_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(display_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by absolute value of Ï (for last 12 months only)</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    sorted_rho_abs <span class="op">=</span> np.sort(last_12_stats[<span class="st">'rho_pct'</span>].<span class="bu">abs</span>().values)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the 6th smallest absolute Ï (index 5)</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This means exactly 6 months will be inside the bracket</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sorted_rho_abs[<span class="dv">5</span>]</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"REBATE BRACKET: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"(Determined from last 12 months where 6/12 qualify)"</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply this bracket to ALL months</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    monthly_stats_all[<span class="st">'qualifies'</span>] <span class="op">=</span> monthly_stats_all[<span class="st">'rho_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    last_12_stats[<span class="st">'qualifies'</span>] <span class="op">=</span> last_12_stats[<span class="st">'rho_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show results for last 12 months</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    qualifying_last_12 <span class="op">=</span> last_12_stats[last_12_stats[<span class="st">'qualifies'</span>]].copy()</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    non_qualifying_last_12 <span class="op">=</span> last_12_stats[<span class="op">~</span>last_12_stats[<span class="st">'qualifies'</span>]].copy()</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">LAST 12 MONTHS - Months that QUALIFY (|Ï| â‰¤ </span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%):"</span>)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    qual_display <span class="op">=</span> qualifying_last_12[[<span class="st">'YearMonth'</span>, <span class="st">'rho_pct'</span>, <span class="st">'num_weeks'</span>]].copy()</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    qual_display[<span class="st">'YearMonth'</span>] <span class="op">=</span> qual_display[<span class="st">'YearMonth'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    qual_display[<span class="st">'rho_pct'</span>] <span class="op">=</span> qual_display[<span class="st">'rho_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>)</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(qual_display.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">LAST 12 MONTHS - Months that DO NOT qualify (|Ï| &gt; </span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%):"</span>)</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    non_qual_display <span class="op">=</span> non_qualifying_last_12[[<span class="st">'YearMonth'</span>, <span class="st">'rho_pct'</span>, <span class="st">'num_weeks'</span>]].copy()</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    non_qual_display[<span class="st">'YearMonth'</span>] <span class="op">=</span> non_qual_display[<span class="st">'YearMonth'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>    non_qual_display[<span class="st">'rho_pct'</span>] <span class="op">=</span> non_qual_display[<span class="st">'rho_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>)</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(non_qual_display.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show statistics for last 12 months</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STATISTICS (LAST 12 MONTHS)"</span>)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Qualifying months: </span><span class="sc">{</span><span class="bu">len</span>(qualifying_last_12)<span class="sc">}</span><span class="ss">/12 (</span><span class="sc">{</span><span class="bu">len</span>(qualifying_last_12)<span class="op">/</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%)"</span>)</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Ï:   </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Median Ï: </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span>median()<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Std Dev:  </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Range:    [</span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">%, </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">%]"</span>)</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show how this bracket applies to ALL historical data</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>    total_qualifying <span class="op">=</span> monthly_stats_all[<span class="st">'qualifies'</span>].<span class="bu">sum</span>()</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"BRACKET APPLIED TO ALL HISTORICAL DATA"</span>)</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total months: </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Qualifying months: </span><span class="sc">{</span>total_qualifying<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>total_qualifying<span class="op">/</span><span class="bu">len</span>(monthly_stats_all)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, last_12_stats, monthly_stats_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="3a7f8c69" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_bracket_analysis(monthly_stats_all, last_12_stats, X):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize the rebate bracket analysis.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows both: last 12 months (used for bracket) and all historical data.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">14</span>))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">2</span>, hspace<span class="op">=</span><span class="fl">0.3</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Last 12 months bar chart (MAIN PLOT)</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    month_labels <span class="op">=</span> [<span class="bu">str</span>(m) <span class="cf">for</span> m <span class="kw">in</span> last_12_stats[<span class="st">'YearMonth'</span>]]</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> q <span class="kw">in</span> last_12_stats[<span class="st">'qualifies'</span>]]</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax1.bar(<span class="bu">range</span>(<span class="bu">len</span>(last_12_stats)), last_12_stats[<span class="st">'rho_pct'</span>], </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="ss">f'Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(last_12_stats)))</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticklabels(month_labels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Month (Last 12 Months)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Rebate KPI for Last 12 Months (Used to Determine Bracket)</span><span class="ch">\n</span><span class="ss">6/12 Months Qualify with Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>, </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">12</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (bar, val) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(bars, last_12_stats[<span class="st">'rho_pct'</span>])):</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> bar.get_height()</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        ax1.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:+.1f}</span><span class="ss">%'</span>,</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span> <span class="cf">if</span> height <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'top'</span>, </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: All historical months</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, :])</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    all_colors <span class="op">=</span> [<span class="st">'lightgreen'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'lightcoral'</span> <span class="cf">for</span> q <span class="kw">in</span> monthly_stats_all[<span class="st">'qualifies'</span>]]</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    ax2.bar(<span class="bu">range</span>(<span class="bu">len</span>(monthly_stats_all)), monthly_stats_all[<span class="st">'rho_pct'</span>], </span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>all_colors, alpha<span class="op">=</span><span class="fl">0.6</span>, edgecolor<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight last 12 months region</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    ax2.axvspan(<span class="bu">len</span>(monthly_stats_all)<span class="op">-</span><span class="dv">12</span>, <span class="bu">len</span>(monthly_stats_all), </span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'yellow'</span>, label<span class="op">=</span><span class="st">'Last 12 months (bracket basis)'</span>)</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Month Index (All Historical Data)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f'All Historical Months with Bracket Applied</span><span class="ch">\n</span><span class="sc">{</span>monthly_stats_all[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> Total Months Qualify'</span>, </span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    ax2.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Histogram - Last 12 months</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>    ax3.hist(last_12_stats[<span class="st">'rho_pct'</span>], bins<span class="op">=</span><span class="dv">8</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>    ax3.axvline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>    ax3.axvline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>    ax3.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Perfect'</span>)</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Distribution (Last 12 Months)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>    ax3.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Summary statistics</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>    ax4.axis(<span class="st">'off'</span>)</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>    stats_text <span class="op">=</span> [</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Metric'</span>, <span class="st">'Last 12M'</span>, <span class="st">'All History'</span>],</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'â”€'</span><span class="op">*</span><span class="dv">20</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>],</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Total Months'</span>, <span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(last_12_stats)<span class="sc">}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Qualifying'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Success Rate'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>, </span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(monthly_stats_all)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>],</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Bracket'</span>, <span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>, <span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>],</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Mean Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>, </span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Median Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span>median()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span>median()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Std Dev'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>],</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Min Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Max Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax4.table(cellText<span class="op">=</span>stats_text, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style header</span></span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Summary Statistics'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Rebate Bracket Analysis: Bracket Set by Last 12 Months (6/12 Rule)'</span>, </span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="469bc354" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.2: DETERMINE REBATE BRACKET</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load FULL historical data (no test split)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>df_historical <span class="op">=</span> load_full_historical_data(<span class="st">"../data/train.csv"</span>, store_id<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use best parameters from Step 3.1</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>best_params <span class="op">=</span> (<span class="fl">0.150</span>, <span class="fl">0.750</span>)  <span class="co"># Î±=0.150, Î³=0.750 (Additive winner)</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate horizon-2 forecasts for ALL historical data</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>forecast_all <span class="op">=</span> generate_all_horizon2_forecasts(df_historical, best_params)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly Ï for ALL months</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>monthly_stats_all <span class="op">=</span> calculate_all_monthly_rho(forecast_all)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine bracket using LAST 12 MONTHS (6/12 rule)</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>X, last_12_stats, monthly_stats_with_bracket <span class="op">=</span> determine_bracket_from_last_12_months(monthly_stats_all)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>visualize_bracket_analysis(monthly_stats_with_bracket, last_12_stats, X)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"STEP 3.2 COMPLETE!"</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rebate Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Determined by: Last 12 months (6/12 qualify)"</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Applied to: All </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> historical months"</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Result: </span><span class="sc">{</span>monthly_stats_with_bracket[<span class="st">'qualifies'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> months qualify overall"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>============================================================
LOADING FULL HISTORICAL DATA FOR STORE 2
============================================================

 Data loaded!
  Date range: 2010-02-05 00:00:00 to 2012-10-26 00:00:00
  Total weeks: 143

============================================================
GENERATING HORIZON-2 FORECASTS FOR ALL HISTORICAL DATA
============================================================

Generating forecasts using rolling window...
Total weeks: 143

 Generated 90 horizon-2 forecasts
  Date range: 2011-02-11 00:00:00 to 2012-10-26 00:00:00

============================================================
CALCULATING MONTHLY Ï FOR ALL HISTORICAL MONTHS
============================================================

 Calculated Ï for 21 total months
  Date range: 2011-02 to 2012-10

============================================================
DETERMINING BRACKET BASED ON LAST 12 MONTHS
============================================================

Total months in data: 21
Using last 12 months for bracket determination:
  From: 2011-11
  To:   2012-10

--------------------------------------------------------------------------------
LAST 12 MONTHS (used for determining bracket):
--------------------------------------------------------------------------------
YearMonth      Actual Forecast_H2 rho_pct  num_weeks
  2011-11  $8,397,398  $8,291,590  -1.26%          4
  2011-12 $11,776,945 $11,956,622  +1.53%          5
  2012-01  $6,916,921  $6,723,460  -2.80%          4
  2012-02  $8,097,118  $7,992,937  -1.29%          4
  2012-03  $9,514,186  $9,467,878  -0.49%          5
  2012-04  $7,676,415  $7,538,583  -1.80%          4
  2012-05  $7,755,210  $7,562,350  -2.49%          4
  2012-06  $9,652,044 $10,058,780  +4.21%          5
  2012-07  $7,449,204  $7,335,182  -1.53%          4
  2012-08  $9,564,712  $9,551,045  -0.14%          5
  2012-09  $7,289,470  $7,121,551  -2.30%          4
  2012-10  $7,581,515  $7,475,334  -1.40%          4

============================================================
REBATE BRACKET: Â±1.53%
(Determined from last 12 months where 6/12 qualify)
============================================================

LAST 12 MONTHS - Months that QUALIFY (|Ï| â‰¤ 1.53%):
--------------------------------------------------------------------------------
YearMonth rho_pct  num_weeks
  2011-11  -1.26%          4
  2011-12  +1.53%          5
  2012-02  -1.29%          4
  2012-03  -0.49%          5
  2012-08  -0.14%          5
  2012-10  -1.40%          4

LAST 12 MONTHS - Months that DO NOT qualify (|Ï| &gt; 1.53%):
--------------------------------------------------------------------------------
YearMonth rho_pct  num_weeks
  2012-01  -2.80%          4
  2012-04  -1.80%          4
  2012-05  -2.49%          4
  2012-06  +4.21%          5
  2012-07  -1.53%          4
  2012-09  -2.30%          4

============================================================
STATISTICS (LAST 12 MONTHS)
============================================================
Qualifying months: 6/12 (50%)
Mean Ï:   -0.81%
Median Ï: -1.34%
Std Dev:  1.97%
Range:    [-2.80%, +4.21%]

============================================================
BRACKET APPLIED TO ALL HISTORICAL DATA
============================================================
Total months: 21
Qualifying months: 13/21 (61.9%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-15-output-2.png" width="1405" height="1229" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
STEP 3.2 COMPLETE!
============================================================
Rebate Bracket: Â±1.53%
  Determined by: Last 12 months (6/12 qualify)
  Applied to: All 21 historical months
  Result: 13/21 months qualify overall</code></pre>
</div>
</div>
<p><strong>Note:</strong></p>
<pre><code>By making a comparison with the graph that compares the weekly sales per year and per month, can be easily understandable why some months are performing very well on rolling windows (like November and December). What we mean by this, is that if we take a look on November and December of 2010 and 2011 are having very similar pattern, so the model can easily make a very accurate forecasting.</code></pre>
<pre><code>On the opposite scenario, if we compare months like January and June, with the previous years, we can observe a different pattern, which leads to relatively poor forecasts</code></pre>
</section>
<section id="part-3.3-new-strategy-to-improve-the-forecastings" class="level2">
<h2 class="anchored" data-anchor-id="part-3.3-new-strategy-to-improve-the-forecastings">Part 3.3 â€“ New Strategy to improve the forecastings</h2>
<p>We are thinking of different strategies that can improve the results. Most of them are based on intuitevely reasons, some of them might not make sense statistically, but they can improve significantly the results and add more months on the rebate change.</p>
<p>Before, explaining them let us introduce some results from the above graph, that lead us to these ideas.</p>
<ul>
<li>Our current results, show a under forecasting on average (mean is around -0.8%)</li>
<li>Range from -2.8% to 4.21%</li>
<li>Some months are just outside of the bracket (e.g.&nbsp;-1.8%,-2.3%,-2.5%)</li>
</ul>
<p>Based on the above results, we are thinking of the following strategies:</p>
<ul>
<li>Bias correction â†’ Since we are mainly under forecasting by mean of around -0.8% we can just add 0.8% to all forecasts.</li>
<li>Variance reduction â†’ Reduce forecast variance by dampening toward the mean</li>
<li>Adaptive monthly adjustment â†’ Based on the history of each month reduce or add the forecast, however this approach seems not to be feasible since we dont have a lot of data on a monthly basis.</li>
</ul>
<p><strong>Note:</strong></p>
<pre><code>In most of the cases dampening factor is used when we are dealing with trend, however we have already saw that the time series that we are dealing of does not have trend at all(as we proved with the statistical tests). So even though, dampnening is mainly use when we are dealing with trend components, we would like to try this approach to check for any further improvements. We are reminding that dampening factor in very simple words, just reduces or increases the forecasting towards to the mean of our data</code></pre>
<section id="understanding-the-dampening-strategy" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-dampening-strategy">Understanding the Dampening Strategy</h3>
<p><strong>Important Clarification: Why dampening when Î²=0 (no trend)?</strong></p>
<p>Our statistical tests confirmed there is <strong>no trend</strong> in the data (Î²=0). However, dampening is still beneficial because:</p>
<ol type="1">
<li><strong>Dampening â‰  Trend Adjustment</strong>
<ul>
<li><strong>Trend (Î²)</strong>: Controls long-term directional change (growth/decline over time)</li>
<li><strong>Dampening (d)</strong>: Reduces forecast variance by pulling predictions toward the mean</li>
</ul></li>
<li><strong>The Problem Weâ€™re Solving</strong>
<ul>
<li>Even without trend, our forecasts have <strong>high variance</strong></li>
<li>Some months we over-forecast (+4.2%), some we under-forecast (-2.8%)</li>
<li>This volatility pushes Ï values outside the Â±X% bracket</li>
</ul></li>
<li><strong>How Dampening Helps</strong>
<ul>
<li>Reduces extreme forecasts (both high and low)</li>
<li>Pulls forecasts toward the historical mean</li>
<li>Result: More stable monthly Ï values â†’ More months qualify</li>
</ul></li>
</ol>
<p><strong>Analogy</strong>:</p>
<ul>
<li>Setting Î²=0 says: â€œThe business isnâ€™t growing or shrinkingâ€</li>
<li>Dampening says: â€œLetâ€™s make our forecasts less aggressive/extremeâ€</li>
</ul>
<p>These are <strong>independent decisions</strong> solving <strong>different problems</strong>!</p>
<div id="409a246c" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_conservative_strategy(forecast_df, damping_factor<span class="op">=</span><span class="fl">0.10</span>):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply conservative forecasting strategy by dampening toward historical mean.</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Strategy: Reduce forecast variance by pulling extreme forecasts toward the mean.</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">    This helps keep monthly Ï values closer to 0%, increasing rebate qualification.</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df : DataFrame with columns ['Date', 'Actual', 'Forecast_H2']</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">    damping_factor : float, weight toward mean (0.10 = 10% dampening)</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df_modified : DataFrame with new 'Forecast_Modified' column</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"APPLYING CONSERVATIVE FORECASTING STRATEGY"</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    forecast_df_modified <span class="op">=</span> forecast_df.copy()</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate historical mean</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    historical_mean <span class="op">=</span> forecast_df[<span class="st">'Actual'</span>].mean()</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Strategy: Conservative Forecasting"</span>)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Method: Dampen forecasts </span><span class="sc">{</span>damping_factor<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% toward historical mean"</span>)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Historical mean: $</span><span class="sc">{</span>historical_mean<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Damping factor: </span><span class="sc">{</span>damping_factor<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply strategy: modified = (1-d)*original + d*mean</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    forecast_df_modified[<span class="st">'Forecast_Modified'</span>] <span class="op">=</span> (</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        forecast_df[<span class="st">'Forecast_H2'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> damping_factor) <span class="op">+</span> </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        historical_mean <span class="op">*</span> damping_factor</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Strategy applied to </span><span class="sc">{</span><span class="bu">len</span>(forecast_df_modified)<span class="sc">}</span><span class="ss"> weekly forecasts"</span>)</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> forecast_df_modified, historical_mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8af0079d" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_monthly_rho_with_strategy(forecast_df_modified):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate monthly Ï using the MODIFIED forecasts.</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df_modified : DataFrame with 'Forecast_Modified' column</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_modified : DataFrame with monthly Ï based on modified forecasts</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CALCULATING MONTHLY Ï WITH MODIFIED FORECASTS"</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by month and sum</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> forecast_df_modified.groupby(<span class="st">'YearMonth'</span>).agg({</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: <span class="st">'sum'</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: <span class="st">'sum'</span>,  <span class="co"># Keep original for comparison</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_Modified'</span>: <span class="st">'sum'</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Ï for MODIFIED forecasts</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_modified'</span>] <span class="op">=</span> (</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        (monthly_stats[<span class="st">'Forecast_Modified'</span>] <span class="op">-</span> monthly_stats[<span class="st">'Actual'</span>]) <span class="op">/</span> </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        monthly_stats[<span class="st">'Actual'</span>]</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_modified_pct'</span>] <span class="op">=</span> monthly_stats[<span class="st">'rho_modified'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep original Ï for comparison</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_original'</span>] <span class="op">=</span> (</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        (monthly_stats[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> monthly_stats[<span class="st">'Actual'</span>]) <span class="op">/</span> </span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        monthly_stats[<span class="st">'Actual'</span>]</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_original_pct'</span>] <span class="op">=</span> monthly_stats[<span class="st">'rho_original'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count weeks per month</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    weeks_per_month <span class="op">=</span> forecast_df_modified.groupby(<span class="st">'YearMonth'</span>).size().reset_index(name<span class="op">=</span><span class="st">'num_weeks'</span>)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> monthly_stats.merge(weeks_per_month, on<span class="op">=</span><span class="st">'YearMonth'</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Calculated Ï for </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats)<span class="sc">}</span><span class="ss"> months with modified forecasts"</span>)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="58935436" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_strategy_performance(monthly_stats_modified, forecast_df_modified, X):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate the strategy on last 12 months.</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This answers:</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - Question 3a: How many MORE months qualify?</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - Question 3b: How much accuracy do we lose?</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_modified : DataFrame with modified monthly Ï</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df_modified : DataFrame with modified forecasts</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float, the bracket percentage</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">    evaluation : dict with all metrics</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"EVALUATING STRATEGY PERFORMANCE"</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get last 12 months</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    last_12_original <span class="op">=</span> monthly_stats_modified.tail(<span class="dv">12</span>).copy()</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply bracket to both original and modified</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    last_12_original[<span class="st">'qualifies_original'</span>] <span class="op">=</span> last_12_original[<span class="st">'rho_original_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    last_12_original[<span class="st">'qualifies_modified'</span>] <span class="op">=</span> last_12_original[<span class="st">'rho_modified_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count qualifying months</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    original_qualifying <span class="op">=</span> last_12_original[<span class="st">'qualifies_original'</span>].<span class="bu">sum</span>()</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    modified_qualifying <span class="op">=</span> last_12_original[<span class="st">'qualifies_modified'</span>].<span class="bu">sum</span>()</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    additional_months <span class="op">=</span> modified_qualifying <span class="op">-</span> original_qualifying</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"QUESTION 3a: HOW MANY MORE MONTHS QUALIFY?"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Original forecasts:  </span><span class="sc">{</span>original_qualifying<span class="sc">}</span><span class="ss">/12 months qualify"</span>)</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Modified forecasts:  </span><span class="sc">{</span>modified_qualifying<span class="sc">}</span><span class="ss">/12 months qualify"</span>)</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Additional months:   </span><span class="sc">{</span>additional_months<span class="sc">:+d}</span><span class="ss"> months"</span>)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> additional_months <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> SUCCESS: Strategy adds </span><span class="sc">{</span>additional_months<span class="sc">}</span><span class="ss"> qualifying month(s)!"</span>)</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> additional_months <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> NEUTRAL: Strategy maintains same qualification rate"</span>)</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> WARNING: Strategy loses </span><span class="sc">{</span><span class="bu">abs</span>(additional_months)<span class="sc">}</span><span class="ss"> qualifying month(s)"</span>)</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show which months changed status</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    status_changes <span class="op">=</span> last_12_original[</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>        last_12_original[<span class="st">'qualifies_original'</span>] <span class="op">!=</span> last_12_original[<span class="st">'qualifies_modified'</span>]</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(status_changes) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Months that CHANGED qualification status:"</span>)</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> status_changes.iterrows():</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>            old_status <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> row[<span class="st">'qualifies_original'</span>] <span class="cf">else</span> <span class="st">"âœ—"</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>            new_status <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> row[<span class="st">'qualifies_modified'</span>] <span class="cf">else</span> <span class="st">"âœ—"</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>row[<span class="st">'YearMonth'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>old_status<span class="sc">}</span><span class="ss"> â†’ </span><span class="sc">{</span>new_status<span class="sc">}</span><span class="ss">  "</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"(Ï: </span><span class="sc">{</span>row[<span class="st">'rho_original_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">% â†’ </span><span class="sc">{</span>row[<span class="st">'rho_modified_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate accuracy metrics (Question 3b)</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"QUESTION 3b: HOW MUCH ACCURACY DO WE LOSE?"</span>)</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weekly forecast accuracy</span></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>    mae_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_H2'</span>]))</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>    mae_modified <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_Modified'</span>]))</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>    mae_change <span class="op">=</span> mae_modified <span class="op">-</span> mae_original</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>    mae_change_pct <span class="op">=</span> (mae_change <span class="op">/</span> mae_original) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>    mape_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_H2'</span>]) <span class="op">/</span> </span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>        forecast_df_modified[<span class="st">'Actual'</span>]</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>    )) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>    mape_modified <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_Modified'</span>]) <span class="op">/</span> </span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>        forecast_df_modified[<span class="st">'Actual'</span>]</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>    )) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>    rmse_original <span class="op">=</span> np.sqrt(np.mean(</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_H2'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>    rmse_modified <span class="op">=</span> np.sqrt(np.mean(</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_Modified'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Weekly Forecast Accuracy:"</span>)</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Metric'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Original'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Modified'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Change'</span><span class="sc">:&lt;15}</span><span class="ss">"</span>)</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'MAE'</span><span class="sc">:&lt;15}</span><span class="ss"> $</span><span class="sc">{</span>mae_original<span class="sc">:&lt;14,.2f}</span><span class="ss"> $</span><span class="sc">{</span>mae_modified<span class="sc">:&lt;14,.2f}</span><span class="ss"> </span><span class="sc">{</span>mae_change<span class="sc">:+,.2f}</span><span class="ss"> (</span><span class="sc">{</span>mae_change_pct<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'MAPE'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span>mape_original<span class="sc">:&lt;14.2f}</span><span class="ss">% </span><span class="sc">{</span>mape_modified<span class="sc">:&lt;14.2f}</span><span class="ss">% </span><span class="sc">{</span>mape_modified<span class="op">-</span>mape_original<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'RMSE'</span><span class="sc">:&lt;15}</span><span class="ss"> $</span><span class="sc">{</span>rmse_original<span class="sc">:&lt;14,.2f}</span><span class="ss"> $</span><span class="sc">{</span>rmse_modified<span class="sc">:&lt;14,.2f}</span><span class="ss"> </span><span class="sc">{</span>rmse_modified<span class="op">-</span>rmse_original<span class="sc">:+,.2f}</span><span class="ss">"</span>)</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mae_change_pct <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> EXCELLENT: Accuracy IMPROVED by </span><span class="sc">{</span><span class="bu">abs</span>(mae_change_pct)<span class="sc">:.2f}</span><span class="ss">%!"</span>)</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   This is a WIN-WIN: More rebates + Better accuracy"</span>)</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mae_change_pct <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">â†’ ACCEPTABLE: Small accuracy loss of </span><span class="sc">{</span>mae_change_pct<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Trade-off is worth it for </span><span class="sc">{</span>additional_months<span class="sc">}</span><span class="ss"> additional month(s)"</span>)</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  CAUTION: Accuracy degraded by </span><span class="sc">{</span>mae_change_pct<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly-level accuracy (for the last 12 months)</span></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Monthly Forecast Accuracy (Last 12 Months):"</span>)</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>    monthly_mae_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>        last_12_original[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> last_12_original[<span class="st">'Actual'</span>]</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>    monthly_mae_modified <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>        last_12_original[<span class="st">'Forecast_Modified'</span>] <span class="op">-</span> last_12_original[<span class="st">'Actual'</span>]</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Monthly MAE (Original):  $</span><span class="sc">{</span>monthly_mae_original<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Monthly MAE (Modified):  $</span><span class="sc">{</span>monthly_mae_modified<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Change:                  </span><span class="sc">{</span>monthly_mae_modified <span class="op">-</span> monthly_mae_original<span class="sc">:+,.2f}</span><span class="ss"> "</span></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"(</span><span class="sc">{</span>(monthly_mae_modified <span class="op">-</span> monthly_mae_original)<span class="op">/</span>monthly_mae_original<span class="op">*</span><span class="dv">100</span><span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return all metrics</span></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>    evaluation <span class="op">=</span> {</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">'last_12_stats'</span>: last_12_original,</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">'original_qualifying'</span>: original_qualifying,</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">'modified_qualifying'</span>: modified_qualifying,</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">'additional_months'</span>: additional_months,</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_original'</span>: mae_original,</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_modified'</span>: mae_modified,</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_change'</span>: mae_change,</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_change_pct'</span>: mae_change_pct,</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mape_original'</span>: mape_original,</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mape_modified'</span>: mape_modified,</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rmse_original'</span>: rmse_original,</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rmse_modified'</span>: rmse_modified,</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>        <span class="st">'status_changes'</span>: status_changes</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> evaluation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="10e737b3" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_strategy_results(last_12_stats, X, evaluation):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Comprehensive visualization of strategy results.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">14</span>))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">3</span>, hspace<span class="op">=</span><span class="fl">0.35</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    month_labels <span class="op">=</span> [<span class="bu">str</span>(m) <span class="cf">for</span> m <span class="kw">in</span> last_12_stats[<span class="st">'YearMonth'</span>]]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Original vs Modified Ï (MAIN COMPARISON)</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.arange(<span class="bu">len</span>(last_12_stats))</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    colors_original <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> q <span class="kw">in</span> last_12_stats[<span class="st">'qualifies_original'</span>]]</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    colors_modified <span class="op">=</span> [<span class="st">'darkgreen'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'darkred'</span> <span class="cf">for</span> q <span class="kw">in</span> last_12_stats[<span class="st">'qualifies_modified'</span>]]</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    bars1 <span class="op">=</span> ax1.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, last_12_stats[<span class="st">'rho_original_pct'</span>], width,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="st">'Original Forecasts'</span>, color<span class="op">=</span>colors_original, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    bars2 <span class="op">=</span> ax1.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, last_12_stats[<span class="st">'rho_modified_pct'</span>], width,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="st">'Modified Forecasts (Conservative)'</span>, color<span class="op">=</span>colors_modified, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="ss">f'Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticks(x)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticklabels(month_labels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Month (Last 12 Months)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Original vs Modified Forecasts - Rebate KPI Comparison</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f'Original: </span><span class="sc">{</span>evaluation[<span class="st">"original_qualifying"</span>]<span class="sc">}</span><span class="ss">/12 qualify  â†’  '</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f'Modified: </span><span class="sc">{</span>evaluation[<span class="st">"modified_qualifying"</span>]<span class="sc">}</span><span class="ss">/12 qualify  '</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f'(</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="sc">:+d}</span><span class="ss"> months)'</span>,</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">12</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: Change in Ï for each month</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    rho_change <span class="op">=</span> last_12_stats[<span class="st">'rho_modified_pct'</span>] <span class="op">-</span> last_12_stats[<span class="st">'rho_original_pct'</span>]</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    colors_change <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> c <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'orange'</span> <span class="cf">for</span> c <span class="kw">in</span> rho_change]</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax2.bar(x, rho_change, color<span class="op">=</span>colors_change, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    ax2.set_xticks(x)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    ax2.set_xticklabels(month_labels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Month'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Î”Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Change in Ï (Modified - Original)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar, val <span class="kw">in</span> <span class="bu">zip</span>(bars, rho_change):</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> bar.get_height()</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>        ax2.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:+.1f}</span><span class="ss">%'</span>,</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span> <span class="cf">if</span> height <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'top'</span>, </span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Forecast accuracy comparison</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">'MAE'</span>, <span class="st">'MAPE'</span>, <span class="st">'RMSE'</span>]</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>    original_vals <span class="op">=</span> [evaluation[<span class="st">'mae_original'</span>], evaluation[<span class="st">'mape_original'</span>], evaluation[<span class="st">'rmse_original'</span>]]</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>    modified_vals <span class="op">=</span> [evaluation[<span class="st">'mae_modified'</span>], evaluation[<span class="st">'mape_modified'</span>], evaluation[<span class="st">'rmse_modified'</span>]]</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>    x_metrics <span class="op">=</span> np.arange(<span class="bu">len</span>(metrics))</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>    bars1 <span class="op">=</span> ax3.bar(x_metrics <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, original_vals, width, label<span class="op">=</span><span class="st">'Original'</span>, </span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>    bars2 <span class="op">=</span> ax3.bar(x_metrics <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, modified_vals, width, label<span class="op">=</span><span class="st">'Modified'</span>,</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>    ax3.set_xticks(x_metrics)</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>    ax3.set_xticklabels(metrics)</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Value'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Forecast Accuracy: Original vs Modified'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    ax3.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bars <span class="kw">in</span> [bars1, bars2]:</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> bar.get_height()</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>            ax3.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f'</span><span class="sc">{</span>height<span class="sc">:.0f}</span><span class="ss">'</span>,</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Qualification status matrix</span></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>    ax4.axis(<span class="st">'off'</span>)</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count status changes</span></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>    stayed_qualified <span class="op">=</span> ((last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>    stayed_unqualified <span class="op">=</span> ((<span class="op">~</span>last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (<span class="op">~</span>last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>    became_qualified <span class="op">=</span> ((<span class="op">~</span>last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>    became_unqualified <span class="op">=</span> ((last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (<span class="op">~</span>last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>    status_text <span class="op">=</span> [</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Status Change Matrix'</span>, <span class="st">'Count'</span>],</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'â”€'</span><span class="op">*</span><span class="dv">30</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">8</span>],</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Stayed Qualified âœ“â†’âœ“'</span>, <span class="ss">f'</span><span class="sc">{</span>stayed_qualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Became Qualified âœ—â†’âœ“'</span>, <span class="ss">f'</span><span class="sc">{</span>became_qualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Became Unqualified âœ“â†’âœ—'</span>, <span class="ss">f'</span><span class="sc">{</span>became_unqualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Stayed Unqualified âœ—â†’âœ—'</span>, <span class="ss">f'</span><span class="sc">{</span>stayed_unqualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Net Change'</span>, <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="sc">:+d}</span><span class="ss">'</span>],</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax4.table(cellText<span class="op">=</span>status_text, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="dv">1</span>, <span class="fl">0.7</span>])</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">11</span>)</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">7</span>]:</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight gains</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> became_qualified <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">3</span>, <span class="dv">0</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">3</span>, <span class="dv">1</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Qualification Status Changes'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 5: Distribution comparison</span></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>    ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>    ax5.hist(last_12_stats[<span class="st">'rho_original_pct'</span>], bins<span class="op">=</span><span class="dv">8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Original'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>    ax5.hist(last_12_stats[<span class="st">'rho_modified_pct'</span>], bins<span class="op">=</span><span class="dv">8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Modified'</span>, color<span class="op">=</span><span class="st">'coral'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>    ax5.set_xlabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>    ax5.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>    ax5.set_title(<span class="st">'Distribution of Ï Values'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>    ax5.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>    ax5.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 6: Summary statistics</span></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>    ax6 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>:])</span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>    ax6.axis(<span class="st">'off'</span>)</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>    summary_text <span class="op">=</span> [</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Metric'</span>, <span class="st">'Original'</span>, <span class="st">'Modified'</span>, <span class="st">'Change'</span>],</span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'â”€'</span><span class="op">*</span><span class="dv">35</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">15</span>],</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'QUESTION 3a: Rebate Performance'</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Qualifying Months (/</span><span class="sc">{</span><span class="bu">len</span>(last_12_stats)<span class="sc">}</span><span class="ss">)'</span>, </span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"original_qualifying"</span>]<span class="sc">}</span><span class="ss">'</span>, </span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"modified_qualifying"</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="sc">:+d}</span><span class="ss">'</span>],</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Success Rate'</span>, </span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"original_qualifying"</span>]<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"modified_qualifying"</span>]<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:+.0f}</span><span class="ss">%'</span>],</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'QUESTION 3b: Accuracy Impact'</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  MAE (Weekly)'</span>, </span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"mae_original"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"mae_modified"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mae_change_pct"</span>]<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  MAPE (Weekly)'</span>,</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mape_original"</span>]<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mape_modified"</span>]<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mape_modified"</span>]<span class="op">-</span>evaluation[<span class="st">"mape_original"</span>]<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  RMSE (Weekly)'</span>,</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"rmse_original"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"rmse_modified"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"rmse_modified"</span>]<span class="op">-</span>evaluation[<span class="st">"rmse_original"</span>]<span class="sc">:+,.0f}</span><span class="ss">'</span>],</span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Statistics (Last 12 Months)'</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Mean Ï'</span>,</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>mean()<span class="op">-</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Std Dev Ï'</span>,</span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>std()<span class="op">-</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>std()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax6.table(cellText<span class="op">=</span>summary_text, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="fl">2.2</span>)</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style headers</span></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">11</span>]:</span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight key metrics</span></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> evaluation[<span class="st">'additional_months'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">3</span>, <span class="dv">3</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">4</span>, <span class="dv">3</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> evaluation[<span class="st">'mae_change_pct'</span>] <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">7</span>, <span class="dv">3</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a>    ax6.set_title(<span class="st">'Comprehensive Summary: Questions 3a &amp; 3b'</span>, </span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Strategy Evaluation: Conservative Forecasting Results'</span>, </span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">17</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="8efae5c6" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.3: STRATEGY TO IMPROVE REBATE CHANCES</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply conservative strategy (10% dampening)</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>forecast_modified, hist_mean <span class="op">=</span> apply_conservative_strategy(forecast_all, damping_factor<span class="op">=</span><span class="fl">0.10</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly Ï with modified forecasts</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>monthly_modified <span class="op">=</span> calculate_monthly_rho_with_strategy(forecast_modified)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate strategy (answers both 3a and 3b)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>evaluation <span class="op">=</span> evaluate_strategy_performance(monthly_modified, forecast_modified, X)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize comprehensive results</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>visualize_strategy_results(evaluation[<span class="st">'last_12_stats'</span>], X, evaluation)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Print final summary</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" STEP 3.3 COMPLETE - FINAL SUMMARY"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Additional Qualifying Months"</span>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Answer: </span><span class="sc">{</span>evaluation[<span class="st">'additional_months'</span>]<span class="sc">:+d}</span><span class="ss"> months"</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   (From </span><span class="sc">{</span>evaluation[<span class="st">'original_qualifying'</span>]<span class="sc">}</span><span class="ss">/12 to </span><span class="sc">{</span>evaluation[<span class="st">'modified_qualifying'</span>]<span class="sc">}</span><span class="ss">/12)"</span>)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Accuracy Impact"</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Answer: MAE changed by </span><span class="sc">{</span>evaluation[<span class="st">'mae_change_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> evaluation[<span class="st">'mae_change_pct'</span>] <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Accuracy actually IMPROVED!"</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Trade-off: Small accuracy loss for better rebate qualification"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
APPLYING CONSERVATIVE FORECASTING STRATEGY
============================================================

Strategy: Conservative Forecasting
  Method: Dampen forecasts 10% toward historical mean
  Historical mean: $1,902,516.63
  Damping factor: 0.10

 Strategy applied to 90 weekly forecasts

============================================================
CALCULATING MONTHLY Ï WITH MODIFIED FORECASTS
============================================================

 Calculated Ï for 21 months with modified forecasts

============================================================
EVALUATING STRATEGY PERFORMANCE
============================================================

============================================================
QUESTION 3a: HOW MANY MORE MONTHS QUALIFY?
============================================================

Original forecasts:  6/12 months qualify
Modified forecasts:  6/12 months qualify
Additional months:   +0 months

 NEUTRAL: Strategy maintains same qualification rate

 Months that CHANGED qualification status:
--------------------------------------------------------------------------------
  2011-11:  â†’ âœ—  (Ï: -1.26% â†’ -2.07%)
  2012-01: âœ— â†’   (Ï: -2.80% â†’ -1.52%)
  2012-02:  â†’ âœ—  (Ï: -1.29% â†’ -1.76%)
  2012-07: âœ— â†’   (Ï: -1.53% â†’ -1.16%)

============================================================
QUESTION 3b: HOW MUCH ACCURACY DO WE LOSE?
============================================================

Weekly Forecast Accuracy:
--------------------------------------------------------------------------------
Metric          Original        Modified        Change         
--------------------------------------------------------------------------------
MAE             $57,915.50      $52,294.44      -5,621.07 (-9.71%)
MAPE            3.02          % 2.76          % -0.26%
RMSE            $78,842.18      $71,660.11      -7,182.07

 EXCELLENT: Accuracy IMPROVED by 9.71%!
   This is a WIN-WIN: More rebates + Better accuracy

Monthly Forecast Accuracy (Last 12 Months):
--------------------------------------------------------------------------------
Monthly MAE (Original):  $147,387.64
Monthly MAE (Modified):  $126,208.47
Change:                  -21,179.18 (-14.37%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-20-output-2.png" width="1562" height="1229" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
 STEP 3.3 COMPLETE - FINAL SUMMARY
======================================================================

 Additional Qualifying Months
   Answer: +0 months
   (From 6/12 to 6/12)

 Accuracy Impact
   Answer: MAE changed by -9.71%
  Accuracy actually IMPROVED!</code></pre>
</div>
</div>
<p><strong>Note:</strong></p>
<pre><code>We can see from the above graph that we mananged to improve the MAE of our forecastings, but we were not able to add more months on the rebate region. For this case, we will try below to find a more optimal dampening factor that can also helps us towards this direction.</code></pre>
</section>
</section>
<section id="grid-search-to-find-the-optimal-dampening-factor-that-can-provide-a-bigger-number-of-rebate-months" class="level2">
<h2 class="anchored" data-anchor-id="grid-search-to-find-the-optimal-dampening-factor-that-can-provide-a-bigger-number-of-rebate-months">Grid Search to find the optimal dampening factor that can provide a bigger number of rebate months</h2>
<div id="7c09d103" class="cell" data-execution_count="20">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.3: GRID SEARCH FOR OPTIMAL DAMPENING FACTOR</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grid_search_dampening_factor(forecast_all, monthly_stats_all, X, </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                                 damping_range<span class="op">=</span>np.arange(<span class="fl">0.0</span>, <span class="fl">0.6</span>, <span class="fl">0.01</span>)):</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Grid search to find optimal dampening factor that maximizes qualifying months.</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_all : DataFrame with all forecasts</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_all : DataFrame with all monthly stats</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float, the bracket percentage</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">    damping_range : array, range of dampening factors to test (e.g., 0% to 30%)</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co">    results_df : DataFrame with results for each dampening factor</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">    best_damping : float, optimal dampening factor</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GRID SEARCH: FINDING OPTIMAL DAMPENING FACTOR"</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Testing </span><span class="sc">{</span><span class="bu">len</span>(damping_range)<span class="sc">}</span><span class="ss"> dampening factors from </span><span class="sc">{</span>damping_range[<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>damping_range[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Goal: Maximize qualifying months in last 12 months"</span>)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    historical_mean <span class="op">=</span> forecast_all[<span class="st">'Actual'</span>].mean()</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test each dampening factor</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> damping <span class="kw">in</span> damping_range:</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply strategy</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>        forecast_modified <span class="op">=</span> forecast_all.copy()</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>        forecast_modified[<span class="st">'Forecast_Modified'</span>] <span class="op">=</span> (</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>            forecast_all[<span class="st">'Forecast_H2'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> damping) <span class="op">+</span> </span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>            historical_mean <span class="op">*</span> damping</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate monthly Ï with modified forecasts</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>        monthly_modified <span class="op">=</span> forecast_modified.groupby(<span class="st">'YearMonth'</span>).agg({</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Actual'</span>: <span class="st">'sum'</span>,</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Forecast_H2'</span>: <span class="st">'sum'</span>,</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Forecast_Modified'</span>: <span class="st">'sum'</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        }).reset_index()</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>        monthly_modified[<span class="st">'rho_modified'</span>] <span class="op">=</span> (</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>            (monthly_modified[<span class="st">'Forecast_Modified'</span>] <span class="op">-</span> monthly_modified[<span class="st">'Actual'</span>]) <span class="op">/</span> </span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>            monthly_modified[<span class="st">'Actual'</span>]</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>        monthly_modified[<span class="st">'rho_modified_pct'</span>] <span class="op">=</span> monthly_modified[<span class="st">'rho_modified'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get last 12 months</span></span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>        last_12 <span class="op">=</span> monthly_modified.tail(<span class="dv">12</span>)</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply bracket</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>        last_12[<span class="st">'qualifies'</span>] <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>        qualifying_count <span class="op">=</span> last_12[<span class="st">'qualifies'</span>].<span class="bu">sum</span>()</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate accuracy metrics</span></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(forecast_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_modified[<span class="st">'Forecast_Modified'</span>]))</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>        mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>            (forecast_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_modified[<span class="st">'Forecast_Modified'</span>]) <span class="op">/</span> </span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>            forecast_modified[<span class="st">'Actual'</span>]</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>        )) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> np.sqrt(np.mean(</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>            (forecast_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_modified[<span class="st">'Forecast_Modified'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate Ï statistics</span></span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>        mean_rho <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].mean()</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>        std_rho <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].std()</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>        max_abs_rho <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].<span class="bu">abs</span>().<span class="bu">max</span>()</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">'damping'</span>: damping,</span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">'qualifying_months'</span>: qualifying_count,</span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae'</span>: mae,</span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mape'</span>: mape,</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rmse'</span>: rmse,</span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_rho'</span>: mean_rho,</span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_rho'</span>: std_rho,</span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'max_abs_rho'</span>: max_abs_rho</span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find best dampening factor</span></span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a>    max_qualifying <span class="op">=</span> results_df[<span class="st">'qualifying_months'</span>].<span class="bu">max</span>()</span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a>    best_results <span class="op">=</span> results_df[results_df[<span class="st">'qualifying_months'</span>] <span class="op">==</span> max_qualifying]</span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Among those with max qualifying months, choose the one with best MAE</span></span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>    best_idx <span class="op">=</span> best_results[<span class="st">'mae'</span>].idxmin()</span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a>    best_damping <span class="op">=</span> results_df.loc[best_idx, <span class="st">'damping'</span>]</span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" Grid search complete!"</span>)</span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMAL DAMPENING FACTOR"</span>)</span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best damping: </span><span class="sc">{</span>best_damping<span class="sc">:.2f}</span><span class="ss"> (</span><span class="sc">{</span>best_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% toward mean)"</span>)</span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Qualifying months: </span><span class="sc">{</span><span class="bu">int</span>(results_df.loc[best_idx, <span class="st">'qualifying_months'</span>])<span class="sc">}</span><span class="ss">/12"</span>)</span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE: $</span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'mae'</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAPE: </span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'mape'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Ï: </span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'mean_rho'</span>]<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Std Dev Ï: </span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'std_rho'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show baseline for comparison</span></span>
<span id="cb37-112"><a href="#cb37-112" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> results_df[results_df[<span class="st">'damping'</span>] <span class="op">==</span> <span class="fl">0.0</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb37-113"><a href="#cb37-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Baseline (no dampening):"</span>)</span>
<span id="cb37-114"><a href="#cb37-114" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Qualifying months: </span><span class="sc">{</span><span class="bu">int</span>(baseline[<span class="st">'qualifying_months'</span>])<span class="sc">}</span><span class="ss">/12"</span>)</span>
<span id="cb37-115"><a href="#cb37-115" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE: $</span><span class="sc">{</span>baseline[<span class="st">'mae'</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb37-116"><a href="#cb37-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-117"><a href="#cb37-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show improvement</span></span>
<span id="cb37-118"><a href="#cb37-118" aria-hidden="true" tabindex="-1"></a>    improvement_months <span class="op">=</span> <span class="bu">int</span>(results_df.loc[best_idx, <span class="st">'qualifying_months'</span>]) <span class="op">-</span> <span class="bu">int</span>(baseline[<span class="st">'qualifying_months'</span>])</span>
<span id="cb37-119"><a href="#cb37-119" aria-hidden="true" tabindex="-1"></a>    improvement_mae_pct <span class="op">=</span> ((results_df.loc[best_idx, <span class="st">'mae'</span>] <span class="op">-</span> baseline[<span class="st">'mae'</span>]) <span class="op">/</span> baseline[<span class="st">'mae'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb37-120"><a href="#cb37-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-121"><a href="#cb37-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Improvement:"</span>)</span>
<span id="cb37-122"><a href="#cb37-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Additional months: </span><span class="sc">{</span>improvement_months<span class="sc">:+d}</span><span class="ss">"</span>)</span>
<span id="cb37-123"><a href="#cb37-123" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE change: </span><span class="sc">{</span>improvement_mae_pct<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb37-124"><a href="#cb37-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-125"><a href="#cb37-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df, best_damping</span>
<span id="cb37-126"><a href="#cb37-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-127"><a href="#cb37-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-128"><a href="#cb37-128" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_grid_search_results(results_df, X, baseline_qualifying<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb37-129"><a href="#cb37-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-130"><a href="#cb37-130" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize grid search results showing trade-off between qualifying months and accuracy.</span></span>
<span id="cb37-131"><a href="#cb37-131" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-132"><a href="#cb37-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-133"><a href="#cb37-133" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">12</span>))</span>
<span id="cb37-134"><a href="#cb37-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-135"><a href="#cb37-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Qualifying months vs dampening</span></span>
<span id="cb37-136"><a href="#cb37-136" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb37-137"><a href="#cb37-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-138"><a href="#cb37-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color points by whether they're better than baseline</span></span>
<span id="cb37-139"><a href="#cb37-139" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> q <span class="op">&gt;</span> baseline_qualifying <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">if</span> q <span class="op">&lt;</span> baseline_qualifying <span class="cf">else</span> <span class="st">'orange'</span> </span>
<span id="cb37-140"><a href="#cb37-140" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> q <span class="kw">in</span> results_df[<span class="st">'qualifying_months'</span>]]</span>
<span id="cb37-141"><a href="#cb37-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-142"><a href="#cb37-142" aria-hidden="true" tabindex="-1"></a>    ax1.scatter(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'qualifying_months'</span>], </span>
<span id="cb37-143"><a href="#cb37-143" aria-hidden="true" tabindex="-1"></a>               c<span class="op">=</span>colors, s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb37-144"><a href="#cb37-144" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(baseline_qualifying, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb37-145"><a href="#cb37-145" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Baseline: </span><span class="sc">{</span>baseline_qualifying<span class="sc">}</span><span class="ss">/12'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-146"><a href="#cb37-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-147"><a href="#cb37-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark the best point</span></span>
<span id="cb37-148"><a href="#cb37-148" aria-hidden="true" tabindex="-1"></a>    best_idx <span class="op">=</span> results_df[<span class="st">'qualifying_months'</span>].idxmax()</span>
<span id="cb37-149"><a href="#cb37-149" aria-hidden="true" tabindex="-1"></a>    best_mae_in_best <span class="op">=</span> results_df[results_df[<span class="st">'qualifying_months'</span>] <span class="op">==</span> results_df[<span class="st">'qualifying_months'</span>].<span class="bu">max</span>()][<span class="st">'mae'</span>].idxmin()</span>
<span id="cb37-150"><a href="#cb37-150" aria-hidden="true" tabindex="-1"></a>    ax1.scatter(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, </span>
<span id="cb37-151"><a href="#cb37-151" aria-hidden="true" tabindex="-1"></a>               results_df.loc[best_mae_in_best, <span class="st">'qualifying_months'</span>],</span>
<span id="cb37-152"><a href="#cb37-152" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'*'</span>, s<span class="op">=</span><span class="dv">500</span>, color<span class="op">=</span><span class="st">'gold'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-153"><a href="#cb37-153" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Optimal'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb37-154"><a href="#cb37-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-155"><a href="#cb37-155" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-156"><a href="#cb37-156" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Qualifying Months (out of 12)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-157"><a href="#cb37-157" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">'Qualifying Months vs Dampening Factor'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-158"><a href="#cb37-158" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-159"><a href="#cb37-159" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-160"><a href="#cb37-160" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylim([results_df[<span class="st">'qualifying_months'</span>].<span class="bu">min</span>() <span class="op">-</span> <span class="fl">0.5</span>, <span class="fl">12.5</span>])</span>
<span id="cb37-161"><a href="#cb37-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-162"><a href="#cb37-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: MAE vs dampening</span></span>
<span id="cb37-163"><a href="#cb37-163" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb37-164"><a href="#cb37-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-165"><a href="#cb37-165" aria-hidden="true" tabindex="-1"></a>    baseline_mae <span class="op">=</span> results_df[results_df[<span class="st">'damping'</span>] <span class="op">==</span> <span class="fl">0.0</span>][<span class="st">'mae'</span>].values[<span class="dv">0</span>]</span>
<span id="cb37-166"><a href="#cb37-166" aria-hidden="true" tabindex="-1"></a>    colors2 <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> mae <span class="op">&lt;</span> baseline_mae <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> mae <span class="kw">in</span> results_df[<span class="st">'mae'</span>]]</span>
<span id="cb37-167"><a href="#cb37-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-168"><a href="#cb37-168" aria-hidden="true" tabindex="-1"></a>    ax2.scatter(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'mae'</span>], </span>
<span id="cb37-169"><a href="#cb37-169" aria-hidden="true" tabindex="-1"></a>               c<span class="op">=</span>colors2, s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb37-170"><a href="#cb37-170" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(baseline_mae, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-171"><a href="#cb37-171" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Baseline MAE: $</span><span class="sc">{</span>baseline_mae<span class="sc">:,.0f}</span><span class="ss">'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-172"><a href="#cb37-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-173"><a href="#cb37-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark optimal</span></span>
<span id="cb37-174"><a href="#cb37-174" aria-hidden="true" tabindex="-1"></a>    ax2.scatter(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb37-175"><a href="#cb37-175" aria-hidden="true" tabindex="-1"></a>               results_df.loc[best_mae_in_best, <span class="st">'mae'</span>],</span>
<span id="cb37-176"><a href="#cb37-176" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'*'</span>, s<span class="op">=</span><span class="dv">500</span>, color<span class="op">=</span><span class="st">'gold'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-177"><a href="#cb37-177" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Optimal'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb37-178"><a href="#cb37-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-179"><a href="#cb37-179" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-180"><a href="#cb37-180" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'MAE ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-181"><a href="#cb37-181" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Forecast Accuracy (MAE) vs Dampening'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-182"><a href="#cb37-182" aria-hidden="true" tabindex="-1"></a>    ax2.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-183"><a href="#cb37-183" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-184"><a href="#cb37-184" aria-hidden="true" tabindex="-1"></a>    ax2.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb37-185"><a href="#cb37-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-186"><a href="#cb37-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Trade-off curve </span></span>
<span id="cb37-187"><a href="#cb37-187" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">2</span>]</span>
<span id="cb37-188"><a href="#cb37-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-189"><a href="#cb37-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create color gradient based on dampening</span></span>
<span id="cb37-190"><a href="#cb37-190" aria-hidden="true" tabindex="-1"></a>    scatter <span class="op">=</span> ax3.scatter(results_df[<span class="st">'mae'</span>], results_df[<span class="st">'qualifying_months'</span>],</span>
<span id="cb37-191"><a href="#cb37-191" aria-hidden="true" tabindex="-1"></a>                         c<span class="op">=</span>results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, </span>
<span id="cb37-192"><a href="#cb37-192" aria-hidden="true" tabindex="-1"></a>                         cmap<span class="op">=</span><span class="st">'viridis'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb37-193"><a href="#cb37-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-194"><a href="#cb37-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark baseline</span></span>
<span id="cb37-195"><a href="#cb37-195" aria-hidden="true" tabindex="-1"></a>    baseline_row <span class="op">=</span> results_df[results_df[<span class="st">'damping'</span>] <span class="op">==</span> <span class="fl">0.0</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb37-196"><a href="#cb37-196" aria-hidden="true" tabindex="-1"></a>    ax3.scatter(baseline_row[<span class="st">'mae'</span>], baseline_row[<span class="st">'qualifying_months'</span>],</span>
<span id="cb37-197"><a href="#cb37-197" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'X'</span>, s<span class="op">=</span><span class="dv">300</span>, color<span class="op">=</span><span class="st">'red'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-198"><a href="#cb37-198" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Baseline (0%)'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb37-199"><a href="#cb37-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-200"><a href="#cb37-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark optimal</span></span>
<span id="cb37-201"><a href="#cb37-201" aria-hidden="true" tabindex="-1"></a>    ax3.scatter(results_df.loc[best_mae_in_best, <span class="st">'mae'</span>],</span>
<span id="cb37-202"><a href="#cb37-202" aria-hidden="true" tabindex="-1"></a>               results_df.loc[best_mae_in_best, <span class="st">'qualifying_months'</span>],</span>
<span id="cb37-203"><a href="#cb37-203" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'*'</span>, s<span class="op">=</span><span class="dv">500</span>, color<span class="op">=</span><span class="st">'gold'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-204"><a href="#cb37-204" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Optimal'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb37-205"><a href="#cb37-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-206"><a href="#cb37-206" aria-hidden="true" tabindex="-1"></a>    cbar <span class="op">=</span> plt.colorbar(scatter, ax<span class="op">=</span>ax3)</span>
<span id="cb37-207"><a href="#cb37-207" aria-hidden="true" tabindex="-1"></a>    cbar.set_label(<span class="st">'Dampening (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-208"><a href="#cb37-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-209"><a href="#cb37-209" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'MAE ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-210"><a href="#cb37-210" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Qualifying Months'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-211"><a href="#cb37-211" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Trade-off: Accuracy vs Rebate Qualification'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-212"><a href="#cb37-212" aria-hidden="true" tabindex="-1"></a>    ax3.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-213"><a href="#cb37-213" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-214"><a href="#cb37-214" aria-hidden="true" tabindex="-1"></a>    ax3.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb37-215"><a href="#cb37-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-216"><a href="#cb37-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Mean Ï vs dampening</span></span>
<span id="cb37-217"><a href="#cb37-217" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb37-218"><a href="#cb37-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-219"><a href="#cb37-219" aria-hidden="true" tabindex="-1"></a>    ax4.plot(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'mean_rho'</span>], </span>
<span id="cb37-220"><a href="#cb37-220" aria-hidden="true" tabindex="-1"></a>            <span class="st">'o-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-221"><a href="#cb37-221" aria-hidden="true" tabindex="-1"></a>    ax4.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Perfect (Ï=0)'</span>)</span>
<span id="cb37-222"><a href="#cb37-222" aria-hidden="true" tabindex="-1"></a>    ax4.axvline(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, </span>
<span id="cb37-223"><a href="#cb37-223" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">'gold'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Optimal'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-224"><a href="#cb37-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-225"><a href="#cb37-225" aria-hidden="true" tabindex="-1"></a>    ax4.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-226"><a href="#cb37-226" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Mean Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-227"><a href="#cb37-227" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Mean Rebate KPI vs Dampening'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-228"><a href="#cb37-228" aria-hidden="true" tabindex="-1"></a>    ax4.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-229"><a href="#cb37-229" aria-hidden="true" tabindex="-1"></a>    ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-230"><a href="#cb37-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-231"><a href="#cb37-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 5: Std Dev of Ï vs dampening</span></span>
<span id="cb37-232"><a href="#cb37-232" aria-hidden="true" tabindex="-1"></a>    ax5 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb37-233"><a href="#cb37-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-234"><a href="#cb37-234" aria-hidden="true" tabindex="-1"></a>    ax5.plot(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'std_rho'</span>],</span>
<span id="cb37-235"><a href="#cb37-235" aria-hidden="true" tabindex="-1"></a>            <span class="st">'o-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-236"><a href="#cb37-236" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb37-237"><a href="#cb37-237" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">'gold'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Optimal'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-238"><a href="#cb37-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-239"><a href="#cb37-239" aria-hidden="true" tabindex="-1"></a>    ax5.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-240"><a href="#cb37-240" aria-hidden="true" tabindex="-1"></a>    ax5.set_ylabel(<span class="st">'Std Dev of Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-241"><a href="#cb37-241" aria-hidden="true" tabindex="-1"></a>    ax5.set_title(<span class="st">'Variability of Ï vs Dampening'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-242"><a href="#cb37-242" aria-hidden="true" tabindex="-1"></a>    ax5.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-243"><a href="#cb37-243" aria-hidden="true" tabindex="-1"></a>    ax5.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-244"><a href="#cb37-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-245"><a href="#cb37-245" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 6: Summary table</span></span>
<span id="cb37-246"><a href="#cb37-246" aria-hidden="true" tabindex="-1"></a>    ax6 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb37-247"><a href="#cb37-247" aria-hidden="true" tabindex="-1"></a>    ax6.axis(<span class="st">'off'</span>)</span>
<span id="cb37-248"><a href="#cb37-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-249"><a href="#cb37-249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get top 5 configurations</span></span>
<span id="cb37-250"><a href="#cb37-250" aria-hidden="true" tabindex="-1"></a>    top5 <span class="op">=</span> results_df.nlargest(<span class="dv">5</span>, <span class="st">'qualifying_months'</span>)[[<span class="st">'damping'</span>, <span class="st">'qualifying_months'</span>, <span class="st">'mae'</span>, <span class="st">'mean_rho'</span>, <span class="st">'std_rho'</span>]].copy()</span>
<span id="cb37-251"><a href="#cb37-251" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'damping_pct'</span>] <span class="op">=</span> (top5[<span class="st">'damping'</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-252"><a href="#cb37-252" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'qualifying_months'</span>] <span class="op">=</span> top5[<span class="st">'qualifying_months'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb37-253"><a href="#cb37-253" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'mae'</span>] <span class="op">=</span> top5[<span class="st">'mae'</span>].<span class="bu">round</span>(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-254"><a href="#cb37-254" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'mean_rho'</span>] <span class="op">=</span> top5[<span class="st">'mean_rho'</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb37-255"><a href="#cb37-255" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'std_rho'</span>] <span class="op">=</span> top5[<span class="st">'std_rho'</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb37-256"><a href="#cb37-256" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-257"><a href="#cb37-257" aria-hidden="true" tabindex="-1"></a>    table_data <span class="op">=</span> [[<span class="st">'Rank'</span>, <span class="st">'Damp%'</span>, <span class="st">'Qual/12'</span>, <span class="st">'MAE'</span>, <span class="st">'Mean Ï'</span>, <span class="st">'Std Ï'</span>]]</span>
<span id="cb37-258"><a href="#cb37-258" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (idx, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top5.iterrows(), <span class="dv">1</span>):</span>
<span id="cb37-259"><a href="#cb37-259" aria-hidden="true" tabindex="-1"></a>        marker <span class="op">=</span> <span class="st">'â­'</span> <span class="cf">if</span> i <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb37-260"><a href="#cb37-260" aria-hidden="true" tabindex="-1"></a>        table_data.append([</span>
<span id="cb37-261"><a href="#cb37-261" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb37-262"><a href="#cb37-262" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"damping_pct"</span>]<span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb37-263"><a href="#cb37-263" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"qualifying_months"</span>]<span class="sc">}</span><span class="ss">/12'</span>,</span>
<span id="cb37-264"><a href="#cb37-264" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'$</span><span class="sc">{</span>row[<span class="st">"mae"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb37-265"><a href="#cb37-265" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"mean_rho"</span>]<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb37-266"><a href="#cb37-266" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"std_rho"</span>]<span class="sc">:.2f}</span><span class="ss">%'</span></span>
<span id="cb37-267"><a href="#cb37-267" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb37-268"><a href="#cb37-268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-269"><a href="#cb37-269" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax6.table(cellText<span class="op">=</span>table_data, cellLoc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb37-270"><a href="#cb37-270" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.85</span>, <span class="fl">0.6</span>])</span>
<span id="cb37-271"><a href="#cb37-271" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb37-272"><a href="#cb37-272" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb37-273"><a href="#cb37-273" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="fl">2.5</span>)</span>
<span id="cb37-274"><a href="#cb37-274" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-275"><a href="#cb37-275" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style header</span></span>
<span id="cb37-276"><a href="#cb37-276" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb37-277"><a href="#cb37-277" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb37-278"><a href="#cb37-278" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb37-279"><a href="#cb37-279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-280"><a href="#cb37-280" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight best</span></span>
<span id="cb37-281"><a href="#cb37-281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb37-282"><a href="#cb37-282" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">1</span>, j)].set_facecolor(<span class="st">'gold'</span>)</span>
<span id="cb37-283"><a href="#cb37-283" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">1</span>, j)].set_alpha(<span class="fl">0.5</span>)</span>
<span id="cb37-284"><a href="#cb37-284" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-285"><a href="#cb37-285" aria-hidden="true" tabindex="-1"></a>    ax6.set_title(<span class="st">'Top 5 Dampening Factors'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb37-286"><a href="#cb37-286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-287"><a href="#cb37-287" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Grid Search Results: Finding Optimal Dampening Factor'</span>, </span>
<span id="cb37-288"><a href="#cb37-288" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">17</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-289"><a href="#cb37-289" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb37-290"><a href="#cb37-290" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb37-291"><a href="#cb37-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-292"><a href="#cb37-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-293"><a href="#cb37-293" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_dampening_comparison_table(results_df, key_values<span class="op">=</span>[<span class="fl">0.00</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.20</span>,<span class="fl">0.25</span>,<span class="fl">0.30</span>,<span class="fl">0.35</span>,<span class="fl">0.40</span>]):</span>
<span id="cb37-294"><a href="#cb37-294" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-295"><a href="#cb37-295" aria-hidden="true" tabindex="-1"></a><span class="co">    Display a clean comparison table for specific dampening values.</span></span>
<span id="cb37-296"><a href="#cb37-296" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-297"><a href="#cb37-297" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-298"><a href="#cb37-298" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb37-299"><a href="#cb37-299" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"DAMPENING FACTOR COMPARISON"</span>)</span>
<span id="cb37-300"><a href="#cb37-300" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb37-301"><a href="#cb37-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-302"><a href="#cb37-302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for key values (or closest)</span></span>
<span id="cb37-303"><a href="#cb37-303" aria-hidden="true" tabindex="-1"></a>    comparison_rows <span class="op">=</span> []</span>
<span id="cb37-304"><a href="#cb37-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val <span class="kw">in</span> key_values:</span>
<span id="cb37-305"><a href="#cb37-305" aria-hidden="true" tabindex="-1"></a>        closest_idx <span class="op">=</span> (results_df[<span class="st">'damping'</span>] <span class="op">-</span> val).<span class="bu">abs</span>().idxmin()</span>
<span id="cb37-306"><a href="#cb37-306" aria-hidden="true" tabindex="-1"></a>        comparison_rows.append(results_df.loc[closest_idx])</span>
<span id="cb37-307"><a href="#cb37-307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-308"><a href="#cb37-308" aria-hidden="true" tabindex="-1"></a>    comparison_df <span class="op">=</span> pd.DataFrame(comparison_rows)</span>
<span id="cb37-309"><a href="#cb37-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-310"><a href="#cb37-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format for display</span></span>
<span id="cb37-311"><a href="#cb37-311" aria-hidden="true" tabindex="-1"></a>    display_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-312"><a href="#cb37-312" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Dampening'</span>: (comparison_df[<span class="st">'damping'</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.0f}</span><span class="ss">%'</span>),</span>
<span id="cb37-313"><a href="#cb37-313" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Qualifying (last 12)'</span>: comparison_df[<span class="st">'qualifying_months'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">}</span><span class="ss">/12'</span>),</span>
<span id="cb37-314"><a href="#cb37-314" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAE'</span>: comparison_df[<span class="st">'mae'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'$</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">'</span>),</span>
<span id="cb37-315"><a href="#cb37-315" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAPE'</span>: comparison_df[<span class="st">'mape'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">%'</span>),</span>
<span id="cb37-316"><a href="#cb37-316" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Mean Ï'</span>: comparison_df[<span class="st">'mean_rho'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>),</span>
<span id="cb37-317"><a href="#cb37-317" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Std Ï'</span>: comparison_df[<span class="st">'std_rho'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">%'</span>),</span>
<span id="cb37-318"><a href="#cb37-318" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Max |Ï|'</span>: comparison_df[<span class="st">'max_abs_rho'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb37-319"><a href="#cb37-319" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-320"><a href="#cb37-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-321"><a href="#cb37-321" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> display_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb37-322"><a href="#cb37-322" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-323"><a href="#cb37-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight the best</span></span>
<span id="cb37-324"><a href="#cb37-324" aria-hidden="true" tabindex="-1"></a>    best_qual <span class="op">=</span> comparison_df[<span class="st">'qualifying_months'</span>].<span class="bu">max</span>()</span>
<span id="cb37-325"><a href="#cb37-325" aria-hidden="true" tabindex="-1"></a>    best_rows <span class="op">=</span> comparison_df[comparison_df[<span class="st">'qualifying_months'</span>] <span class="op">==</span> best_qual]</span>
<span id="cb37-326"><a href="#cb37-326" aria-hidden="true" tabindex="-1"></a>    best_mae_idx <span class="op">=</span> best_rows[<span class="st">'mae'</span>].idxmin()</span>
<span id="cb37-327"><a href="#cb37-327" aria-hidden="true" tabindex="-1"></a>    best_damping <span class="op">=</span> comparison_df.loc[best_mae_idx, <span class="st">'damping'</span>]</span>
<span id="cb37-328"><a href="#cb37-328" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-329"><a href="#cb37-329" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-330"><a href="#cb37-330" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" RECOMMENDED: </span><span class="sc">{</span>best_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% dampening"</span>)</span>
<span id="cb37-331"><a href="#cb37-331" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Maximizes qualifying months (</span><span class="sc">{</span><span class="bu">int</span>(comparison_df.loc[best_mae_idx, <span class="st">'qualifying_months'</span>])<span class="sc">}</span><span class="ss">/12)"</span>)</span>
<span id="cb37-332"><a href="#cb37-332" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   While maintaining good accuracy (MAE: $</span><span class="sc">{</span>comparison_df<span class="sc">.</span>loc[best_mae_idx, <span class="st">'mae'</span>]<span class="sc">:,.0f}</span><span class="ss">)"</span>)</span>
<span id="cb37-333"><a href="#cb37-333" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="12966310" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.3: GRID SEARCH FOR OPTIMAL DAMPENING</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Run grid search (test dampening from 0% to 30% in 1% increments)</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>grid_results, optimal_damping <span class="op">=</span> grid_search_dampening_factor(</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    forecast_all, </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    monthly_stats_all, </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    X,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    damping_range<span class="op">=</span>np.arange(<span class="fl">0.0</span>, <span class="fl">0.31</span>, <span class="fl">0.01</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize grid search results</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>visualize_grid_search_results(grid_results, X, baseline_qualifying<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Show comparison table</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>display_dampening_comparison_table(grid_results, key_values<span class="op">=</span>[<span class="fl">0.00</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>])</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Now apply the OPTIMAL dampening factor</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"APPLYING OPTIMAL DAMPENING FACTOR: </span><span class="sc">{</span>optimal_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%"</span>)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>forecast_modified_optimal, hist_mean <span class="op">=</span> apply_conservative_strategy(</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    forecast_all, </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    damping_factor<span class="op">=</span>optimal_damping</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly Ï with optimal dampening</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>monthly_modified_optimal <span class="op">=</span> calculate_monthly_rho_with_strategy(forecast_modified_optimal)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate with optimal dampening</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>evaluation_optimal <span class="op">=</span> evaluate_strategy_performance(</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    monthly_modified_optimal, </span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    forecast_modified_optimal, </span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    X</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize final results with optimal dampening</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>visualize_strategy_results(evaluation_optimal[<span class="st">'last_12_stats'</span>], X, evaluation_optimal)</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OPTIMAL DAMPENING"</span>)</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Optimal Dampening: </span><span class="sc">{</span>optimal_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%"</span>)</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>evaluation_optimal[<span class="st">'additional_months'</span>]<span class="sc">:+d}</span><span class="ss"> additional months"</span>)</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" MAE changed by </span><span class="sc">{</span>evaluation_optimal[<span class="st">'mae_change_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
GRID SEARCH: FINDING OPTIMAL DAMPENING FACTOR
======================================================================

Testing 31 dampening factors from 0.00 to 0.30
Goal: Maximize qualifying months in last 12 months
Bracket: Â±1.53%

 Grid search complete!

======================================================================
OPTIMAL DAMPENING FACTOR
======================================================================
Best damping: 0.13 (13% toward mean)
  Qualifying months: 7/12
  MAE: $51,774.01
  MAPE: 2.73%
  Mean Ï: -0.95%
  Std Dev Ï: 1.54%

Baseline (no dampening):
  Qualifying months: 6/12
  MAE: $57,915.50

Improvement:
  Additional months: +1
  MAE change: -10.60%</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-22-output-2.png" width="1910" height="1133" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
DAMPENING FACTOR COMPARISON
================================================================================

Dampening Qualifying (last 12)     MAE  MAPE Mean Ï Std Ï Max |Ï|
       0%                 6/12 $57,916 3.02% -0.81% 1.97%   4.21%
       5%                 6/12 $54,719 2.87% -0.87% 1.74%   3.93%
      10%                 6/12 $52,294 2.76% -0.92% 1.59%   3.65%
      15%                 6/12 $51,883 2.73% -0.97% 1.54%   3.37%
      20%                 6/12 $52,398 2.73% -1.02% 1.60%   3.08%
      25%                 6/12 $53,878 2.78% -1.08% 1.76%   3.66%

================================================================================
 RECOMMENDED: 15% dampening
   Maximizes qualifying months (6/12)
   While maintaining good accuracy (MAE: $51,883)
================================================================================

======================================================================
APPLYING OPTIMAL DAMPENING FACTOR: 13%
======================================================================

============================================================
APPLYING CONSERVATIVE FORECASTING STRATEGY
============================================================

Strategy: Conservative Forecasting
  Method: Dampen forecasts 13% toward historical mean
  Historical mean: $1,902,516.63
  Damping factor: 0.13

 Strategy applied to 90 weekly forecasts

============================================================
CALCULATING MONTHLY Ï WITH MODIFIED FORECASTS
============================================================

 Calculated Ï for 21 months with modified forecasts

============================================================
EVALUATING STRATEGY PERFORMANCE
============================================================

============================================================
QUESTION 3a: HOW MANY MORE MONTHS QUALIFY?
============================================================

Original forecasts:  6/12 months qualify
Modified forecasts:  7/12 months qualify
Additional months:   +1 months

 SUCCESS: Strategy adds 1 qualifying month(s)!

 Months that CHANGED qualification status:
--------------------------------------------------------------------------------
  2011-11:  â†’ âœ—  (Ï: -1.26% â†’ -2.32%)
  2012-01: âœ— â†’   (Ï: -2.80% â†’ -1.13%)
  2012-02:  â†’ âœ—  (Ï: -1.29% â†’ -1.90%)
  2012-07: âœ— â†’   (Ï: -1.53% â†’ -1.05%)
  2012-09: âœ— â†’   (Ï: -2.30% â†’ -1.43%)

============================================================
QUESTION 3b: HOW MUCH ACCURACY DO WE LOSE?
============================================================

Weekly Forecast Accuracy:
--------------------------------------------------------------------------------
Metric          Original        Modified        Change         
--------------------------------------------------------------------------------
MAE             $57,915.50      $51,774.01      -6,141.49 (-10.60%)
MAPE            3.02          % 2.73          % -0.29%
RMSE            $78,842.18      $70,808.87      -8,033.32

 EXCELLENT: Accuracy IMPROVED by 10.60%!
   This is a WIN-WIN: More rebates + Better accuracy

Monthly Forecast Accuracy (Last 12 Months):
--------------------------------------------------------------------------------
Monthly MAE (Original):  $147,387.64
Monthly MAE (Modified):  $128,838.60
Change:                  -18,549.04 (-12.59%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Part2_files/figure-html/cell-22-output-4.png" width="1554" height="1229" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
OPTIMAL DAMPENING
======================================================================

Optimal Dampening: 13%

+1 additional months
 MAE changed by -10.60%</code></pre>
</div>
</div>
</section>
<section id="limitations-and-considerations" class="level2">
<h2 class="anchored" data-anchor-id="limitations-and-considerations">Limitations and Considerations</h2>
<ol type="1">
<li><strong>Data Limitations</strong>
<ul>
<li>Only 2.5 years of historical data (143 weeks)</li>
<li>Limited to 21 months for horizon-2 analysis (need 52 weeks for initialization)</li>
<li>Only analyzing Store 2 - results may not generalize to other stores</li>
</ul></li>
<li><strong>Model Assumptions</strong>
<ul>
<li>Assumes future patterns similar to past (stationarity)</li>
<li>No incorporation of external factors (promotions, competitors, economy)</li>
<li>Fixed seasonal pattern (52-week cycle)</li>
</ul></li>
<li><strong>Strategy Limitations</strong>
<ul>
<li>Dampening is a post-hoc adjustment, not part of the model</li>
<li>Assumes supplier contract terms remain constant</li>
<li>Historical mean may drift over time</li>
</ul></li>
<li><strong>Business Context</strong>
<ul>
<li>Rebate contract terms (Â±X%) determined historically</li>
<li>Actual supplier may use different evaluation criteria</li>
<li>Does not account for inventory holding costs vs.&nbsp;stockout costs</li>
</ul></li>
</ol>
<hr>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb42" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Time Series Forecasting: Walmart Sales Analysis Part 2"</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Optimized TES model, defining bracket +-X% and recommending different strategy approaches"</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Costin-Andrei Taulescu &amp; Panagiotis Valsamis"</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: show</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: github</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-width: 12</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-height: 6</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co">  pdf:</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="co">    colorlinks: true</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>In the following part of the project, we will use one store from our data with aggregated sales information for all its deparments. The goal is to create a model that will be able to predict as much accurate as possible the sales on the horizon of two weeks. If we are able to predict with high accuracy then we will know the order that needs to be placed in order to satisfy the demand and the main goal is to maximize a rebate laid out in a contract between the store and its supplier.</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluation Metric</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>The evaluation metric we will use will be the sum of forecasts for every month minus the sum of the actuals divided by the sum of the actuals. The sum will be 4 or 5 weeks depending on the month and if the final percentage is between a range that will be determined later we will get the rebate.</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>**Formula**</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>$$\rho_m = \frac{\sum_i f_i - \sum_i a_i}{\sum_i a_i}$$</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>**NOTE**</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="in">If pm is +10% on the one week, and -10% on the other week in the end of the month it will cancel out.</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a><span class="fu">## Procedure</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We will use the last 6 weeks of the data as testing data. So we will train the data based on the other weeks. We will use grid search to optimize the TES algorithm and find the best possible model that can perform good in two week horizons. </span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Based on the optimized model we found before we will retrain the whole dataset and will calculate each month performance of the last whole year, we will calculate the X% range, in which just the 6/12 months of the last year will be in that range. If we are able to predict the sales in that range we will get the rebate. After this, we will try to define a strategy that can be performed in order to include more of these months in the range and maximize the chances of getting the rebate. This strategy might not be statistically proved, but it might be more intuitive based on the data that we have. For example, one intuition might be if our model overperforms in the first two weeks of the month and underperforms in the last two weeks of the month, we might want to adjust our forecast for the last two weeks based on the error that we had in the first two weeks(like to reduce a percentage on every first two weeks and add a percentage of every two last weeks on each month).</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup and Imports</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> locale</span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>locale.setlocale(locale.LC_TIME, <span class="st">"English_United States.1252"</span>)</span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>, <span class="dv">6</span>)</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Importing and Visualizing the Data of Store 2</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>As we also used on the first part of the project, we will use the store 2 data(just to have some different data exploration from part 1), after aggregated for all its departments. We will visualize the aggregated time series in order to see its main characteristics. We expect clear seasonality and not trend on the data(based on our findings from part 1).</span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>:::{.callout-important}</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>**Data Preprocessing:**</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Leave last 6 weeks out</span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Remove negative values</span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Aggregate sales for all departments</span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_and_prepare_data(filepath, store_id<span class="op">=</span><span class="dv">2</span>, test_weeks<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a><span class="co">    Load Walmart data and prepare it for a specific store.</span></span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a><span class="co">    filepath : str, path to the CSV file</span></span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a><span class="co">    store_id : int, store ID to extract</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a><span class="co">    test_weeks : int, number of weeks to reserve for testing</span></span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame, training data</span></span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a><span class="co">    test_df : DataFrame, testing data</span></span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a><span class="co">    df_full : DataFrame, complete data for reference</span></span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"STEP 2: LOADING DATA FOR STORE </span><span class="sc">{</span>store_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for specific store</span></span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">'Store'</span>] <span class="op">==</span> store_id].copy()</span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert Date to datetime</span></span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>])</span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date</span></span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">'Date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle negative sales</span></span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"Weekly_Sales"</span>] <span class="op">=</span> df[<span class="st">"Weekly_Sales"</span>].where(df[<span class="st">"Weekly_Sales"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to store level (sum across all departments)</span></span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a>    df_store <span class="op">=</span> df.groupby(<span class="st">'Date'</span>).agg({</span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Weekly_Sales'</span>: <span class="st">'sum'</span>,</span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">'IsHoliday'</span>: <span class="st">'first'</span></span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add time features</span></span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Year'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.year</span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Month'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.month</span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Week'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.isocalendar().week</span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" Data loaded successfully!"</span>)</span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-141"><a href="#cb42-141" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_store)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-142"><a href="#cb42-142" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  First day of week: </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-143"><a href="#cb42-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-144"><a href="#cb42-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split into train and test</span></span>
<span id="cb42-145"><a href="#cb42-145" aria-hidden="true" tabindex="-1"></a>    split_point <span class="op">=</span> <span class="bu">len</span>(df_store) <span class="op">-</span> test_weeks</span>
<span id="cb42-146"><a href="#cb42-146" aria-hidden="true" tabindex="-1"></a>    train_df <span class="op">=</span> df_store.iloc[:split_point].copy()</span>
<span id="cb42-147"><a href="#cb42-147" aria-hidden="true" tabindex="-1"></a>    test_df <span class="op">=</span> df_store.iloc[split_point:].copy()</span>
<span id="cb42-148"><a href="#cb42-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-149"><a href="#cb42-149" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Data split:"</span>)</span>
<span id="cb42-150"><a href="#cb42-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Training: </span><span class="sc">{</span><span class="bu">len</span>(train_df)<span class="sc">}</span><span class="ss"> weeks (</span><span class="sc">{</span>train_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>train_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb42-151"><a href="#cb42-151" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Testing:  </span><span class="sc">{</span><span class="bu">len</span>(test_df)<span class="sc">}</span><span class="ss"> weeks (</span><span class="sc">{</span>test_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>test_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb42-152"><a href="#cb42-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-153"><a href="#cb42-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic statistics</span></span>
<span id="cb42-154"><a href="#cb42-154" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Training data statistics:"</span>)</span>
<span id="cb42-155"><a href="#cb42-155" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean:   </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span>mean()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-156"><a href="#cb42-156" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Std:    </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span>std()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-157"><a href="#cb42-157" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Min:    </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-158"><a href="#cb42-158" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Max:    </span><span class="sc">{</span>train_df[<span class="st">'Weekly_Sales'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-159"><a href="#cb42-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-160"><a href="#cb42-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_df, test_df, df_store</span>
<span id="cb42-161"><a href="#cb42-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-162"><a href="#cb42-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-163"><a href="#cb42-163" aria-hidden="true" tabindex="-1"></a>train_df,test_df,df_store <span class="op">=</span> load_and_prepare_data(<span class="st">"../data/train.csv"</span>, store_id<span class="op">=</span><span class="dv">2</span>, test_weeks<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb42-164"><a href="#cb42-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-165"><a href="#cb42-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-168"><a href="#cb42-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-169"><a href="#cb42-169" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_training_data(train_df):</span>
<span id="cb42-170"><a href="#cb42-170" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-171"><a href="#cb42-171" aria-hidden="true" tabindex="-1"></a><span class="co">    Create comprehensive visualizations of training data for Jupyter notebook.</span></span>
<span id="cb42-172"><a href="#cb42-172" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-173"><a href="#cb42-173" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-174"><a href="#cb42-174" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-175"><a href="#cb42-175" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with columns ['Date', 'Weekly_Sales', 'Month', 'Year']</span></span>
<span id="cb42-176"><a href="#cb42-176" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-177"><a href="#cb42-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-178"><a href="#cb42-178" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-179"><a href="#cb42-179" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VISUALIZING TRAINING DATA"</span>)</span>
<span id="cb42-180"><a href="#cb42-180" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-181"><a href="#cb42-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-182"><a href="#cb42-182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with subplots</span></span>
<span id="cb42-183"><a href="#cb42-183" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb42-184"><a href="#cb42-184" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">2</span>, hspace<span class="op">=</span><span class="fl">0.3</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-185"><a href="#cb42-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-186"><a href="#cb42-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Complete time series</span></span>
<span id="cb42-187"><a href="#cb42-187" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb42-188"><a href="#cb42-188" aria-hidden="true" tabindex="-1"></a>    ax1.plot(train_df[<span class="st">'Date'</span>], train_df[<span class="st">'Weekly_Sales'</span>], </span>
<span id="cb42-189"><a href="#cb42-189" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, markersize<span class="op">=</span><span class="dv">4</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb42-190"><a href="#cb42-190" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">'Complete Time Series - Training Data'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-191"><a href="#cb42-191" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-192"><a href="#cb42-192" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-193"><a href="#cb42-193" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-194"><a href="#cb42-194" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">3</span>))</span>
<span id="cb42-195"><a href="#cb42-195" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m'</span>))</span>
<span id="cb42-196"><a href="#cb42-196" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax1.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-197"><a href="#cb42-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-198"><a href="#cb42-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add mean line</span></span>
<span id="cb42-199"><a href="#cb42-199" aria-hidden="true" tabindex="-1"></a>    mean_sales <span class="op">=</span> train_df[<span class="st">'Weekly_Sales'</span>].mean()</span>
<span id="cb42-200"><a href="#cb42-200" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(mean_sales, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, </span>
<span id="cb42-201"><a href="#cb42-201" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="ss">f'Mean: $</span><span class="sc">{</span>mean_sales<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb42-202"><a href="#cb42-202" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-203"><a href="#cb42-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-204"><a href="#cb42-204" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Sales by Month (Boxplot)</span></span>
<span id="cb42-205"><a href="#cb42-205" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb42-206"><a href="#cb42-206" aria-hidden="true" tabindex="-1"></a>    month_order <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>))</span>
<span id="cb42-207"><a href="#cb42-207" aria-hidden="true" tabindex="-1"></a>    month_names <span class="op">=</span> [<span class="st">'Jan'</span>, <span class="st">'Feb'</span>, <span class="st">'Mar'</span>, <span class="st">'Apr'</span>, <span class="st">'May'</span>, <span class="st">'Jun'</span>, </span>
<span id="cb42-208"><a href="#cb42-208" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'Jul'</span>, <span class="st">'Aug'</span>, <span class="st">'Sep'</span>, <span class="st">'Oct'</span>, <span class="st">'Nov'</span>, <span class="st">'Dec'</span>]</span>
<span id="cb42-209"><a href="#cb42-209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-210"><a href="#cb42-210" aria-hidden="true" tabindex="-1"></a>    box_data <span class="op">=</span> [train_df[train_df[<span class="st">'Month'</span>] <span class="op">==</span> m][<span class="st">'Weekly_Sales'</span>].values </span>
<span id="cb42-211"><a href="#cb42-211" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> m <span class="kw">in</span> month_order]</span>
<span id="cb42-212"><a href="#cb42-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-213"><a href="#cb42-213" aria-hidden="true" tabindex="-1"></a>    bp <span class="op">=</span> ax2.boxplot(box_data, labels<span class="op">=</span>month_names, patch_artist<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb42-214"><a href="#cb42-214" aria-hidden="true" tabindex="-1"></a>                     boxprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'lightblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb42-215"><a href="#cb42-215" aria-hidden="true" tabindex="-1"></a>                     medianprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb42-216"><a href="#cb42-216" aria-hidden="true" tabindex="-1"></a>                     whiskerprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'gray'</span>),</span>
<span id="cb42-217"><a href="#cb42-217" aria-hidden="true" tabindex="-1"></a>                     capprops<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'gray'</span>))</span>
<span id="cb42-218"><a href="#cb42-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-219"><a href="#cb42-219" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Sales Distribution by Month'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-220"><a href="#cb42-220" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Month'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-221"><a href="#cb42-221" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-222"><a href="#cb42-222" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-223"><a href="#cb42-223" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax2.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-224"><a href="#cb42-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-225"><a href="#cb42-225" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight holiday months</span></span>
<span id="cb42-226"><a href="#cb42-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, month <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="dv">11</span>, <span class="dv">12</span>], start<span class="op">=</span><span class="dv">10</span>):  <span class="co"># Nov=10, Dec=11 (0-indexed)</span></span>
<span id="cb42-227"><a href="#cb42-227" aria-hidden="true" tabindex="-1"></a>        bp[<span class="st">'boxes'</span>][i].set_facecolor(<span class="st">'coral'</span>)</span>
<span id="cb42-228"><a href="#cb42-228" aria-hidden="true" tabindex="-1"></a>        bp[<span class="st">'boxes'</span>][i].set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb42-229"><a href="#cb42-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-230"><a href="#cb42-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Average Sales by Month (Bar Chart)</span></span>
<span id="cb42-231"><a href="#cb42-231" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb42-232"><a href="#cb42-232" aria-hidden="true" tabindex="-1"></a>    monthly_avg <span class="op">=</span> train_df.groupby(<span class="st">'Month'</span>)[<span class="st">'Weekly_Sales'</span>].mean().reindex(month_order)</span>
<span id="cb42-233"><a href="#cb42-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-234"><a href="#cb42-234" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'coral'</span> <span class="cf">if</span> m <span class="kw">in</span> [<span class="dv">11</span>, <span class="dv">12</span>] <span class="cf">else</span> <span class="st">'steelblue'</span> <span class="cf">for</span> m <span class="kw">in</span> month_order]</span>
<span id="cb42-235"><a href="#cb42-235" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax3.bar(month_names, monthly_avg.values, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-236"><a href="#cb42-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-237"><a href="#cb42-237" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Average Sales by Month'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-238"><a href="#cb42-238" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'Month'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-239"><a href="#cb42-239" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Average Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-240"><a href="#cb42-240" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-241"><a href="#cb42-241" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax3.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-242"><a href="#cb42-242" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-243"><a href="#cb42-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels on bars</span></span>
<span id="cb42-244"><a href="#cb42-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb42-245"><a href="#cb42-245" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> bar.get_height()</span>
<span id="cb42-246"><a href="#cb42-246" aria-hidden="true" tabindex="-1"></a>        ax3.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb42-247"><a href="#cb42-247" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'$</span><span class="sc">{</span>height<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss">M'</span>,</span>
<span id="cb42-248"><a href="#cb42-248" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb42-249"><a href="#cb42-249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-250"><a href="#cb42-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Yearly Comparison</span></span>
<span id="cb42-251"><a href="#cb42-251" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb42-252"><a href="#cb42-252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-253"><a href="#cb42-253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">sorted</span>(train_df[<span class="st">'Year'</span>].unique()):</span>
<span id="cb42-254"><a href="#cb42-254" aria-hidden="true" tabindex="-1"></a>        year_data <span class="op">=</span> train_df[train_df[<span class="st">'Year'</span>] <span class="op">==</span> year].copy()</span>
<span id="cb42-255"><a href="#cb42-255" aria-hidden="true" tabindex="-1"></a>        year_data <span class="op">=</span> year_data.sort_values(<span class="st">'Date'</span>)</span>
<span id="cb42-256"><a href="#cb42-256" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-257"><a href="#cb42-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create week of year</span></span>
<span id="cb42-258"><a href="#cb42-258" aria-hidden="true" tabindex="-1"></a>        year_data[<span class="st">'WeekOfYear'</span>] <span class="op">=</span> year_data[<span class="st">'Date'</span>].dt.isocalendar().week</span>
<span id="cb42-259"><a href="#cb42-259" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-260"><a href="#cb42-260" aria-hidden="true" tabindex="-1"></a>        ax4.plot(year_data[<span class="st">'WeekOfYear'</span>], year_data[<span class="st">'Weekly_Sales'</span>], </span>
<span id="cb42-261"><a href="#cb42-261" aria-hidden="true" tabindex="-1"></a>                <span class="st">'o-'</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">4</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-262"><a href="#cb42-262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-263"><a href="#cb42-263" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Sales by Week of Year (Yearly Comparison)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-264"><a href="#cb42-264" aria-hidden="true" tabindex="-1"></a>    ax4.set_xlabel(<span class="st">'Week of Year'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-265"><a href="#cb42-265" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-266"><a href="#cb42-266" aria-hidden="true" tabindex="-1"></a>    ax4.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-267"><a href="#cb42-267" aria-hidden="true" tabindex="-1"></a>    ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-268"><a href="#cb42-268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-269"><a href="#cb42-269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Sales Statistics Table</span></span>
<span id="cb42-270"><a href="#cb42-270" aria-hidden="true" tabindex="-1"></a>    ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb42-271"><a href="#cb42-271" aria-hidden="true" tabindex="-1"></a>    ax5.axis(<span class="st">'off'</span>)</span>
<span id="cb42-272"><a href="#cb42-272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-273"><a href="#cb42-273" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate statistics</span></span>
<span id="cb42-274"><a href="#cb42-274" aria-hidden="true" tabindex="-1"></a>    stats_data <span class="op">=</span> []</span>
<span id="cb42-275"><a href="#cb42-275" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Overall Statistics'</span>, <span class="st">''</span>])</span>
<span id="cb42-276"><a href="#cb42-276" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Mean'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-277"><a href="#cb42-277" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Median'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>median()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-278"><a href="#cb42-278" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Std Dev'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>std()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-279"><a href="#cb42-279" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Min'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-280"><a href="#cb42-280" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Max'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-281"><a href="#cb42-281" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">''</span>, <span class="st">''</span>])</span>
<span id="cb42-282"><a href="#cb42-282" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'By Year'</span>, <span class="st">''</span>])</span>
<span id="cb42-283"><a href="#cb42-283" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-284"><a href="#cb42-284" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">sorted</span>(train_df[<span class="st">'Year'</span>].unique()):</span>
<span id="cb42-285"><a href="#cb42-285" aria-hidden="true" tabindex="-1"></a>        year_data <span class="op">=</span> train_df[train_df[<span class="st">'Year'</span>] <span class="op">==</span> year]</span>
<span id="cb42-286"><a href="#cb42-286" aria-hidden="true" tabindex="-1"></a>        stats_data.append([<span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> Mean'</span>, <span class="ss">f'$</span><span class="sc">{</span>year_data[<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-287"><a href="#cb42-287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-288"><a href="#cb42-288" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">''</span>, <span class="st">''</span>])</span>
<span id="cb42-289"><a href="#cb42-289" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Seasonality'</span>, <span class="st">''</span>])</span>
<span id="cb42-290"><a href="#cb42-290" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Nov-Dec Avg'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[train_df[<span class="st">"Month"</span>].isin([<span class="dv">11</span>,<span class="dv">12</span>])][<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-291"><a href="#cb42-291" aria-hidden="true" tabindex="-1"></a>    stats_data.append([<span class="st">'Other Months Avg'</span>, <span class="ss">f'$</span><span class="sc">{</span>train_df[<span class="op">~</span>train_df[<span class="st">"Month"</span>].isin([<span class="dv">11</span>,<span class="dv">12</span>])][<span class="st">"Weekly_Sales"</span>]<span class="sc">.</span>mean()<span class="sc">:,.0f}</span><span class="ss">'</span>])</span>
<span id="cb42-292"><a href="#cb42-292" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-293"><a href="#cb42-293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table</span></span>
<span id="cb42-294"><a href="#cb42-294" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax5.table(cellText<span class="op">=</span>stats_data, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb42-295"><a href="#cb42-295" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb42-296"><a href="#cb42-296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-297"><a href="#cb42-297" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb42-298"><a href="#cb42-298" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb42-299"><a href="#cb42-299" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb42-300"><a href="#cb42-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-301"><a href="#cb42-301" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style the table</span></span>
<span id="cb42-302"><a href="#cb42-302" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(stats_data)):</span>
<span id="cb42-303"><a href="#cb42-303" aria-hidden="true" tabindex="-1"></a>        cell <span class="op">=</span> table[(i, <span class="dv">0</span>)]</span>
<span id="cb42-304"><a href="#cb42-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stats_data[i][<span class="dv">0</span>] <span class="kw">in</span> [<span class="st">'Overall Statistics'</span>, <span class="st">'By Year'</span>, <span class="st">'Seasonality'</span>]:</span>
<span id="cb42-305"><a href="#cb42-305" aria-hidden="true" tabindex="-1"></a>            cell.set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb42-306"><a href="#cb42-306" aria-hidden="true" tabindex="-1"></a>            cell.set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb42-307"><a href="#cb42-307" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb42-308"><a href="#cb42-308" aria-hidden="true" tabindex="-1"></a>            cell.set_facecolor(<span class="st">'#E7E6E6'</span> <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'white'</span>)</span>
<span id="cb42-309"><a href="#cb42-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-310"><a href="#cb42-310" aria-hidden="true" tabindex="-1"></a>    ax5.set_title(<span class="st">'Summary Statistics'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb42-311"><a href="#cb42-311" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-312"><a href="#cb42-312" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="ss">f'Training Data Analysis (</span><span class="sc">{</span>train_df[<span class="st">"Date"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>train_df[<span class="st">"Date"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)<span class="sc">}</span><span class="ss">)'</span>,</span>
<span id="cb42-313"><a href="#cb42-313" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb42-314"><a href="#cb42-314" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-315"><a href="#cb42-315" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-316"><a href="#cb42-316" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-317"><a href="#cb42-317" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-318"><a href="#cb42-318" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Visualization complete!"</span>)</span>
<span id="cb42-319"><a href="#cb42-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-320"><a href="#cb42-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-321"><a href="#cb42-321" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_monthly_breakdown(train_df):</span>
<span id="cb42-322"><a href="#cb42-322" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-323"><a href="#cb42-323" aria-hidden="true" tabindex="-1"></a><span class="co">    Create individual plots for each month across all years.</span></span>
<span id="cb42-324"><a href="#cb42-324" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-325"><a href="#cb42-325" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-326"><a href="#cb42-326" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-327"><a href="#cb42-327" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with training data</span></span>
<span id="cb42-328"><a href="#cb42-328" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-329"><a href="#cb42-329" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-330"><a href="#cb42-330" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-331"><a href="#cb42-331" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CREATING MONTHLY BREAKDOWN"</span>)</span>
<span id="cb42-332"><a href="#cb42-332" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-333"><a href="#cb42-333" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-334"><a href="#cb42-334" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with 12 subplots (one per month)</span></span>
<span id="cb42-335"><a href="#cb42-335" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">16</span>))</span>
<span id="cb42-336"><a href="#cb42-336" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.flatten()</span>
<span id="cb42-337"><a href="#cb42-337" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-338"><a href="#cb42-338" aria-hidden="true" tabindex="-1"></a>    month_names <span class="op">=</span> [<span class="st">'January'</span>, <span class="st">'February'</span>, <span class="st">'March'</span>, <span class="st">'April'</span>, <span class="st">'May'</span>, <span class="st">'June'</span>,</span>
<span id="cb42-339"><a href="#cb42-339" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'July'</span>, <span class="st">'August'</span>, <span class="st">'September'</span>, <span class="st">'October'</span>, <span class="st">'November'</span>, <span class="st">'December'</span>]</span>
<span id="cb42-340"><a href="#cb42-340" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-341"><a href="#cb42-341" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month_num, (ax, month_name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(axes, month_names), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb42-342"><a href="#cb42-342" aria-hidden="true" tabindex="-1"></a>        month_data <span class="op">=</span> train_df[train_df[<span class="st">'Month'</span>] <span class="op">==</span> month_num].copy()</span>
<span id="cb42-343"><a href="#cb42-343" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-344"><a href="#cb42-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(month_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb42-345"><a href="#cb42-345" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Group by year for this month</span></span>
<span id="cb42-346"><a href="#cb42-346" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">sorted</span>(month_data[<span class="st">'Year'</span>].unique()):</span>
<span id="cb42-347"><a href="#cb42-347" aria-hidden="true" tabindex="-1"></a>                year_month_data <span class="op">=</span> month_data[month_data[<span class="st">'Year'</span>] <span class="op">==</span> year].sort_values(<span class="st">'Date'</span>)</span>
<span id="cb42-348"><a href="#cb42-348" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-349"><a href="#cb42-349" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Use day of month for x-axis</span></span>
<span id="cb42-350"><a href="#cb42-350" aria-hidden="true" tabindex="-1"></a>                year_month_data[<span class="st">'Day'</span>] <span class="op">=</span> year_month_data[<span class="st">'Date'</span>].dt.day</span>
<span id="cb42-351"><a href="#cb42-351" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-352"><a href="#cb42-352" aria-hidden="true" tabindex="-1"></a>                ax.plot(year_month_data[<span class="st">'Day'</span>], year_month_data[<span class="st">'Weekly_Sales'</span>],</span>
<span id="cb42-353"><a href="#cb42-353" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'o-'</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-354"><a href="#cb42-354" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-355"><a href="#cb42-355" aria-hidden="true" tabindex="-1"></a>            ax.set_title(month_name, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-356"><a href="#cb42-356" aria-hidden="true" tabindex="-1"></a>            ax.set_xlabel(<span class="st">'Day of Month'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-357"><a href="#cb42-357" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-358"><a href="#cb42-358" aria-hidden="true" tabindex="-1"></a>            ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb42-359"><a href="#cb42-359" aria-hidden="true" tabindex="-1"></a>            ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-360"><a href="#cb42-360" aria-hidden="true" tabindex="-1"></a>            ax.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-361"><a href="#cb42-361" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-362"><a href="#cb42-362" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Format y-axis</span></span>
<span id="cb42-363"><a href="#cb42-363" aria-hidden="true" tabindex="-1"></a>            ax.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'$</span><span class="sc">{</span>x<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.1f}</span><span class="ss">M'</span>))</span>
<span id="cb42-364"><a href="#cb42-364" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb42-365"><a href="#cb42-365" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Highlight if holiday month</span></span>
<span id="cb42-366"><a href="#cb42-366" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> month_num <span class="kw">in</span> [<span class="dv">11</span>, <span class="dv">12</span>]:</span>
<span id="cb42-367"><a href="#cb42-367" aria-hidden="true" tabindex="-1"></a>                ax.set_facecolor(<span class="st">'#fff4e6'</span>)</span>
<span id="cb42-368"><a href="#cb42-368" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb42-369"><a href="#cb42-369" aria-hidden="true" tabindex="-1"></a>            ax.text(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">'No Data'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb42-370"><a href="#cb42-370" aria-hidden="true" tabindex="-1"></a>                   transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-371"><a href="#cb42-371" aria-hidden="true" tabindex="-1"></a>            ax.set_xticks([])</span>
<span id="cb42-372"><a href="#cb42-372" aria-hidden="true" tabindex="-1"></a>            ax.set_yticks([])</span>
<span id="cb42-373"><a href="#cb42-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-374"><a href="#cb42-374" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="ss">f'Monthly Sales Breakdown - All Years'</span>, </span>
<span id="cb42-375"><a href="#cb42-375" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb42-376"><a href="#cb42-376" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-377"><a href="#cb42-377" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-378"><a href="#cb42-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-379"><a href="#cb42-379" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Monthly breakdown complete!"</span>)</span>
<span id="cb42-380"><a href="#cb42-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-381"><a href="#cb42-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-382"><a href="#cb42-382" aria-hidden="true" tabindex="-1"></a>visualize_training_data(train_df)</span>
<span id="cb42-383"><a href="#cb42-383" aria-hidden="true" tabindex="-1"></a>plot_monthly_breakdown(train_df)</span>
<span id="cb42-384"><a href="#cb42-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-385"><a href="#cb42-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-386"><a href="#cb42-386" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb42-387"><a href="#cb42-387" aria-hidden="true" tabindex="-1"></a>**Notes:**</span>
<span id="cb42-388"><a href="#cb42-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-389"><a href="#cb42-389" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Based on the first image, with the whole time series (and more with the time series grouping by year) help us to undestand that there seems to be clear seasonality on the data, with peaks around the end of each year and lower sales on the middle of the year. There is no clear trend on the data, so we will not need to difference the data for trend removal(however we will test it with the same statistical models we used on part 1, to be sure that our first impression is correct).</span>
<span id="cb42-390"><a href="#cb42-390" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The second image, provide us with a zoomed in version of the months of data(with grouping by year as well), where we can see more clearly the seasonality in every month seperately.</span>
<span id="cb42-391"><a href="#cb42-391" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The table on the first plot, provide us with the main statistics of the data, where we can see that the mean is higher than the median, so there is some positive skewness on the data, which is also visible on the histogram plot.</span>
<span id="cb42-392"><a href="#cb42-392" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>November and December seems to be the months with the highest sales, while January seems to be the month with the lowest sales.</span>
<span id="cb42-393"><a href="#cb42-393" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Based on the mean of each year, we can **not** claim that there is a decreasing trend</span>
<span id="cb42-394"><a href="#cb42-394" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is worth mentioning to take into consideration the last week of November in every year, where there is a clear peak in sales, which is probably due to Black Friday sales.</span>
<span id="cb42-395"><a href="#cb42-395" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>There is clear peak in December, probably due to Christmas sales.</span>
<span id="cb42-396"><a href="#cb42-396" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is worth mentioning that in every month except November, the last week of the month seems to have lower sales than the other weeks of the month.</span>
<span id="cb42-397"><a href="#cb42-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-398"><a href="#cb42-398" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb42-399"><a href="#cb42-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-400"><a href="#cb42-400" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb42-401"><a href="#cb42-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-402"><a href="#cb42-402" aria-hidden="true" tabindex="-1"></a><span class="fu">## Statistical Testing for Trend using run_trend_analysis python script</span></span>
<span id="cb42-403"><a href="#cb42-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-406"><a href="#cb42-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-407"><a href="#cb42-407" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> run_trend_analysis <span class="im">import</span> analyze_series</span>
<span id="cb42-408"><a href="#cb42-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-409"><a href="#cb42-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Pass only the Weekly_Sales column, not the entire DataFrame</span></span>
<span id="cb42-410"><a href="#cb42-410" aria-hidden="true" tabindex="-1"></a>analyze_series(train_df[<span class="st">'Weekly_Sales'</span>], series_name<span class="op">=</span><span class="st">"Store 1 Training Data"</span>)</span>
<span id="cb42-411"><a href="#cb42-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-412"><a href="#cb42-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-413"><a href="#cb42-413" aria-hidden="true" tabindex="-1"></a>**Statistical Test Results:**</span>
<span id="cb42-414"><a href="#cb42-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-415"><a href="#cb42-415" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>6 different trend tests performed (ADF, KPSS, Mann-Kendall, Linear Regression, Cox-Stuart, Spearman)</span>
<span id="cb42-416"><a href="#cb42-416" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Conclusion**: No significant trend detected (p-values indicate stationarity)</span>
<span id="cb42-417"><a href="#cb42-417" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Implication**: We set Î²=0 in our Holt-Winters model</span>
<span id="cb42-418"><a href="#cb42-418" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Justification**: Data shows strong seasonality but no systematic growth/decline over time</span>
<span id="cb42-419"><a href="#cb42-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-420"><a href="#cb42-420" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb42-421"><a href="#cb42-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-422"><a href="#cb42-422" aria-hidden="true" tabindex="-1"></a><span class="fu"># Question 1 {#sec-question1}</span></span>
<span id="cb42-423"><a href="#cb42-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-424"><a href="#cb42-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting TES and grid searching for parameters</span></span>
<span id="cb42-425"><a href="#cb42-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-426"><a href="#cb42-426" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using Additive Seasonality</span></span>
<span id="cb42-427"><a href="#cb42-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-430"><a href="#cb42-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-431"><a href="#cb42-431" aria-hidden="true" tabindex="-1"></a><span class="co"># OPTIMIZE PARAMETERS AND GENERATE HORIZON-2 FORECASTS</span></span>
<span id="cb42-432"><a href="#cb42-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-433"><a href="#cb42-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Same as in part1</span></span>
<span id="cb42-434"><a href="#cb42-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-435"><a href="#cb42-435" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> TSE(y_true,y_pred):</span>
<span id="cb42-436"><a href="#cb42-436" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>((y_true <span class="op">-</span> y_pred)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb42-437"><a href="#cb42-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-438"><a href="#cb42-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-439"><a href="#cb42-439" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hw_seasonal_no_trend(y,alpha,gamma,m):</span>
<span id="cb42-440"><a href="#cb42-440" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-441"><a href="#cb42-441" aria-hidden="true" tabindex="-1"></a><span class="co">    Holt-Winters Seasonal Method without Trend</span></span>
<span id="cb42-442"><a href="#cb42-442" aria-hidden="true" tabindex="-1"></a><span class="co">    y: time series data</span></span>
<span id="cb42-443"><a href="#cb42-443" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha: level smoothing parameter</span></span>
<span id="cb42-444"><a href="#cb42-444" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma: seasonal smoothing parameter</span></span>
<span id="cb42-445"><a href="#cb42-445" aria-hidden="true" tabindex="-1"></a><span class="co">    m:season length</span></span>
<span id="cb42-446"><a href="#cb42-446" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-447"><a href="#cb42-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-448"><a href="#cb42-448" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span><span class="bu">len</span>(y)</span>
<span id="cb42-449"><a href="#cb42-449" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialization</span></span>
<span id="cb42-450"><a href="#cb42-450" aria-hidden="true" tabindex="-1"></a>    level <span class="op">=</span> np.mean(y[:m])  <span class="co"># Mean of first seasonal cycle</span></span>
<span id="cb42-451"><a href="#cb42-451" aria-hidden="true" tabindex="-1"></a>    seasonals <span class="op">=</span> <span class="bu">list</span>(y[:m] <span class="op">-</span> level)  <span class="co"># Seasonal components for first cycle</span></span>
<span id="cb42-452"><a href="#cb42-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-453"><a href="#cb42-453" aria-hidden="true" tabindex="-1"></a>    fitted <span class="op">=</span> [np.nan]<span class="op">*</span>n</span>
<span id="cb42-454"><a href="#cb42-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-455"><a href="#cb42-455" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(m,n):</span>
<span id="cb42-456"><a href="#cb42-456" aria-hidden="true" tabindex="-1"></a>        fitted[t] <span class="op">=</span> level <span class="op">+</span> seasonals[t <span class="op">-</span>  m]</span>
<span id="cb42-457"><a href="#cb42-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-458"><a href="#cb42-458" aria-hidden="true" tabindex="-1"></a>        new_level <span class="op">=</span> alpha <span class="op">*</span> (y[t] <span class="op">-</span> seasonals[t <span class="op">-</span> m]) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> level</span>
<span id="cb42-459"><a href="#cb42-459" aria-hidden="true" tabindex="-1"></a>        new_seasonal <span class="op">=</span> gamma <span class="op">*</span> (y[t] <span class="op">-</span> new_level) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> gamma) <span class="op">*</span> seasonals[t <span class="op">-</span> m]</span>
<span id="cb42-460"><a href="#cb42-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-461"><a href="#cb42-461" aria-hidden="true" tabindex="-1"></a>        level <span class="op">=</span> new_level</span>
<span id="cb42-462"><a href="#cb42-462" aria-hidden="true" tabindex="-1"></a>        seasonals.append(new_seasonal)</span>
<span id="cb42-463"><a href="#cb42-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-464"><a href="#cb42-464" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(fitted), level, seasonals</span>
<span id="cb42-465"><a href="#cb42-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-466"><a href="#cb42-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-467"><a href="#cb42-467" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_hw_additive(train_df, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb42-468"><a href="#cb42-468" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-469"><a href="#cb42-469" aria-hidden="true" tabindex="-1"></a><span class="co">    Optimize Holt-Winters ADDITIVE model (no trend) for Part 2.</span></span>
<span id="cb42-470"><a href="#cb42-470" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses your existing hw_seasonal_no_trend function.</span></span>
<span id="cb42-471"><a href="#cb42-471" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-472"><a href="#cb42-472" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-473"><a href="#cb42-473" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-474"><a href="#cb42-474" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma)</span></span>
<span id="cb42-475"><a href="#cb42-475" aria-hidden="true" tabindex="-1"></a><span class="co">    best_model : tuple (level, seasonals)</span></span>
<span id="cb42-476"><a href="#cb42-476" aria-hidden="true" tabindex="-1"></a><span class="co">    best_tse : float</span></span>
<span id="cb42-477"><a href="#cb42-477" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-478"><a href="#cb42-478" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-479"><a href="#cb42-479" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-480"><a href="#cb42-480" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMIZING HOLT-WINTERS (ADDITIVE, NO TREND)"</span>)</span>
<span id="cb42-481"><a href="#cb42-481" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-482"><a href="#cb42-482" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-483"><a href="#cb42-483" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> train_df[<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb42-484"><a href="#cb42-484" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb42-485"><a href="#cb42-485" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-486"><a href="#cb42-486" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define parameter ranges</span></span>
<span id="cb42-487"><a href="#cb42-487" aria-hidden="true" tabindex="-1"></a>    alphas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb42-488"><a href="#cb42-488" aria-hidden="true" tabindex="-1"></a>    gammas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb42-489"><a href="#cb42-489" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-490"><a href="#cb42-490" aria-hidden="true" tabindex="-1"></a>    best_tse <span class="op">=</span> np.inf</span>
<span id="cb42-491"><a href="#cb42-491" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> <span class="va">None</span></span>
<span id="cb42-492"><a href="#cb42-492" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb42-493"><a href="#cb42-493" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-494"><a href="#cb42-494" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training data: </span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb42-495"><a href="#cb42-495" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="sc">}</span><span class="ss"> Ã— </span><span class="sc">{</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="op">*</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> combinations..."</span>)</span>
<span id="cb42-496"><a href="#cb42-496" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-497"><a href="#cb42-497" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid search</span></span>
<span id="cb42-498"><a href="#cb42-498" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb42-499"><a href="#cb42-499" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gamma <span class="kw">in</span> gammas:</span>
<span id="cb42-500"><a href="#cb42-500" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb42-501"><a href="#cb42-501" aria-hidden="true" tabindex="-1"></a>                fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend(y_train, alpha, gamma, m)</span>
<span id="cb42-502"><a href="#cb42-502" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-503"><a href="#cb42-503" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate TSE on valid data</span></span>
<span id="cb42-504"><a href="#cb42-504" aria-hidden="true" tabindex="-1"></a>                valid_idx <span class="op">=</span> <span class="op">~</span>np.isnan(fitted)</span>
<span id="cb42-505"><a href="#cb42-505" aria-hidden="true" tabindex="-1"></a>                tse <span class="op">=</span> TSE(y_train[valid_idx], fitted[valid_idx])</span>
<span id="cb42-506"><a href="#cb42-506" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-507"><a href="#cb42-507" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> tse <span class="op">&lt;</span> best_tse:</span>
<span id="cb42-508"><a href="#cb42-508" aria-hidden="true" tabindex="-1"></a>                    best_tse <span class="op">=</span> tse</span>
<span id="cb42-509"><a href="#cb42-509" aria-hidden="true" tabindex="-1"></a>                    best_params <span class="op">=</span> (alpha, gamma)</span>
<span id="cb42-510"><a href="#cb42-510" aria-hidden="true" tabindex="-1"></a>                    best_model <span class="op">=</span> (level, seasonals)</span>
<span id="cb42-511"><a href="#cb42-511" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb42-512"><a href="#cb42-512" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb42-513"><a href="#cb42-513" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-514"><a href="#cb42-514" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Optimization complete!"</span>)</span>
<span id="cb42-515"><a href="#cb42-515" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-516"><a href="#cb42-516" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMAL PARAMETERS"</span>)</span>
<span id="cb42-517"><a href="#cb42-517" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-518"><a href="#cb42-518" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î± (level):    </span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb42-519"><a href="#cb42-519" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î³ (seasonal): </span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb42-520"><a href="#cb42-520" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î² (trend):    0.000 (fixed, no trend)"</span>)</span>
<span id="cb42-521"><a href="#cb42-521" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training TSE: </span><span class="sc">{</span>best_tse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-522"><a href="#cb42-522" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training RMSE: </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(best_tse<span class="op">/</span><span class="bu">len</span>(y_train))<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-523"><a href="#cb42-523" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-524"><a href="#cb42-524" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_params, best_model, best_tse</span>
<span id="cb42-525"><a href="#cb42-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-526"><a href="#cb42-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-527"><a href="#cb42-527" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_horizon2_forecasts_hw(train_df, test_df, best_params, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb42-528"><a href="#cb42-528" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-529"><a href="#cb42-529" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate HORIZON-2 forecasts for test period using Holt-Winters.</span></span>
<span id="cb42-530"><a href="#cb42-530" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-531"><a href="#cb42-531" aria-hidden="true" tabindex="-1"></a><span class="co">    This is different from Part 1:</span></span>
<span id="cb42-532"><a href="#cb42-532" aria-hidden="true" tabindex="-1"></a><span class="co">    - Part 1: horizon-1 (one week ahead)</span></span>
<span id="cb42-533"><a href="#cb42-533" aria-hidden="true" tabindex="-1"></a><span class="co">    - Part 2: horizon-2 (TWO weeks ahead)</span></span>
<span id="cb42-534"><a href="#cb42-534" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-535"><a href="#cb42-535" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-536"><a href="#cb42-536" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-537"><a href="#cb42-537" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with training data</span></span>
<span id="cb42-538"><a href="#cb42-538" aria-hidden="true" tabindex="-1"></a><span class="co">    test_df : DataFrame with test data  </span></span>
<span id="cb42-539"><a href="#cb42-539" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma) from optimization</span></span>
<span id="cb42-540"><a href="#cb42-540" aria-hidden="true" tabindex="-1"></a><span class="co">    season_length : int, 52 for weekly data</span></span>
<span id="cb42-541"><a href="#cb42-541" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-542"><a href="#cb42-542" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-543"><a href="#cb42-543" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-544"><a href="#cb42-544" aria-hidden="true" tabindex="-1"></a><span class="co">    results_df : DataFrame with Date, Actual, Forecast_H2</span></span>
<span id="cb42-545"><a href="#cb42-545" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics : dict with MAE, MAPE, RMSE</span></span>
<span id="cb42-546"><a href="#cb42-546" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-547"><a href="#cb42-547" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-548"><a href="#cb42-548" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-549"><a href="#cb42-549" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GENERATING HORIZON-2 FORECASTS FOR TEST SET"</span>)</span>
<span id="cb42-550"><a href="#cb42-550" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-551"><a href="#cb42-551" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-552"><a href="#cb42-552" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb42-553"><a href="#cb42-553" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb42-554"><a href="#cb42-554" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-555"><a href="#cb42-555" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine train and test</span></span>
<span id="cb42-556"><a href="#cb42-556" aria-hidden="true" tabindex="-1"></a>    full_data <span class="op">=</span> pd.concat([train_df, test_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-557"><a href="#cb42-557" aria-hidden="true" tabindex="-1"></a>    split_point <span class="op">=</span> <span class="bu">len</span>(train_df)</span>
<span id="cb42-558"><a href="#cb42-558" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-559"><a href="#cb42-559" aria-hidden="true" tabindex="-1"></a>    forecasts_h2 <span class="op">=</span> []</span>
<span id="cb42-560"><a href="#cb42-560" aria-hidden="true" tabindex="-1"></a>    actuals <span class="op">=</span> []</span>
<span id="cb42-561"><a href="#cb42-561" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb42-562"><a href="#cb42-562" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-563"><a href="#cb42-563" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generating horizon-2 forecasts for </span><span class="sc">{</span><span class="bu">len</span>(test_df)<span class="sc">}</span><span class="ss"> test weeks..."</span>)</span>
<span id="cb42-564"><a href="#cb42-564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-565"><a href="#cb42-565" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(test_df)):</span>
<span id="cb42-566"><a href="#cb42-566" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use data up to current point (including i weeks of test data)</span></span>
<span id="cb42-567"><a href="#cb42-567" aria-hidden="true" tabindex="-1"></a>        current_data <span class="op">=</span> full_data.iloc[:split_point <span class="op">+</span> i][<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb42-568"><a href="#cb42-568" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-569"><a href="#cb42-569" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit model</span></span>
<span id="cb42-570"><a href="#cb42-570" aria-hidden="true" tabindex="-1"></a>        fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend(current_data, alpha_best, gamma_best, m)</span>
<span id="cb42-571"><a href="#cb42-571" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-572"><a href="#cb42-572" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate 2-week ahead forecast</span></span>
<span id="cb42-573"><a href="#cb42-573" aria-hidden="true" tabindex="-1"></a>        seasonals <span class="op">=</span> np.array(seasonals)</span>
<span id="cb42-574"><a href="#cb42-574" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-575"><a href="#cb42-575" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Horizon-2 forecast (2 weeks ahead)</span></span>
<span id="cb42-576"><a href="#cb42-576" aria-hidden="true" tabindex="-1"></a>        seasonal_index_h2 <span class="op">=</span> <span class="bu">len</span>(seasonals) <span class="op">-</span> m <span class="op">+</span> <span class="dv">1</span>  <span class="co"># +1 for horizon-2</span></span>
<span id="cb42-577"><a href="#cb42-577" aria-hidden="true" tabindex="-1"></a>        forecast_h2 <span class="op">=</span> level <span class="op">+</span> seasonals[seasonal_index_h2]</span>
<span id="cb42-578"><a href="#cb42-578" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-579"><a href="#cb42-579" aria-hidden="true" tabindex="-1"></a>        forecasts_h2.append(forecast_h2)</span>
<span id="cb42-580"><a href="#cb42-580" aria-hidden="true" tabindex="-1"></a>        actuals.append(test_df.iloc[i][<span class="st">'Weekly_Sales'</span>])</span>
<span id="cb42-581"><a href="#cb42-581" aria-hidden="true" tabindex="-1"></a>        dates.append(test_df.iloc[i][<span class="st">'Date'</span>])</span>
<span id="cb42-582"><a href="#cb42-582" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-583"><a href="#cb42-583" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results dataframe</span></span>
<span id="cb42-584"><a href="#cb42-584" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb42-585"><a href="#cb42-585" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Date'</span>: dates,</span>
<span id="cb42-586"><a href="#cb42-586" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: actuals,</span>
<span id="cb42-587"><a href="#cb42-587" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: forecasts_h2</span>
<span id="cb42-588"><a href="#cb42-588" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-589"><a href="#cb42-589" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-590"><a href="#cb42-590" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb42-591"><a href="#cb42-591" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]))</span>
<span id="cb42-592"><a href="#cb42-592" aria-hidden="true" tabindex="-1"></a>    mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]) <span class="op">/</span> results_df[<span class="st">'Actual'</span>])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-593"><a href="#cb42-593" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(np.mean((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb42-594"><a href="#cb42-594" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-595"><a href="#cb42-595" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {</span>
<span id="cb42-596"><a href="#cb42-596" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAE'</span>: mae,</span>
<span id="cb42-597"><a href="#cb42-597" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAPE'</span>: mape,</span>
<span id="cb42-598"><a href="#cb42-598" aria-hidden="true" tabindex="-1"></a>        <span class="st">'RMSE'</span>: rmse</span>
<span id="cb42-599"><a href="#cb42-599" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-600"><a href="#cb42-600" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-601"><a href="#cb42-601" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Horizon-2 forecasts generated!"</span>)</span>
<span id="cb42-602"><a href="#cb42-602" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-603"><a href="#cb42-603" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HORIZON-2 FORECAST ACCURACY (TEST SET)"</span>)</span>
<span id="cb42-604"><a href="#cb42-604" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-605"><a href="#cb42-605" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE:  $</span><span class="sc">{</span>mae<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-606"><a href="#cb42-606" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAPE: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-607"><a href="#cb42-607" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  RMSE: $</span><span class="sc">{</span>rmse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-608"><a href="#cb42-608" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-609"><a href="#cb42-609" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df, metrics</span>
<span id="cb42-610"><a href="#cb42-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-611"><a href="#cb42-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-612"><a href="#cb42-612" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_horizon2_results(results_df, best_params):</span>
<span id="cb42-613"><a href="#cb42-613" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-614"><a href="#cb42-614" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize horizon-2 forecast results.</span></span>
<span id="cb42-615"><a href="#cb42-615" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-616"><a href="#cb42-616" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb42-617"><a href="#cb42-617" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-618"><a href="#cb42-618" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb42-619"><a href="#cb42-619" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-620"><a href="#cb42-620" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb42-621"><a href="#cb42-621" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-622"><a href="#cb42-622" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Forecasts vs Actuals</span></span>
<span id="cb42-623"><a href="#cb42-623" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb42-624"><a href="#cb42-624" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_df[<span class="st">'Date'</span>], results_df[<span class="st">'Actual'</span>], </span>
<span id="cb42-625"><a href="#cb42-625" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Actual Sales'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb42-626"><a href="#cb42-626" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'black'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb42-627"><a href="#cb42-627" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_df[<span class="st">'Date'</span>], results_df[<span class="st">'Forecast_H2'</span>], </span>
<span id="cb42-628"><a href="#cb42-628" aria-hidden="true" tabindex="-1"></a>             <span class="st">'s--'</span>, label<span class="op">=</span><span class="st">'Horizon-2 Forecasts'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb42-629"><a href="#cb42-629" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'steelblue'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb42-630"><a href="#cb42-630" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-631"><a href="#cb42-631" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Horizon-2 Forecasts vs Actuals (Test Period)</span><span class="ch">\n</span><span class="ss">Î±=</span><span class="sc">{</span>alpha_best<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>gamma_best<span class="sc">:.3f}</span><span class="ss">, Î²=0.000 (no trend)'</span>, </span>
<span id="cb42-632"><a href="#cb42-632" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-633"><a href="#cb42-633" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-634"><a href="#cb42-634" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Weekly Sales ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-635"><a href="#cb42-635" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">11</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb42-636"><a href="#cb42-636" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-637"><a href="#cb42-637" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb42-638"><a href="#cb42-638" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax1.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-639"><a href="#cb42-639" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-640"><a href="#cb42-640" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add error bands</span></span>
<span id="cb42-641"><a href="#cb42-641" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(results_df)):</span>
<span id="cb42-642"><a href="#cb42-642" aria-hidden="true" tabindex="-1"></a>        ax1.plot([results_df[<span class="st">'Date'</span>].iloc[i], results_df[<span class="st">'Date'</span>].iloc[i]], </span>
<span id="cb42-643"><a href="#cb42-643" aria-hidden="true" tabindex="-1"></a>                [results_df[<span class="st">'Actual'</span>].iloc[i], results_df[<span class="st">'Forecast_H2'</span>].iloc[i]],</span>
<span id="cb42-644"><a href="#cb42-644" aria-hidden="true" tabindex="-1"></a>                <span class="st">'r--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-645"><a href="#cb42-645" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-646"><a href="#cb42-646" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: Errors</span></span>
<span id="cb42-647"><a href="#cb42-647" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb42-648"><a href="#cb42-648" aria-hidden="true" tabindex="-1"></a>    errors <span class="op">=</span> results_df[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> results_df[<span class="st">'Actual'</span>]</span>
<span id="cb42-649"><a href="#cb42-649" aria-hidden="true" tabindex="-1"></a>    abs_errors <span class="op">=</span> np.<span class="bu">abs</span>(errors)</span>
<span id="cb42-650"><a href="#cb42-650" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-651"><a href="#cb42-651" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> e <span class="op">&gt;=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> e <span class="kw">in</span> errors]</span>
<span id="cb42-652"><a href="#cb42-652" aria-hidden="true" tabindex="-1"></a>    ax2.bar(results_df[<span class="st">'Date'</span>], errors, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.6</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-653"><a href="#cb42-653" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, linestyle<span class="op">=</span><span class="st">'-'</span>)</span>
<span id="cb42-654"><a href="#cb42-654" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-655"><a href="#cb42-655" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Forecast Errors (Forecast - Actual)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-656"><a href="#cb42-656" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-657"><a href="#cb42-657" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Error ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-658"><a href="#cb42-658" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-659"><a href="#cb42-659" aria-hidden="true" tabindex="-1"></a>    ax2.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb42-660"><a href="#cb42-660" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax2.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-661"><a href="#cb42-661" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-662"><a href="#cb42-662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add mean absolute error line</span></span>
<span id="cb42-663"><a href="#cb42-663" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> np.mean(abs_errors)</span>
<span id="cb42-664"><a href="#cb42-664" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(mae, color<span class="op">=</span><span class="st">'blue'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb42-665"><a href="#cb42-665" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'MAE = $</span><span class="sc">{</span>mae<span class="sc">:,.0f}</span><span class="ss">'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-666"><a href="#cb42-666" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="op">-</span>mae, color<span class="op">=</span><span class="st">'blue'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-667"><a href="#cb42-667" aria-hidden="true" tabindex="-1"></a>    ax2.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-668"><a href="#cb42-668" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-669"><a href="#cb42-669" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-670"><a href="#cb42-670" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-671"><a href="#cb42-671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-672"><a href="#cb42-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-673"><a href="#cb42-673" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiplicative Seasonality</span></span>
<span id="cb42-674"><a href="#cb42-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-677"><a href="#cb42-677" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-678"><a href="#cb42-678" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hw_seasonal_no_trend_multiplicative(y, alpha, gamma, m):</span>
<span id="cb42-679"><a href="#cb42-679" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-680"><a href="#cb42-680" aria-hidden="true" tabindex="-1"></a><span class="co">    Holt-Winters Seasonal Method without Trend - Multiplicative Seasonality</span></span>
<span id="cb42-681"><a href="#cb42-681" aria-hidden="true" tabindex="-1"></a><span class="co">    y: time series data</span></span>
<span id="cb42-682"><a href="#cb42-682" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha: level smoothing parameter</span></span>
<span id="cb42-683"><a href="#cb42-683" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma: seasonal smoothing parameter</span></span>
<span id="cb42-684"><a href="#cb42-684" aria-hidden="true" tabindex="-1"></a><span class="co">    m: season length</span></span>
<span id="cb42-685"><a href="#cb42-685" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-686"><a href="#cb42-686" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-687"><a href="#cb42-687" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(y)</span>
<span id="cb42-688"><a href="#cb42-688" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-689"><a href="#cb42-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialization</span></span>
<span id="cb42-690"><a href="#cb42-690" aria-hidden="true" tabindex="-1"></a>    level <span class="op">=</span> np.mean(y[:m])</span>
<span id="cb42-691"><a href="#cb42-691" aria-hidden="true" tabindex="-1"></a>    seasonals <span class="op">=</span> <span class="bu">list</span>(y[:m] <span class="op">/</span> level)  <span class="co"># Multiplicative: divide instead of subtract</span></span>
<span id="cb42-692"><a href="#cb42-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-693"><a href="#cb42-693" aria-hidden="true" tabindex="-1"></a>    fitted <span class="op">=</span> [np.nan] <span class="op">*</span> n</span>
<span id="cb42-694"><a href="#cb42-694" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-695"><a href="#cb42-695" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(m, n):</span>
<span id="cb42-696"><a href="#cb42-696" aria-hidden="true" tabindex="-1"></a>        fitted[t] <span class="op">=</span> level <span class="op">*</span> seasonals[t <span class="op">-</span> m]  <span class="co"># Multiplicative: multiply instead of add</span></span>
<span id="cb42-697"><a href="#cb42-697" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-698"><a href="#cb42-698" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update level (deseasonalize by dividing)</span></span>
<span id="cb42-699"><a href="#cb42-699" aria-hidden="true" tabindex="-1"></a>        new_level <span class="op">=</span> alpha <span class="op">*</span> (y[t] <span class="op">/</span> seasonals[t <span class="op">-</span> m]) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> level</span>
<span id="cb42-700"><a href="#cb42-700" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-701"><a href="#cb42-701" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update seasonal component (ratio)</span></span>
<span id="cb42-702"><a href="#cb42-702" aria-hidden="true" tabindex="-1"></a>        new_seasonal <span class="op">=</span> gamma <span class="op">*</span> (y[t] <span class="op">/</span> new_level) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> gamma) <span class="op">*</span> seasonals[t <span class="op">-</span> m]</span>
<span id="cb42-703"><a href="#cb42-703" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-704"><a href="#cb42-704" aria-hidden="true" tabindex="-1"></a>        level <span class="op">=</span> new_level</span>
<span id="cb42-705"><a href="#cb42-705" aria-hidden="true" tabindex="-1"></a>        seasonals.append(new_seasonal)</span>
<span id="cb42-706"><a href="#cb42-706" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-707"><a href="#cb42-707" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(fitted), level, seasonals</span>
<span id="cb42-708"><a href="#cb42-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-709"><a href="#cb42-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-710"><a href="#cb42-710" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-711"><a href="#cb42-711" aria-hidden="true" tabindex="-1"></a><span class="co"># MULTIPLICATIVE VERSION</span></span>
<span id="cb42-712"><a href="#cb42-712" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-713"><a href="#cb42-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-714"><a href="#cb42-714" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_hw_multiplicative(train_df, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb42-715"><a href="#cb42-715" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-716"><a href="#cb42-716" aria-hidden="true" tabindex="-1"></a><span class="co">    Optimize Holt-Winters MULTIPLICATIVE model (no trend) for Part 2.</span></span>
<span id="cb42-717"><a href="#cb42-717" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses your existing hw_seasonal_multiplicative_no_trend function.</span></span>
<span id="cb42-718"><a href="#cb42-718" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-719"><a href="#cb42-719" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-720"><a href="#cb42-720" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-721"><a href="#cb42-721" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma)</span></span>
<span id="cb42-722"><a href="#cb42-722" aria-hidden="true" tabindex="-1"></a><span class="co">    best_model : tuple (level, seasonals)</span></span>
<span id="cb42-723"><a href="#cb42-723" aria-hidden="true" tabindex="-1"></a><span class="co">    best_tse : float</span></span>
<span id="cb42-724"><a href="#cb42-724" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-725"><a href="#cb42-725" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-726"><a href="#cb42-726" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-727"><a href="#cb42-727" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMIZING HOLT-WINTERS (MULTIPLICATIVE, NO TREND)"</span>)</span>
<span id="cb42-728"><a href="#cb42-728" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-729"><a href="#cb42-729" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-730"><a href="#cb42-730" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> train_df[<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb42-731"><a href="#cb42-731" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb42-732"><a href="#cb42-732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-733"><a href="#cb42-733" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define parameter ranges</span></span>
<span id="cb42-734"><a href="#cb42-734" aria-hidden="true" tabindex="-1"></a>    alphas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb42-735"><a href="#cb42-735" aria-hidden="true" tabindex="-1"></a>    gammas <span class="op">=</span> np.arange(<span class="fl">0.05</span>, <span class="fl">1.0</span>, <span class="fl">0.05</span>)</span>
<span id="cb42-736"><a href="#cb42-736" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-737"><a href="#cb42-737" aria-hidden="true" tabindex="-1"></a>    best_tse <span class="op">=</span> np.inf</span>
<span id="cb42-738"><a href="#cb42-738" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> <span class="va">None</span></span>
<span id="cb42-739"><a href="#cb42-739" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb42-740"><a href="#cb42-740" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-741"><a href="#cb42-741" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training data: </span><span class="sc">{</span><span class="bu">len</span>(y_train)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb42-742"><a href="#cb42-742" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Testing </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="sc">}</span><span class="ss"> Ã— </span><span class="sc">{</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span><span class="bu">len</span>(alphas)<span class="op">*</span><span class="bu">len</span>(gammas)<span class="sc">}</span><span class="ss"> combinations..."</span>)</span>
<span id="cb42-743"><a href="#cb42-743" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-744"><a href="#cb42-744" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid search</span></span>
<span id="cb42-745"><a href="#cb42-745" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> alpha <span class="kw">in</span> alphas:</span>
<span id="cb42-746"><a href="#cb42-746" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gamma <span class="kw">in</span> gammas:</span>
<span id="cb42-747"><a href="#cb42-747" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb42-748"><a href="#cb42-748" aria-hidden="true" tabindex="-1"></a>                fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend_multiplicative(</span>
<span id="cb42-749"><a href="#cb42-749" aria-hidden="true" tabindex="-1"></a>                    y_train, alpha, gamma, m</span>
<span id="cb42-750"><a href="#cb42-750" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb42-751"><a href="#cb42-751" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-752"><a href="#cb42-752" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate TSE on valid data</span></span>
<span id="cb42-753"><a href="#cb42-753" aria-hidden="true" tabindex="-1"></a>                valid_idx <span class="op">=</span> <span class="op">~</span>np.isnan(fitted)</span>
<span id="cb42-754"><a href="#cb42-754" aria-hidden="true" tabindex="-1"></a>                tse <span class="op">=</span> TSE(y_train[valid_idx], fitted[valid_idx])</span>
<span id="cb42-755"><a href="#cb42-755" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-756"><a href="#cb42-756" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> tse <span class="op">&lt;</span> best_tse:</span>
<span id="cb42-757"><a href="#cb42-757" aria-hidden="true" tabindex="-1"></a>                    best_tse <span class="op">=</span> tse</span>
<span id="cb42-758"><a href="#cb42-758" aria-hidden="true" tabindex="-1"></a>                    best_params <span class="op">=</span> (alpha, gamma)</span>
<span id="cb42-759"><a href="#cb42-759" aria-hidden="true" tabindex="-1"></a>                    best_model <span class="op">=</span> (level, seasonals)</span>
<span id="cb42-760"><a href="#cb42-760" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb42-761"><a href="#cb42-761" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb42-762"><a href="#cb42-762" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-763"><a href="#cb42-763" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">âœ“ Optimization complete!"</span>)</span>
<span id="cb42-764"><a href="#cb42-764" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-765"><a href="#cb42-765" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMAL PARAMETERS"</span>)</span>
<span id="cb42-766"><a href="#cb42-766" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-767"><a href="#cb42-767" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î± (level):    </span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb42-768"><a href="#cb42-768" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î³ (seasonal): </span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb42-769"><a href="#cb42-769" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Î² (trend):    0.000 (fixed, no trend)"</span>)</span>
<span id="cb42-770"><a href="#cb42-770" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Training TSE: </span><span class="sc">{</span>best_tse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-771"><a href="#cb42-771" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training RMSE: </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(best_tse<span class="op">/</span><span class="bu">len</span>(y_train))<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-772"><a href="#cb42-772" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-773"><a href="#cb42-773" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_params, best_model, best_tse</span>
<span id="cb42-774"><a href="#cb42-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-775"><a href="#cb42-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-776"><a href="#cb42-776" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_horizon2_forecasts_multiplicative(train_df, test_df, best_params, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb42-777"><a href="#cb42-777" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-778"><a href="#cb42-778" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate HORIZON-2 forecasts using MULTIPLICATIVE seasonality.</span></span>
<span id="cb42-779"><a href="#cb42-779" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-780"><a href="#cb42-780" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-781"><a href="#cb42-781" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-782"><a href="#cb42-782" aria-hidden="true" tabindex="-1"></a><span class="co">    train_df : DataFrame with training data</span></span>
<span id="cb42-783"><a href="#cb42-783" aria-hidden="true" tabindex="-1"></a><span class="co">    test_df : DataFrame with test data  </span></span>
<span id="cb42-784"><a href="#cb42-784" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma) from optimization</span></span>
<span id="cb42-785"><a href="#cb42-785" aria-hidden="true" tabindex="-1"></a><span class="co">    season_length : int, 52 for weekly data</span></span>
<span id="cb42-786"><a href="#cb42-786" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-787"><a href="#cb42-787" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-788"><a href="#cb42-788" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-789"><a href="#cb42-789" aria-hidden="true" tabindex="-1"></a><span class="co">    results_df : DataFrame with Date, Actual, Forecast_H2</span></span>
<span id="cb42-790"><a href="#cb42-790" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics : dict with MAE, MAPE, RMSE</span></span>
<span id="cb42-791"><a href="#cb42-791" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-792"><a href="#cb42-792" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-793"><a href="#cb42-793" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-794"><a href="#cb42-794" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GENERATING HORIZON-2 FORECASTS (MULTIPLICATIVE)"</span>)</span>
<span id="cb42-795"><a href="#cb42-795" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-796"><a href="#cb42-796" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-797"><a href="#cb42-797" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb42-798"><a href="#cb42-798" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb42-799"><a href="#cb42-799" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-800"><a href="#cb42-800" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine train and test</span></span>
<span id="cb42-801"><a href="#cb42-801" aria-hidden="true" tabindex="-1"></a>    full_data <span class="op">=</span> pd.concat([train_df, test_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-802"><a href="#cb42-802" aria-hidden="true" tabindex="-1"></a>    split_point <span class="op">=</span> <span class="bu">len</span>(train_df)</span>
<span id="cb42-803"><a href="#cb42-803" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-804"><a href="#cb42-804" aria-hidden="true" tabindex="-1"></a>    forecasts_h2 <span class="op">=</span> []</span>
<span id="cb42-805"><a href="#cb42-805" aria-hidden="true" tabindex="-1"></a>    actuals <span class="op">=</span> []</span>
<span id="cb42-806"><a href="#cb42-806" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb42-807"><a href="#cb42-807" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-808"><a href="#cb42-808" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generating horizon-2 forecasts for </span><span class="sc">{</span><span class="bu">len</span>(test_df)<span class="sc">}</span><span class="ss"> test weeks..."</span>)</span>
<span id="cb42-809"><a href="#cb42-809" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-810"><a href="#cb42-810" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(test_df)):</span>
<span id="cb42-811"><a href="#cb42-811" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use data up to current point</span></span>
<span id="cb42-812"><a href="#cb42-812" aria-hidden="true" tabindex="-1"></a>        current_data <span class="op">=</span> full_data.iloc[:split_point <span class="op">+</span> i][<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb42-813"><a href="#cb42-813" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-814"><a href="#cb42-814" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit model</span></span>
<span id="cb42-815"><a href="#cb42-815" aria-hidden="true" tabindex="-1"></a>        fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend_multiplicative(</span>
<span id="cb42-816"><a href="#cb42-816" aria-hidden="true" tabindex="-1"></a>            current_data, alpha_best, gamma_best, m</span>
<span id="cb42-817"><a href="#cb42-817" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-818"><a href="#cb42-818" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-819"><a href="#cb42-819" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate 2-week ahead forecast</span></span>
<span id="cb42-820"><a href="#cb42-820" aria-hidden="true" tabindex="-1"></a>        seasonals <span class="op">=</span> np.array(seasonals)</span>
<span id="cb42-821"><a href="#cb42-821" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-822"><a href="#cb42-822" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Horizon-2 forecast (2 weeks ahead) - MULTIPLICATIVE</span></span>
<span id="cb42-823"><a href="#cb42-823" aria-hidden="true" tabindex="-1"></a>        seasonal_index_h2 <span class="op">=</span> <span class="bu">len</span>(seasonals) <span class="op">-</span> m <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb42-824"><a href="#cb42-824" aria-hidden="true" tabindex="-1"></a>        forecast_h2 <span class="op">=</span> level <span class="op">*</span> seasonals[seasonal_index_h2]  <span class="co"># Multiply instead of add</span></span>
<span id="cb42-825"><a href="#cb42-825" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-826"><a href="#cb42-826" aria-hidden="true" tabindex="-1"></a>        forecasts_h2.append(forecast_h2)</span>
<span id="cb42-827"><a href="#cb42-827" aria-hidden="true" tabindex="-1"></a>        actuals.append(test_df.iloc[i][<span class="st">'Weekly_Sales'</span>])</span>
<span id="cb42-828"><a href="#cb42-828" aria-hidden="true" tabindex="-1"></a>        dates.append(test_df.iloc[i][<span class="st">'Date'</span>])</span>
<span id="cb42-829"><a href="#cb42-829" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-830"><a href="#cb42-830" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results dataframe</span></span>
<span id="cb42-831"><a href="#cb42-831" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb42-832"><a href="#cb42-832" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Date'</span>: dates,</span>
<span id="cb42-833"><a href="#cb42-833" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: actuals,</span>
<span id="cb42-834"><a href="#cb42-834" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: forecasts_h2</span>
<span id="cb42-835"><a href="#cb42-835" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-836"><a href="#cb42-836" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-837"><a href="#cb42-837" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate metrics</span></span>
<span id="cb42-838"><a href="#cb42-838" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]))</span>
<span id="cb42-839"><a href="#cb42-839" aria-hidden="true" tabindex="-1"></a>    mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>]) <span class="op">/</span> results_df[<span class="st">'Actual'</span>])) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-840"><a href="#cb42-840" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(np.mean((results_df[<span class="st">'Actual'</span>] <span class="op">-</span> results_df[<span class="st">'Forecast_H2'</span>])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb42-841"><a href="#cb42-841" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-842"><a href="#cb42-842" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {</span>
<span id="cb42-843"><a href="#cb42-843" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAE'</span>: mae,</span>
<span id="cb42-844"><a href="#cb42-844" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAPE'</span>: mape,</span>
<span id="cb42-845"><a href="#cb42-845" aria-hidden="true" tabindex="-1"></a>        <span class="st">'RMSE'</span>: rmse</span>
<span id="cb42-846"><a href="#cb42-846" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-847"><a href="#cb42-847" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-848"><a href="#cb42-848" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Horizon-2 forecasts generated!"</span>)</span>
<span id="cb42-849"><a href="#cb42-849" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-850"><a href="#cb42-850" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HORIZON-2 FORECAST ACCURACY (TEST SET)"</span>)</span>
<span id="cb42-851"><a href="#cb42-851" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-852"><a href="#cb42-852" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE:  $</span><span class="sc">{</span>mae<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-853"><a href="#cb42-853" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAPE: </span><span class="sc">{</span>mape<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-854"><a href="#cb42-854" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  RMSE: $</span><span class="sc">{</span>rmse<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-855"><a href="#cb42-855" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-856"><a href="#cb42-856" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df, metrics</span>
<span id="cb42-857"><a href="#cb42-857" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-858"><a href="#cb42-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-859"><a href="#cb42-859" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparison</span></span>
<span id="cb42-860"><a href="#cb42-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-863"><a href="#cb42-863" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-864"><a href="#cb42-864" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-865"><a href="#cb42-865" aria-hidden="true" tabindex="-1"></a><span class="co"># COMPARISON FUNCTION</span></span>
<span id="cb42-866"><a href="#cb42-866" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-867"><a href="#cb42-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-868"><a href="#cb42-868" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compare_additive_vs_multiplicative(train_df, test_df, season_length<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb42-869"><a href="#cb42-869" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-870"><a href="#cb42-870" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare Additive vs Multiplicative seasonality models.</span></span>
<span id="cb42-871"><a href="#cb42-871" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-872"><a href="#cb42-872" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-873"><a href="#cb42-873" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-874"><a href="#cb42-874" aria-hidden="true" tabindex="-1"></a><span class="co">    comparison_dict : dict with results for both models</span></span>
<span id="cb42-875"><a href="#cb42-875" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-876"><a href="#cb42-876" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-877"><a href="#cb42-877" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"#"</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-878"><a href="#cb42-878" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"COMPARING ADDITIVE VS MULTIPLICATIVE SEASONALITY"</span>)</span>
<span id="cb42-879"><a href="#cb42-879" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"#"</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-880"><a href="#cb42-880" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-881"><a href="#cb42-881" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== ADDITIVE MODEL =====</span></span>
<span id="cb42-882"><a href="#cb42-882" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-883"><a href="#cb42-883" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL 1: ADDITIVE SEASONALITY"</span>)</span>
<span id="cb42-884"><a href="#cb42-884" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-885"><a href="#cb42-885" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-886"><a href="#cb42-886" aria-hidden="true" tabindex="-1"></a>    params_add, model_add, tse_add <span class="op">=</span> optimize_hw_additive(train_df, season_length)</span>
<span id="cb42-887"><a href="#cb42-887" aria-hidden="true" tabindex="-1"></a>    results_add, metrics_add <span class="op">=</span> generate_horizon2_forecasts_hw(train_df, test_df, params_add, season_length)</span>
<span id="cb42-888"><a href="#cb42-888" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-889"><a href="#cb42-889" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== MULTIPLICATIVE MODEL =====</span></span>
<span id="cb42-890"><a href="#cb42-890" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-891"><a href="#cb42-891" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL 2: MULTIPLICATIVE SEASONALITY"</span>)</span>
<span id="cb42-892"><a href="#cb42-892" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-893"><a href="#cb42-893" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-894"><a href="#cb42-894" aria-hidden="true" tabindex="-1"></a>    params_mult, model_mult, tse_mult <span class="op">=</span> optimize_hw_multiplicative(train_df, season_length)</span>
<span id="cb42-895"><a href="#cb42-895" aria-hidden="true" tabindex="-1"></a>    results_mult, metrics_mult <span class="op">=</span> generate_horizon2_forecasts_multiplicative(train_df, test_df, params_mult, season_length)</span>
<span id="cb42-896"><a href="#cb42-896" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-897"><a href="#cb42-897" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== COMPARISON =====</span></span>
<span id="cb42-898"><a href="#cb42-898" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-899"><a href="#cb42-899" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL COMPARISON SUMMARY"</span>)</span>
<span id="cb42-900"><a href="#cb42-900" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-901"><a href="#cb42-901" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-902"><a href="#cb42-902" aria-hidden="true" tabindex="-1"></a>    comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb42-903"><a href="#cb42-903" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Model'</span>: [<span class="st">'Additive'</span>, <span class="st">'Multiplicative'</span>],</span>
<span id="cb42-904"><a href="#cb42-904" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Î± (level)'</span>: [params_add[<span class="dv">0</span>], params_mult[<span class="dv">0</span>]],</span>
<span id="cb42-905"><a href="#cb42-905" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Î³ (seasonal)'</span>: [params_add[<span class="dv">1</span>], params_mult[<span class="dv">1</span>]],</span>
<span id="cb42-906"><a href="#cb42-906" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Train TSE'</span>: [tse_add, tse_mult],</span>
<span id="cb42-907"><a href="#cb42-907" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Train RMSE'</span>: [np.sqrt(tse_add<span class="op">/</span><span class="bu">len</span>(train_df)), np.sqrt(tse_mult<span class="op">/</span><span class="bu">len</span>(train_df))],</span>
<span id="cb42-908"><a href="#cb42-908" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test MAE'</span>: [metrics_add[<span class="st">'MAE'</span>], metrics_mult[<span class="st">'MAE'</span>]],</span>
<span id="cb42-909"><a href="#cb42-909" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test MAPE'</span>: [metrics_add[<span class="st">'MAPE'</span>], metrics_mult[<span class="st">'MAPE'</span>]],</span>
<span id="cb42-910"><a href="#cb42-910" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Test RMSE'</span>: [metrics_add[<span class="st">'RMSE'</span>], metrics_mult[<span class="st">'RMSE'</span>]]</span>
<span id="cb42-911"><a href="#cb42-911" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-912"><a href="#cb42-912" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-913"><a href="#cb42-913" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> comparison_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb42-914"><a href="#cb42-914" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-915"><a href="#cb42-915" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine winner</span></span>
<span id="cb42-916"><a href="#cb42-916" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> metrics_add[<span class="st">'MAE'</span>] <span class="op">&lt;</span> metrics_mult[<span class="st">'MAE'</span>]:</span>
<span id="cb42-917"><a href="#cb42-917" aria-hidden="true" tabindex="-1"></a>        winner <span class="op">=</span> <span class="st">'ADDITIVE'</span></span>
<span id="cb42-918"><a href="#cb42-918" aria-hidden="true" tabindex="-1"></a>        improvement <span class="op">=</span> ((metrics_mult[<span class="st">'MAE'</span>] <span class="op">-</span> metrics_add[<span class="st">'MAE'</span>]) <span class="op">/</span> metrics_mult[<span class="st">'MAE'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-919"><a href="#cb42-919" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">WINNER: ADDITIVE SEASONALITY"</span>)</span>
<span id="cb42-920"><a href="#cb42-920" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   MAE improvement: </span><span class="sc">{</span>improvement<span class="sc">:.2f}</span><span class="ss">% better than multiplicative"</span>)</span>
<span id="cb42-921"><a href="#cb42-921" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb42-922"><a href="#cb42-922" aria-hidden="true" tabindex="-1"></a>        winner <span class="op">=</span> <span class="st">'MULTIPLICATIVE'</span></span>
<span id="cb42-923"><a href="#cb42-923" aria-hidden="true" tabindex="-1"></a>        improvement <span class="op">=</span> ((metrics_add[<span class="st">'MAE'</span>] <span class="op">-</span> metrics_mult[<span class="st">'MAE'</span>]) <span class="op">/</span> metrics_add[<span class="st">'MAE'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-924"><a href="#cb42-924" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">WINNER: MULTIPLICATIVE SEASONALITY"</span>)</span>
<span id="cb42-925"><a href="#cb42-925" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   MAE improvement: </span><span class="sc">{</span>improvement<span class="sc">:.2f}</span><span class="ss">% better than additive"</span>)</span>
<span id="cb42-926"><a href="#cb42-926" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-927"><a href="#cb42-927" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb42-928"><a href="#cb42-928" aria-hidden="true" tabindex="-1"></a>        <span class="st">'additive'</span>: {</span>
<span id="cb42-929"><a href="#cb42-929" aria-hidden="true" tabindex="-1"></a>            <span class="st">'params'</span>: params_add,</span>
<span id="cb42-930"><a href="#cb42-930" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model_add,</span>
<span id="cb42-931"><a href="#cb42-931" aria-hidden="true" tabindex="-1"></a>            <span class="st">'results'</span>: results_add,</span>
<span id="cb42-932"><a href="#cb42-932" aria-hidden="true" tabindex="-1"></a>            <span class="st">'metrics'</span>: metrics_add</span>
<span id="cb42-933"><a href="#cb42-933" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb42-934"><a href="#cb42-934" aria-hidden="true" tabindex="-1"></a>        <span class="st">'multiplicative'</span>: {</span>
<span id="cb42-935"><a href="#cb42-935" aria-hidden="true" tabindex="-1"></a>            <span class="st">'params'</span>: params_mult,</span>
<span id="cb42-936"><a href="#cb42-936" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model_mult,</span>
<span id="cb42-937"><a href="#cb42-937" aria-hidden="true" tabindex="-1"></a>            <span class="st">'results'</span>: results_mult,</span>
<span id="cb42-938"><a href="#cb42-938" aria-hidden="true" tabindex="-1"></a>            <span class="st">'metrics'</span>: metrics_mult</span>
<span id="cb42-939"><a href="#cb42-939" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb42-940"><a href="#cb42-940" aria-hidden="true" tabindex="-1"></a>        <span class="st">'winner'</span>: winner,</span>
<span id="cb42-941"><a href="#cb42-941" aria-hidden="true" tabindex="-1"></a>        <span class="st">'comparison_df'</span>: comparison_df</span>
<span id="cb42-942"><a href="#cb42-942" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-943"><a href="#cb42-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-944"><a href="#cb42-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-945"><a href="#cb42-945" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_additive_vs_multiplicative(comparison_dict):</span>
<span id="cb42-946"><a href="#cb42-946" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-947"><a href="#cb42-947" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize comparison between additive and multiplicative models.</span></span>
<span id="cb42-948"><a href="#cb42-948" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-949"><a href="#cb42-949" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb42-950"><a href="#cb42-950" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-951"><a href="#cb42-951" aria-hidden="true" tabindex="-1"></a>    results_add <span class="op">=</span> comparison_dict[<span class="st">'additive'</span>][<span class="st">'results'</span>]</span>
<span id="cb42-952"><a href="#cb42-952" aria-hidden="true" tabindex="-1"></a>    results_mult <span class="op">=</span> comparison_dict[<span class="st">'multiplicative'</span>][<span class="st">'results'</span>]</span>
<span id="cb42-953"><a href="#cb42-953" aria-hidden="true" tabindex="-1"></a>    params_add <span class="op">=</span> comparison_dict[<span class="st">'additive'</span>][<span class="st">'params'</span>]</span>
<span id="cb42-954"><a href="#cb42-954" aria-hidden="true" tabindex="-1"></a>    params_mult <span class="op">=</span> comparison_dict[<span class="st">'multiplicative'</span>][<span class="st">'params'</span>]</span>
<span id="cb42-955"><a href="#cb42-955" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-956"><a href="#cb42-956" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">12</span>))</span>
<span id="cb42-957"><a href="#cb42-957" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-958"><a href="#cb42-958" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Additive Forecasts</span></span>
<span id="cb42-959"><a href="#cb42-959" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb42-960"><a href="#cb42-960" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_add[<span class="st">'Date'</span>], results_add[<span class="st">'Actual'</span>], </span>
<span id="cb42-961"><a href="#cb42-961" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Actual'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-962"><a href="#cb42-962" aria-hidden="true" tabindex="-1"></a>    ax1.plot(results_add[<span class="st">'Date'</span>], results_add[<span class="st">'Forecast_H2'</span>], </span>
<span id="cb42-963"><a href="#cb42-963" aria-hidden="true" tabindex="-1"></a>             <span class="st">'s--'</span>, label<span class="op">=</span><span class="st">'Forecast'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb42-964"><a href="#cb42-964" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Additive Model (Î±=</span><span class="sc">{</span>params_add[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>params_add[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">)'</span>, </span>
<span id="cb42-965"><a href="#cb42-965" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-966"><a href="#cb42-966" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb42-967"><a href="#cb42-967" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Weekly Sales ($)'</span>)</span>
<span id="cb42-968"><a href="#cb42-968" aria-hidden="true" tabindex="-1"></a>    ax1.legend()</span>
<span id="cb42-969"><a href="#cb42-969" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-970"><a href="#cb42-970" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb42-971"><a href="#cb42-971" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax1.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-972"><a href="#cb42-972" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-973"><a href="#cb42-973" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: Multiplicative Forecasts</span></span>
<span id="cb42-974"><a href="#cb42-974" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb42-975"><a href="#cb42-975" aria-hidden="true" tabindex="-1"></a>    ax2.plot(results_mult[<span class="st">'Date'</span>], results_mult[<span class="st">'Actual'</span>], </span>
<span id="cb42-976"><a href="#cb42-976" aria-hidden="true" tabindex="-1"></a>             <span class="st">'o-'</span>, label<span class="op">=</span><span class="st">'Actual'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-977"><a href="#cb42-977" aria-hidden="true" tabindex="-1"></a>    ax2.plot(results_mult[<span class="st">'Date'</span>], results_mult[<span class="st">'Forecast_H2'</span>], </span>
<span id="cb42-978"><a href="#cb42-978" aria-hidden="true" tabindex="-1"></a>             <span class="st">'s--'</span>, label<span class="op">=</span><span class="st">'Forecast'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'coral'</span>)</span>
<span id="cb42-979"><a href="#cb42-979" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f'Multiplicative Model (Î±=</span><span class="sc">{</span>params_mult[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>params_mult[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">)'</span>, </span>
<span id="cb42-980"><a href="#cb42-980" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-981"><a href="#cb42-981" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb42-982"><a href="#cb42-982" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Weekly Sales ($)'</span>)</span>
<span id="cb42-983"><a href="#cb42-983" aria-hidden="true" tabindex="-1"></a>    ax2.legend()</span>
<span id="cb42-984"><a href="#cb42-984" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-985"><a href="#cb42-985" aria-hidden="true" tabindex="-1"></a>    ax2.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>))</span>
<span id="cb42-986"><a href="#cb42-986" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax2.xaxis.get_majorticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb42-987"><a href="#cb42-987" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-988"><a href="#cb42-988" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Error Comparison</span></span>
<span id="cb42-989"><a href="#cb42-989" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb42-990"><a href="#cb42-990" aria-hidden="true" tabindex="-1"></a>    errors_add <span class="op">=</span> np.<span class="bu">abs</span>(results_add[<span class="st">'Actual'</span>] <span class="op">-</span> results_add[<span class="st">'Forecast_H2'</span>])</span>
<span id="cb42-991"><a href="#cb42-991" aria-hidden="true" tabindex="-1"></a>    errors_mult <span class="op">=</span> np.<span class="bu">abs</span>(results_mult[<span class="st">'Actual'</span>] <span class="op">-</span> results_mult[<span class="st">'Forecast_H2'</span>])</span>
<span id="cb42-992"><a href="#cb42-992" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-993"><a href="#cb42-993" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.arange(<span class="bu">len</span>(results_add))</span>
<span id="cb42-994"><a href="#cb42-994" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb42-995"><a href="#cb42-995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-996"><a href="#cb42-996" aria-hidden="true" tabindex="-1"></a>    ax3.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, errors_add, width, label<span class="op">=</span><span class="st">'Additive'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-997"><a href="#cb42-997" aria-hidden="true" tabindex="-1"></a>    ax3.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, errors_mult, width, label<span class="op">=</span><span class="st">'Multiplicative'</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-998"><a href="#cb42-998" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Absolute Errors Comparison'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-999"><a href="#cb42-999" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'Week Index'</span>)</span>
<span id="cb42-1000"><a href="#cb42-1000" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Absolute Error ($)'</span>)</span>
<span id="cb42-1001"><a href="#cb42-1001" aria-hidden="true" tabindex="-1"></a>    ax3.legend()</span>
<span id="cb42-1002"><a href="#cb42-1002" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1003"><a href="#cb42-1003" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1004"><a href="#cb42-1004" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Metrics Comparison</span></span>
<span id="cb42-1005"><a href="#cb42-1005" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb42-1006"><a href="#cb42-1006" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1007"><a href="#cb42-1007" aria-hidden="true" tabindex="-1"></a>    metrics_add <span class="op">=</span> comparison_dict[<span class="st">'additive'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb42-1008"><a href="#cb42-1008" aria-hidden="true" tabindex="-1"></a>    metrics_mult <span class="op">=</span> comparison_dict[<span class="st">'multiplicative'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb42-1009"><a href="#cb42-1009" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1010"><a href="#cb42-1010" aria-hidden="true" tabindex="-1"></a>    metrics_names <span class="op">=</span> [<span class="st">'MAE'</span>, <span class="st">'MAPE (%)'</span>, <span class="st">'RMSE'</span>]</span>
<span id="cb42-1011"><a href="#cb42-1011" aria-hidden="true" tabindex="-1"></a>    additive_vals <span class="op">=</span> [metrics_add[<span class="st">'MAE'</span>], metrics_add[<span class="st">'MAPE'</span>], metrics_add[<span class="st">'RMSE'</span>]]</span>
<span id="cb42-1012"><a href="#cb42-1012" aria-hidden="true" tabindex="-1"></a>    mult_vals <span class="op">=</span> [metrics_mult[<span class="st">'MAE'</span>], metrics_mult[<span class="st">'MAPE'</span>], metrics_mult[<span class="st">'RMSE'</span>]]</span>
<span id="cb42-1013"><a href="#cb42-1013" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1014"><a href="#cb42-1014" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.arange(<span class="bu">len</span>(metrics_names))</span>
<span id="cb42-1015"><a href="#cb42-1015" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb42-1016"><a href="#cb42-1016" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1017"><a href="#cb42-1017" aria-hidden="true" tabindex="-1"></a>    bars1 <span class="op">=</span> ax4.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, additive_vals, width, label<span class="op">=</span><span class="st">'Additive'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-1018"><a href="#cb42-1018" aria-hidden="true" tabindex="-1"></a>    bars2 <span class="op">=</span> ax4.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, mult_vals, width, label<span class="op">=</span><span class="st">'Multiplicative'</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-1019"><a href="#cb42-1019" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1020"><a href="#cb42-1020" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Performance Metrics Comparison'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1021"><a href="#cb42-1021" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Value'</span>)</span>
<span id="cb42-1022"><a href="#cb42-1022" aria-hidden="true" tabindex="-1"></a>    ax4.set_xticks(x)</span>
<span id="cb42-1023"><a href="#cb42-1023" aria-hidden="true" tabindex="-1"></a>    ax4.set_xticklabels(metrics_names)</span>
<span id="cb42-1024"><a href="#cb42-1024" aria-hidden="true" tabindex="-1"></a>    ax4.legend()</span>
<span id="cb42-1025"><a href="#cb42-1025" aria-hidden="true" tabindex="-1"></a>    ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1026"><a href="#cb42-1026" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1027"><a href="#cb42-1027" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels on bars</span></span>
<span id="cb42-1028"><a href="#cb42-1028" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bars <span class="kw">in</span> [bars1, bars2]:</span>
<span id="cb42-1029"><a href="#cb42-1029" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb42-1030"><a href="#cb42-1030" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> bar.get_height()</span>
<span id="cb42-1031"><a href="#cb42-1031" aria-hidden="true" tabindex="-1"></a>            ax4.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb42-1032"><a href="#cb42-1032" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f'</span><span class="sc">{</span>height<span class="sc">:.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-1033"><a href="#cb42-1033" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb42-1034"><a href="#cb42-1034" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1035"><a href="#cb42-1035" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Additive vs Multiplicative Seasonality Comparison'</span>, </span>
<span id="cb42-1036"><a href="#cb42-1036" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">0.995</span>)</span>
<span id="cb42-1037"><a href="#cb42-1037" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-1038"><a href="#cb42-1038" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-1039"><a href="#cb42-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1040"><a href="#cb42-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1043"><a href="#cb42-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1044"><a href="#cb42-1044" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-1045"><a href="#cb42-1045" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN COMPLETE COMPARISON</span></span>
<span id="cb42-1046"><a href="#cb42-1046" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-1047"><a href="#cb42-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1048"><a href="#cb42-1048" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare both models</span></span>
<span id="cb42-1049"><a href="#cb42-1049" aria-hidden="true" tabindex="-1"></a>comparison_results <span class="op">=</span> compare_additive_vs_multiplicative(train_df, test_df)</span>
<span id="cb42-1050"><a href="#cb42-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1051"><a href="#cb42-1051" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize comparison</span></span>
<span id="cb42-1052"><a href="#cb42-1052" aria-hidden="true" tabindex="-1"></a>plot_additive_vs_multiplicative(comparison_results)</span>
<span id="cb42-1053"><a href="#cb42-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1054"><a href="#cb42-1054" aria-hidden="true" tabindex="-1"></a>winner <span class="op">=</span> comparison_results[<span class="st">'winner'</span>]</span>
<span id="cb42-1055"><a href="#cb42-1055" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Best model: </span><span class="sc">{</span>winner<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1056"><a href="#cb42-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1057"><a href="#cb42-1057" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the best model's results for Step 2</span></span>
<span id="cb42-1058"><a href="#cb42-1058" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> winner <span class="op">==</span> <span class="st">'ADDITIVE'</span>:</span>
<span id="cb42-1059"><a href="#cb42-1059" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> comparison_results[<span class="st">'additive'</span>][<span class="st">'params'</span>]</span>
<span id="cb42-1060"><a href="#cb42-1060" aria-hidden="true" tabindex="-1"></a>    best_results <span class="op">=</span> comparison_results[<span class="st">'additive'</span>][<span class="st">'results'</span>]</span>
<span id="cb42-1061"><a href="#cb42-1061" aria-hidden="true" tabindex="-1"></a>    best_metrics <span class="op">=</span> comparison_results[<span class="st">'additive'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb42-1062"><a href="#cb42-1062" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb42-1063"><a href="#cb42-1063" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> comparison_results[<span class="st">'multiplicative'</span>][<span class="st">'params'</span>]</span>
<span id="cb42-1064"><a href="#cb42-1064" aria-hidden="true" tabindex="-1"></a>    best_results <span class="op">=</span> comparison_results[<span class="st">'multiplicative'</span>][<span class="st">'results'</span>]</span>
<span id="cb42-1065"><a href="#cb42-1065" aria-hidden="true" tabindex="-1"></a>    best_metrics <span class="op">=</span> comparison_results[<span class="st">'multiplicative'</span>][<span class="st">'metrics'</span>]</span>
<span id="cb42-1066"><a href="#cb42-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1067"><a href="#cb42-1067" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Best parameters: Î±=</span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">, Î³=</span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb42-1068"><a href="#cb42-1068" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MAE: $</span><span class="sc">{</span>best_metrics[<span class="st">'MAE'</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-1069"><a href="#cb42-1069" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test MAPE: </span><span class="sc">{</span>best_metrics[<span class="st">'MAPE'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1070"><a href="#cb42-1070" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1071"><a href="#cb42-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1072"><a href="#cb42-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 3.2.2</span></span>
<span id="cb42-1073"><a href="#cb42-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1074"><a href="#cb42-1074" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For this part we reimport the data and preprocess them. We are not splitting them into train and test set since we are only interested in finding the +-X % by using the TES model that we found above.</span>
<span id="cb42-1075"><a href="#cb42-1075" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The same store again as well</span>
<span id="cb42-1076"><a href="#cb42-1076" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We will define the KPI metric, which is needed for further analysis</span>
<span id="cb42-1077"><a href="#cb42-1077" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Based on the last 12 months we will determing the +- X% in which just 6/12 are inside it</span>
<span id="cb42-1078"><a href="#cb42-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1081"><a href="#cb42-1081" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1082"><a href="#cb42-1082" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_full_historical_data(filepath, store_id<span class="op">=</span><span class="dv">2</span>): <span class="co"># Same function as before but without splitting</span></span>
<span id="cb42-1083"><a href="#cb42-1083" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1084"><a href="#cb42-1084" aria-hidden="true" tabindex="-1"></a><span class="co">    Load ALL historical data (no test split) for rebate analysis.</span></span>
<span id="cb42-1085"><a href="#cb42-1085" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1086"><a href="#cb42-1086" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1087"><a href="#cb42-1087" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1088"><a href="#cb42-1088" aria-hidden="true" tabindex="-1"></a><span class="co">    filepath : str, path to CSV file</span></span>
<span id="cb42-1089"><a href="#cb42-1089" aria-hidden="true" tabindex="-1"></a><span class="co">    store_id : int, store ID</span></span>
<span id="cb42-1090"><a href="#cb42-1090" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1091"><a href="#cb42-1091" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1092"><a href="#cb42-1092" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1093"><a href="#cb42-1093" aria-hidden="true" tabindex="-1"></a><span class="co">    df_full : DataFrame with all historical data</span></span>
<span id="cb42-1094"><a href="#cb42-1094" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1095"><a href="#cb42-1095" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1096"><a href="#cb42-1096" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"LOADING FULL HISTORICAL DATA FOR STORE </span><span class="sc">{</span>store_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1097"><a href="#cb42-1097" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1098"><a href="#cb42-1098" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1099"><a href="#cb42-1099" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb42-1100"><a href="#cb42-1100" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb42-1101"><a href="#cb42-1101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1102"><a href="#cb42-1102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for specific store</span></span>
<span id="cb42-1103"><a href="#cb42-1103" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">'Store'</span>] <span class="op">==</span> store_id].copy()</span>
<span id="cb42-1104"><a href="#cb42-1104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1105"><a href="#cb42-1105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert Date to datetime</span></span>
<span id="cb42-1106"><a href="#cb42-1106" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>])</span>
<span id="cb42-1107"><a href="#cb42-1107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1108"><a href="#cb42-1108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date</span></span>
<span id="cb42-1109"><a href="#cb42-1109" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">'Date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-1110"><a href="#cb42-1110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1111"><a href="#cb42-1111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle negative sales</span></span>
<span id="cb42-1112"><a href="#cb42-1112" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"Weekly_Sales"</span>] <span class="op">=</span> df[<span class="st">"Weekly_Sales"</span>].where(df[<span class="st">"Weekly_Sales"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb42-1113"><a href="#cb42-1113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1114"><a href="#cb42-1114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate to store level</span></span>
<span id="cb42-1115"><a href="#cb42-1115" aria-hidden="true" tabindex="-1"></a>    df_store <span class="op">=</span> df.groupby(<span class="st">'Date'</span>).agg({</span>
<span id="cb42-1116"><a href="#cb42-1116" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Weekly_Sales'</span>: <span class="st">'sum'</span>,</span>
<span id="cb42-1117"><a href="#cb42-1117" aria-hidden="true" tabindex="-1"></a>        <span class="st">'IsHoliday'</span>: <span class="st">'first'</span></span>
<span id="cb42-1118"><a href="#cb42-1118" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb42-1119"><a href="#cb42-1119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1120"><a href="#cb42-1120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add time features</span></span>
<span id="cb42-1121"><a href="#cb42-1121" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Year'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.year</span>
<span id="cb42-1122"><a href="#cb42-1122" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Month'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.month</span>
<span id="cb42-1123"><a href="#cb42-1123" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'Week'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.isocalendar().week</span>
<span id="cb42-1124"><a href="#cb42-1124" aria-hidden="true" tabindex="-1"></a>    df_store[<span class="st">'YearMonth'</span>] <span class="op">=</span> df_store[<span class="st">'Date'</span>].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb42-1125"><a href="#cb42-1125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1126"><a href="#cb42-1126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Data loaded!"</span>)</span>
<span id="cb42-1127"><a href="#cb42-1127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_store[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1128"><a href="#cb42-1128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_store)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1129"><a href="#cb42-1129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1130"><a href="#cb42-1130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_store</span>
<span id="cb42-1131"><a href="#cb42-1131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1132"><a href="#cb42-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1135"><a href="#cb42-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1136"><a href="#cb42-1136" aria-hidden="true" tabindex="-1"></a><span class="co"># Function that uses the first 52 weeks to train and then starting retraining using rolling window</span></span>
<span id="cb42-1137"><a href="#cb42-1137" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_all_horizon2_forecasts(df_historical, best_params, season_length<span class="op">=</span><span class="dv">52</span>): </span>
<span id="cb42-1138"><a href="#cb42-1138" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1139"><a href="#cb42-1139" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate horizon-2 forecasts for ALL historical data using rolling window.</span></span>
<span id="cb42-1140"><a href="#cb42-1140" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1141"><a href="#cb42-1141" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1142"><a href="#cb42-1142" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1143"><a href="#cb42-1143" aria-hidden="true" tabindex="-1"></a><span class="co">    df_historical : DataFrame with all historical data</span></span>
<span id="cb42-1144"><a href="#cb42-1144" aria-hidden="true" tabindex="-1"></a><span class="co">    best_params : tuple (alpha, gamma)</span></span>
<span id="cb42-1145"><a href="#cb42-1145" aria-hidden="true" tabindex="-1"></a><span class="co">    season_length : int, 52 for weekly data</span></span>
<span id="cb42-1146"><a href="#cb42-1146" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1147"><a href="#cb42-1147" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1148"><a href="#cb42-1148" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1149"><a href="#cb42-1149" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df : DataFrame with forecasts for all weeks</span></span>
<span id="cb42-1150"><a href="#cb42-1150" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1151"><a href="#cb42-1151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1152"><a href="#cb42-1152" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1153"><a href="#cb42-1153" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GENERATING HORIZON-2 FORECASTS FOR ALL HISTORICAL DATA"</span>)</span>
<span id="cb42-1154"><a href="#cb42-1154" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1155"><a href="#cb42-1155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1156"><a href="#cb42-1156" aria-hidden="true" tabindex="-1"></a>    alpha_best, gamma_best <span class="op">=</span> best_params</span>
<span id="cb42-1157"><a href="#cb42-1157" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> season_length</span>
<span id="cb42-1158"><a href="#cb42-1158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1159"><a href="#cb42-1159" aria-hidden="true" tabindex="-1"></a>    forecasts_h2 <span class="op">=</span> []</span>
<span id="cb42-1160"><a href="#cb42-1160" aria-hidden="true" tabindex="-1"></a>    actuals <span class="op">=</span> []</span>
<span id="cb42-1161"><a href="#cb42-1161" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> []</span>
<span id="cb42-1162"><a href="#cb42-1162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1163"><a href="#cb42-1163" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Generating forecasts using rolling window..."</span>)</span>
<span id="cb42-1164"><a href="#cb42-1164" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_historical)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1165"><a href="#cb42-1165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1166"><a href="#cb42-1166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start from week 52 (need at least one season for initialization)</span></span>
<span id="cb42-1167"><a href="#cb42-1167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and forecast horizon-2 ahead</span></span>
<span id="cb42-1168"><a href="#cb42-1168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(m, <span class="bu">len</span>(df_historical) <span class="op">-</span> <span class="dv">1</span>):  <span class="co"># -1 because we need i+1 to exist</span></span>
<span id="cb42-1169"><a href="#cb42-1169" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use all data up to week i</span></span>
<span id="cb42-1170"><a href="#cb42-1170" aria-hidden="true" tabindex="-1"></a>        current_data <span class="op">=</span> df_historical.iloc[:i][<span class="st">'Weekly_Sales'</span>].values</span>
<span id="cb42-1171"><a href="#cb42-1171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-1172"><a href="#cb42-1172" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit model</span></span>
<span id="cb42-1173"><a href="#cb42-1173" aria-hidden="true" tabindex="-1"></a>        fitted, level, seasonals <span class="op">=</span> hw_seasonal_no_trend(current_data, alpha_best, gamma_best, m)</span>
<span id="cb42-1174"><a href="#cb42-1174" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-1175"><a href="#cb42-1175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate horizon-2 forecast</span></span>
<span id="cb42-1176"><a href="#cb42-1176" aria-hidden="true" tabindex="-1"></a>        seasonals <span class="op">=</span> np.array(seasonals)</span>
<span id="cb42-1177"><a href="#cb42-1177" aria-hidden="true" tabindex="-1"></a>        seasonal_index_h2 <span class="op">=</span> <span class="bu">len</span>(seasonals) <span class="op">-</span> m <span class="op">+</span> <span class="dv">1</span>  <span class="co"># +1 for horizon-2</span></span>
<span id="cb42-1178"><a href="#cb42-1178" aria-hidden="true" tabindex="-1"></a>        forecast_h2 <span class="op">=</span> level <span class="op">+</span> seasonals[seasonal_index_h2]</span>
<span id="cb42-1179"><a href="#cb42-1179" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-1180"><a href="#cb42-1180" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The forecast is for week i+1 (horizon-2 from perspective of week i-1)</span></span>
<span id="cb42-1181"><a href="#cb42-1181" aria-hidden="true" tabindex="-1"></a>        forecast_week_index <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb42-1182"><a href="#cb42-1182" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-1183"><a href="#cb42-1183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> forecast_week_index <span class="op">&lt;</span> <span class="bu">len</span>(df_historical):</span>
<span id="cb42-1184"><a href="#cb42-1184" aria-hidden="true" tabindex="-1"></a>            forecasts_h2.append(forecast_h2)</span>
<span id="cb42-1185"><a href="#cb42-1185" aria-hidden="true" tabindex="-1"></a>            actuals.append(df_historical.iloc[forecast_week_index][<span class="st">'Weekly_Sales'</span>])</span>
<span id="cb42-1186"><a href="#cb42-1186" aria-hidden="true" tabindex="-1"></a>            dates.append(df_historical.iloc[forecast_week_index][<span class="st">'Date'</span>])</span>
<span id="cb42-1187"><a href="#cb42-1187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1188"><a href="#cb42-1188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results dataframe</span></span>
<span id="cb42-1189"><a href="#cb42-1189" aria-hidden="true" tabindex="-1"></a>    forecast_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb42-1190"><a href="#cb42-1190" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Date'</span>: dates,</span>
<span id="cb42-1191"><a href="#cb42-1191" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: actuals,</span>
<span id="cb42-1192"><a href="#cb42-1192" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: forecasts_h2</span>
<span id="cb42-1193"><a href="#cb42-1193" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-1194"><a href="#cb42-1194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1195"><a href="#cb42-1195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add time features</span></span>
<span id="cb42-1196"><a href="#cb42-1196" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'Year'</span>] <span class="op">=</span> forecast_df[<span class="st">'Date'</span>].dt.year</span>
<span id="cb42-1197"><a href="#cb42-1197" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'Month'</span>] <span class="op">=</span> forecast_df[<span class="st">'Date'</span>].dt.month</span>
<span id="cb42-1198"><a href="#cb42-1198" aria-hidden="true" tabindex="-1"></a>    forecast_df[<span class="st">'YearMonth'</span>] <span class="op">=</span> forecast_df[<span class="st">'Date'</span>].dt.to_period(<span class="st">'M'</span>)</span>
<span id="cb42-1199"><a href="#cb42-1199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1200"><a href="#cb42-1200" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Generated </span><span class="sc">{</span><span class="bu">len</span>(forecast_df)<span class="sc">}</span><span class="ss"> horizon-2 forecasts"</span>)</span>
<span id="cb42-1201"><a href="#cb42-1201" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>forecast_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>forecast_df[<span class="st">'Date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1202"><a href="#cb42-1202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1203"><a href="#cb42-1203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> forecast_df</span>
<span id="cb42-1204"><a href="#cb42-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1205"><a href="#cb42-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1208"><a href="#cb42-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1209"><a href="#cb42-1209" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_all_monthly_rho(forecast_df):</span>
<span id="cb42-1210"><a href="#cb42-1210" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1211"><a href="#cb42-1211" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate monthly Ï for ALL months in the data.</span></span>
<span id="cb42-1212"><a href="#cb42-1212" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1213"><a href="#cb42-1213" aria-hidden="true" tabindex="-1"></a><span class="co">    Formula: Ï_m = (Î£ forecasts - Î£ actuals) / Î£ actuals</span></span>
<span id="cb42-1214"><a href="#cb42-1214" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1215"><a href="#cb42-1215" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1216"><a href="#cb42-1216" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1217"><a href="#cb42-1217" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df : DataFrame with Date, Actual, Forecast_H2</span></span>
<span id="cb42-1218"><a href="#cb42-1218" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1219"><a href="#cb42-1219" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1220"><a href="#cb42-1220" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1221"><a href="#cb42-1221" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_rho_df : DataFrame with monthly Ï values for all months</span></span>
<span id="cb42-1222"><a href="#cb42-1222" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1223"><a href="#cb42-1223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1224"><a href="#cb42-1224" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1225"><a href="#cb42-1225" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CALCULATING MONTHLY Ï FOR ALL HISTORICAL MONTHS"</span>)</span>
<span id="cb42-1226"><a href="#cb42-1226" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1227"><a href="#cb42-1227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1228"><a href="#cb42-1228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by month and calculate sums</span></span>
<span id="cb42-1229"><a href="#cb42-1229" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> forecast_df.groupby(<span class="st">'YearMonth'</span>).agg({</span>
<span id="cb42-1230"><a href="#cb42-1230" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: <span class="st">'sum'</span>,</span>
<span id="cb42-1231"><a href="#cb42-1231" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: <span class="st">'sum'</span></span>
<span id="cb42-1232"><a href="#cb42-1232" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb42-1233"><a href="#cb42-1233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1234"><a href="#cb42-1234" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Ï for each month</span></span>
<span id="cb42-1235"><a href="#cb42-1235" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho'</span>] <span class="op">=</span> (monthly_stats[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> monthly_stats[<span class="st">'Actual'</span>]) <span class="op">/</span> monthly_stats[<span class="st">'Actual'</span>]</span>
<span id="cb42-1236"><a href="#cb42-1236" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_pct'</span>] <span class="op">=</span> monthly_stats[<span class="st">'rho'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-1237"><a href="#cb42-1237" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1238"><a href="#cb42-1238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count weeks per month</span></span>
<span id="cb42-1239"><a href="#cb42-1239" aria-hidden="true" tabindex="-1"></a>    weeks_per_month <span class="op">=</span> forecast_df.groupby(<span class="st">'YearMonth'</span>).size().reset_index(name<span class="op">=</span><span class="st">'num_weeks'</span>)</span>
<span id="cb42-1240"><a href="#cb42-1240" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> monthly_stats.merge(weeks_per_month, on<span class="op">=</span><span class="st">'YearMonth'</span>)</span>
<span id="cb42-1241"><a href="#cb42-1241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1242"><a href="#cb42-1242" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Calculated Ï for </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats)<span class="sc">}</span><span class="ss"> total months"</span>)</span>
<span id="cb42-1243"><a href="#cb42-1243" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>monthly_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>monthly_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1244"><a href="#cb42-1244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1245"><a href="#cb42-1245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_stats</span>
<span id="cb42-1246"><a href="#cb42-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1247"><a href="#cb42-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1250"><a href="#cb42-1250" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1251"><a href="#cb42-1251" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> determine_bracket_from_last_12_months(monthly_stats_all):</span>
<span id="cb42-1252"><a href="#cb42-1252" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1253"><a href="#cb42-1253" aria-hidden="true" tabindex="-1"></a><span class="co">    Determine Â±X% bracket using ONLY the last 12 months, where 6/12 qualify.</span></span>
<span id="cb42-1254"><a href="#cb42-1254" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1255"><a href="#cb42-1255" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1256"><a href="#cb42-1256" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1257"><a href="#cb42-1257" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_all : DataFrame with monthly Ï for ALL months</span></span>
<span id="cb42-1258"><a href="#cb42-1258" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1259"><a href="#cb42-1259" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1260"><a href="#cb42-1260" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1261"><a href="#cb42-1261" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float, the bracket percentage</span></span>
<span id="cb42-1262"><a href="#cb42-1262" aria-hidden="true" tabindex="-1"></a><span class="co">    last_12_stats : DataFrame, stats for last 12 months</span></span>
<span id="cb42-1263"><a href="#cb42-1263" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_all : DataFrame, all months with qualification flag</span></span>
<span id="cb42-1264"><a href="#cb42-1264" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1265"><a href="#cb42-1265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1266"><a href="#cb42-1266" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1267"><a href="#cb42-1267" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"DETERMINING BRACKET BASED ON LAST 12 MONTHS"</span>)</span>
<span id="cb42-1268"><a href="#cb42-1268" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1269"><a href="#cb42-1269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1270"><a href="#cb42-1270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the last 12 months</span></span>
<span id="cb42-1271"><a href="#cb42-1271" aria-hidden="true" tabindex="-1"></a>    last_12_stats <span class="op">=</span> monthly_stats_all.tail(<span class="dv">12</span>).copy()</span>
<span id="cb42-1272"><a href="#cb42-1272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1273"><a href="#cb42-1273" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total months in data: </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1274"><a href="#cb42-1274" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Using last 12 months for bracket determination:"</span>)</span>
<span id="cb42-1275"><a href="#cb42-1275" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  From: </span><span class="sc">{</span>last_12_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1276"><a href="#cb42-1276" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  To:   </span><span class="sc">{</span>last_12_stats[<span class="st">'YearMonth'</span>]<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1277"><a href="#cb42-1277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1278"><a href="#cb42-1278" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display last 12 months</span></span>
<span id="cb42-1279"><a href="#cb42-1279" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1280"><a href="#cb42-1280" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LAST 12 MONTHS (used for determining bracket):"</span>)</span>
<span id="cb42-1281"><a href="#cb42-1281" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1282"><a href="#cb42-1282" aria-hidden="true" tabindex="-1"></a>    display_df <span class="op">=</span> last_12_stats[[<span class="st">'YearMonth'</span>, <span class="st">'Actual'</span>, <span class="st">'Forecast_H2'</span>, <span class="st">'rho_pct'</span>, <span class="st">'num_weeks'</span>]].copy()</span>
<span id="cb42-1283"><a href="#cb42-1283" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'YearMonth'</span>] <span class="op">=</span> display_df[<span class="st">'YearMonth'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb42-1284"><a href="#cb42-1284" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'Actual'</span>] <span class="op">=</span> display_df[<span class="st">'Actual'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'$</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb42-1285"><a href="#cb42-1285" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'Forecast_H2'</span>] <span class="op">=</span> display_df[<span class="st">'Forecast_H2'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'$</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb42-1286"><a href="#cb42-1286" aria-hidden="true" tabindex="-1"></a>    display_df[<span class="st">'rho_pct'</span>] <span class="op">=</span> display_df[<span class="st">'rho_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1287"><a href="#cb42-1287" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(display_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb42-1288"><a href="#cb42-1288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1289"><a href="#cb42-1289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by absolute value of Ï (for last 12 months only)</span></span>
<span id="cb42-1290"><a href="#cb42-1290" aria-hidden="true" tabindex="-1"></a>    sorted_rho_abs <span class="op">=</span> np.sort(last_12_stats[<span class="st">'rho_pct'</span>].<span class="bu">abs</span>().values)</span>
<span id="cb42-1291"><a href="#cb42-1291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1292"><a href="#cb42-1292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the 6th smallest absolute Ï (index 5)</span></span>
<span id="cb42-1293"><a href="#cb42-1293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This means exactly 6 months will be inside the bracket</span></span>
<span id="cb42-1294"><a href="#cb42-1294" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sorted_rho_abs[<span class="dv">5</span>]</span>
<span id="cb42-1295"><a href="#cb42-1295" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1296"><a href="#cb42-1296" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1297"><a href="#cb42-1297" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"REBATE BRACKET: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1298"><a href="#cb42-1298" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"(Determined from last 12 months where 6/12 qualify)"</span>)</span>
<span id="cb42-1299"><a href="#cb42-1299" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1300"><a href="#cb42-1300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1301"><a href="#cb42-1301" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply this bracket to ALL months</span></span>
<span id="cb42-1302"><a href="#cb42-1302" aria-hidden="true" tabindex="-1"></a>    monthly_stats_all[<span class="st">'qualifies'</span>] <span class="op">=</span> monthly_stats_all[<span class="st">'rho_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb42-1303"><a href="#cb42-1303" aria-hidden="true" tabindex="-1"></a>    last_12_stats[<span class="st">'qualifies'</span>] <span class="op">=</span> last_12_stats[<span class="st">'rho_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb42-1304"><a href="#cb42-1304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1305"><a href="#cb42-1305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show results for last 12 months</span></span>
<span id="cb42-1306"><a href="#cb42-1306" aria-hidden="true" tabindex="-1"></a>    qualifying_last_12 <span class="op">=</span> last_12_stats[last_12_stats[<span class="st">'qualifies'</span>]].copy()</span>
<span id="cb42-1307"><a href="#cb42-1307" aria-hidden="true" tabindex="-1"></a>    non_qualifying_last_12 <span class="op">=</span> last_12_stats[<span class="op">~</span>last_12_stats[<span class="st">'qualifies'</span>]].copy()</span>
<span id="cb42-1308"><a href="#cb42-1308" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1309"><a href="#cb42-1309" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">LAST 12 MONTHS - Months that QUALIFY (|Ï| â‰¤ </span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%):"</span>)</span>
<span id="cb42-1310"><a href="#cb42-1310" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1311"><a href="#cb42-1311" aria-hidden="true" tabindex="-1"></a>    qual_display <span class="op">=</span> qualifying_last_12[[<span class="st">'YearMonth'</span>, <span class="st">'rho_pct'</span>, <span class="st">'num_weeks'</span>]].copy()</span>
<span id="cb42-1312"><a href="#cb42-1312" aria-hidden="true" tabindex="-1"></a>    qual_display[<span class="st">'YearMonth'</span>] <span class="op">=</span> qual_display[<span class="st">'YearMonth'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb42-1313"><a href="#cb42-1313" aria-hidden="true" tabindex="-1"></a>    qual_display[<span class="st">'rho_pct'</span>] <span class="op">=</span> qual_display[<span class="st">'rho_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1314"><a href="#cb42-1314" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(qual_display.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb42-1315"><a href="#cb42-1315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1316"><a href="#cb42-1316" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">LAST 12 MONTHS - Months that DO NOT qualify (|Ï| &gt; </span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%):"</span>)</span>
<span id="cb42-1317"><a href="#cb42-1317" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1318"><a href="#cb42-1318" aria-hidden="true" tabindex="-1"></a>    non_qual_display <span class="op">=</span> non_qualifying_last_12[[<span class="st">'YearMonth'</span>, <span class="st">'rho_pct'</span>, <span class="st">'num_weeks'</span>]].copy()</span>
<span id="cb42-1319"><a href="#cb42-1319" aria-hidden="true" tabindex="-1"></a>    non_qual_display[<span class="st">'YearMonth'</span>] <span class="op">=</span> non_qual_display[<span class="st">'YearMonth'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb42-1320"><a href="#cb42-1320" aria-hidden="true" tabindex="-1"></a>    non_qual_display[<span class="st">'rho_pct'</span>] <span class="op">=</span> non_qual_display[<span class="st">'rho_pct'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1321"><a href="#cb42-1321" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(non_qual_display.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb42-1322"><a href="#cb42-1322" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1323"><a href="#cb42-1323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show statistics for last 12 months</span></span>
<span id="cb42-1324"><a href="#cb42-1324" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1325"><a href="#cb42-1325" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STATISTICS (LAST 12 MONTHS)"</span>)</span>
<span id="cb42-1326"><a href="#cb42-1326" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1327"><a href="#cb42-1327" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Qualifying months: </span><span class="sc">{</span><span class="bu">len</span>(qualifying_last_12)<span class="sc">}</span><span class="ss">/12 (</span><span class="sc">{</span><span class="bu">len</span>(qualifying_last_12)<span class="op">/</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-1328"><a href="#cb42-1328" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean Ï:   </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1329"><a href="#cb42-1329" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Median Ï: </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span>median()<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1330"><a href="#cb42-1330" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Std Dev:  </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1331"><a href="#cb42-1331" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Range:    [</span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">%, </span><span class="sc">{</span>last_12_stats[<span class="st">'rho_pct'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">%]"</span>)</span>
<span id="cb42-1332"><a href="#cb42-1332" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1333"><a href="#cb42-1333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show how this bracket applies to ALL historical data</span></span>
<span id="cb42-1334"><a href="#cb42-1334" aria-hidden="true" tabindex="-1"></a>    total_qualifying <span class="op">=</span> monthly_stats_all[<span class="st">'qualifies'</span>].<span class="bu">sum</span>()</span>
<span id="cb42-1335"><a href="#cb42-1335" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1336"><a href="#cb42-1336" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"BRACKET APPLIED TO ALL HISTORICAL DATA"</span>)</span>
<span id="cb42-1337"><a href="#cb42-1337" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1338"><a href="#cb42-1338" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total months: </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1339"><a href="#cb42-1339" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Qualifying months: </span><span class="sc">{</span>total_qualifying<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>total_qualifying<span class="op">/</span><span class="bu">len</span>(monthly_stats_all)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-1340"><a href="#cb42-1340" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1341"><a href="#cb42-1341" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, last_12_stats, monthly_stats_all</span>
<span id="cb42-1342"><a href="#cb42-1342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1343"><a href="#cb42-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1346"><a href="#cb42-1346" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1347"><a href="#cb42-1347" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_bracket_analysis(monthly_stats_all, last_12_stats, X):</span>
<span id="cb42-1348"><a href="#cb42-1348" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1349"><a href="#cb42-1349" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize the rebate bracket analysis.</span></span>
<span id="cb42-1350"><a href="#cb42-1350" aria-hidden="true" tabindex="-1"></a><span class="co">    Shows both: last 12 months (used for bracket) and all historical data.</span></span>
<span id="cb42-1351"><a href="#cb42-1351" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1352"><a href="#cb42-1352" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1353"><a href="#cb42-1353" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">14</span>))</span>
<span id="cb42-1354"><a href="#cb42-1354" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">2</span>, hspace<span class="op">=</span><span class="fl">0.3</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-1355"><a href="#cb42-1355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1356"><a href="#cb42-1356" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Last 12 months bar chart (MAIN PLOT)</span></span>
<span id="cb42-1357"><a href="#cb42-1357" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb42-1358"><a href="#cb42-1358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1359"><a href="#cb42-1359" aria-hidden="true" tabindex="-1"></a>    month_labels <span class="op">=</span> [<span class="bu">str</span>(m) <span class="cf">for</span> m <span class="kw">in</span> last_12_stats[<span class="st">'YearMonth'</span>]]</span>
<span id="cb42-1360"><a href="#cb42-1360" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> q <span class="kw">in</span> last_12_stats[<span class="st">'qualifies'</span>]]</span>
<span id="cb42-1361"><a href="#cb42-1361" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1362"><a href="#cb42-1362" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax1.bar(<span class="bu">range</span>(<span class="bu">len</span>(last_12_stats)), last_12_stats[<span class="st">'rho_pct'</span>], </span>
<span id="cb42-1363"><a href="#cb42-1363" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb42-1364"><a href="#cb42-1364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1365"><a href="#cb42-1365" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="ss">f'Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1366"><a href="#cb42-1366" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb42-1367"><a href="#cb42-1367" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb42-1368"><a href="#cb42-1368" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1369"><a href="#cb42-1369" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(last_12_stats)))</span>
<span id="cb42-1370"><a href="#cb42-1370" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticklabels(month_labels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-1371"><a href="#cb42-1371" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Month (Last 12 Months)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1372"><a href="#cb42-1372" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1373"><a href="#cb42-1373" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Rebate KPI for Last 12 Months (Used to Determine Bracket)</span><span class="ch">\n</span><span class="ss">6/12 Months Qualify with Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>, </span>
<span id="cb42-1374"><a href="#cb42-1374" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1375"><a href="#cb42-1375" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">12</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb42-1376"><a href="#cb42-1376" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1377"><a href="#cb42-1377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1378"><a href="#cb42-1378" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels</span></span>
<span id="cb42-1379"><a href="#cb42-1379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (bar, val) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(bars, last_12_stats[<span class="st">'rho_pct'</span>])):</span>
<span id="cb42-1380"><a href="#cb42-1380" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> bar.get_height()</span>
<span id="cb42-1381"><a href="#cb42-1381" aria-hidden="true" tabindex="-1"></a>        ax1.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb42-1382"><a href="#cb42-1382" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:+.1f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1383"><a href="#cb42-1383" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span> <span class="cf">if</span> height <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'top'</span>, </span>
<span id="cb42-1384"><a href="#cb42-1384" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1385"><a href="#cb42-1385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1386"><a href="#cb42-1386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: All historical months</span></span>
<span id="cb42-1387"><a href="#cb42-1387" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, :])</span>
<span id="cb42-1388"><a href="#cb42-1388" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1389"><a href="#cb42-1389" aria-hidden="true" tabindex="-1"></a>    all_colors <span class="op">=</span> [<span class="st">'lightgreen'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'lightcoral'</span> <span class="cf">for</span> q <span class="kw">in</span> monthly_stats_all[<span class="st">'qualifies'</span>]]</span>
<span id="cb42-1390"><a href="#cb42-1390" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1391"><a href="#cb42-1391" aria-hidden="true" tabindex="-1"></a>    ax2.bar(<span class="bu">range</span>(<span class="bu">len</span>(monthly_stats_all)), monthly_stats_all[<span class="st">'rho_pct'</span>], </span>
<span id="cb42-1392"><a href="#cb42-1392" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>all_colors, alpha<span class="op">=</span><span class="fl">0.6</span>, edgecolor<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb42-1393"><a href="#cb42-1393" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1394"><a href="#cb42-1394" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb42-1395"><a href="#cb42-1395" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb42-1396"><a href="#cb42-1396" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1397"><a href="#cb42-1397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight last 12 months region</span></span>
<span id="cb42-1398"><a href="#cb42-1398" aria-hidden="true" tabindex="-1"></a>    ax2.axvspan(<span class="bu">len</span>(monthly_stats_all)<span class="op">-</span><span class="dv">12</span>, <span class="bu">len</span>(monthly_stats_all), </span>
<span id="cb42-1399"><a href="#cb42-1399" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'yellow'</span>, label<span class="op">=</span><span class="st">'Last 12 months (bracket basis)'</span>)</span>
<span id="cb42-1400"><a href="#cb42-1400" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1401"><a href="#cb42-1401" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Month Index (All Historical Data)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1402"><a href="#cb42-1402" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1403"><a href="#cb42-1403" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="ss">f'All Historical Months with Bracket Applied</span><span class="ch">\n</span><span class="sc">{</span>monthly_stats_all[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> Total Months Qualify'</span>, </span>
<span id="cb42-1404"><a href="#cb42-1404" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1405"><a href="#cb42-1405" aria-hidden="true" tabindex="-1"></a>    ax2.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-1406"><a href="#cb42-1406" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1407"><a href="#cb42-1407" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1408"><a href="#cb42-1408" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Histogram - Last 12 months</span></span>
<span id="cb42-1409"><a href="#cb42-1409" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb42-1410"><a href="#cb42-1410" aria-hidden="true" tabindex="-1"></a>    ax3.hist(last_12_stats[<span class="st">'rho_pct'</span>], bins<span class="op">=</span><span class="dv">8</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>)</span>
<span id="cb42-1411"><a href="#cb42-1411" aria-hidden="true" tabindex="-1"></a>    ax3.axvline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb42-1412"><a href="#cb42-1412" aria-hidden="true" tabindex="-1"></a>    ax3.axvline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1413"><a href="#cb42-1413" aria-hidden="true" tabindex="-1"></a>    ax3.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Perfect'</span>)</span>
<span id="cb42-1414"><a href="#cb42-1414" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1415"><a href="#cb42-1415" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1416"><a href="#cb42-1416" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Distribution (Last 12 Months)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1417"><a href="#cb42-1417" aria-hidden="true" tabindex="-1"></a>    ax3.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-1418"><a href="#cb42-1418" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-1419"><a href="#cb42-1419" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1420"><a href="#cb42-1420" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Summary statistics</span></span>
<span id="cb42-1421"><a href="#cb42-1421" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb42-1422"><a href="#cb42-1422" aria-hidden="true" tabindex="-1"></a>    ax4.axis(<span class="st">'off'</span>)</span>
<span id="cb42-1423"><a href="#cb42-1423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1424"><a href="#cb42-1424" aria-hidden="true" tabindex="-1"></a>    stats_text <span class="op">=</span> [</span>
<span id="cb42-1425"><a href="#cb42-1425" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Metric'</span>, <span class="st">'Last 12M'</span>, <span class="st">'All History'</span>],</span>
<span id="cb42-1426"><a href="#cb42-1426" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'â”€'</span><span class="op">*</span><span class="dv">20</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>],</span>
<span id="cb42-1427"><a href="#cb42-1427" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Total Months'</span>, <span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(last_12_stats)<span class="sc">}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb42-1428"><a href="#cb42-1428" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Qualifying'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb42-1429"><a href="#cb42-1429" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Success Rate'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>, </span>
<span id="cb42-1430"><a href="#cb42-1430" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"qualifies"</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(monthly_stats_all)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1431"><a href="#cb42-1431" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1432"><a href="#cb42-1432" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Bracket'</span>, <span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>, <span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1433"><a href="#cb42-1433" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1434"><a href="#cb42-1434" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Mean Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>, </span>
<span id="cb42-1435"><a href="#cb42-1435" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1436"><a href="#cb42-1436" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Median Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span>median()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1437"><a href="#cb42-1437" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span>median()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1438"><a href="#cb42-1438" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Std Dev'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1439"><a href="#cb42-1439" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1440"><a href="#cb42-1440" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Min Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1441"><a href="#cb42-1441" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1442"><a href="#cb42-1442" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Max Ï'</span>, <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1443"><a href="#cb42-1443" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>monthly_stats_all[<span class="st">"rho_pct"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1444"><a href="#cb42-1444" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb42-1445"><a href="#cb42-1445" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1446"><a href="#cb42-1446" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax4.table(cellText<span class="op">=</span>stats_text, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb42-1447"><a href="#cb42-1447" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb42-1448"><a href="#cb42-1448" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb42-1449"><a href="#cb42-1449" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb42-1450"><a href="#cb42-1450" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb42-1451"><a href="#cb42-1451" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1452"><a href="#cb42-1452" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style header</span></span>
<span id="cb42-1453"><a href="#cb42-1453" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb42-1454"><a href="#cb42-1454" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb42-1455"><a href="#cb42-1455" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb42-1456"><a href="#cb42-1456" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1457"><a href="#cb42-1457" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Summary Statistics'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb42-1458"><a href="#cb42-1458" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1459"><a href="#cb42-1459" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Rebate Bracket Analysis: Bracket Set by Last 12 Months (6/12 Rule)'</span>, </span>
<span id="cb42-1460"><a href="#cb42-1460" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1461"><a href="#cb42-1461" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-1462"><a href="#cb42-1462" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-1463"><a href="#cb42-1463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1464"><a href="#cb42-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1467"><a href="#cb42-1467" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1468"><a href="#cb42-1468" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-1469"><a href="#cb42-1469" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.2: DETERMINE REBATE BRACKET</span></span>
<span id="cb42-1470"><a href="#cb42-1470" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-1471"><a href="#cb42-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1472"><a href="#cb42-1472" aria-hidden="true" tabindex="-1"></a><span class="co"># Load FULL historical data (no test split)</span></span>
<span id="cb42-1473"><a href="#cb42-1473" aria-hidden="true" tabindex="-1"></a>df_historical <span class="op">=</span> load_full_historical_data(<span class="st">"../data/train.csv"</span>, store_id<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb42-1474"><a href="#cb42-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1475"><a href="#cb42-1475" aria-hidden="true" tabindex="-1"></a><span class="co"># Use best parameters from Step 3.1</span></span>
<span id="cb42-1476"><a href="#cb42-1476" aria-hidden="true" tabindex="-1"></a>best_params <span class="op">=</span> (<span class="fl">0.150</span>, <span class="fl">0.750</span>)  <span class="co"># Î±=0.150, Î³=0.750 (Additive winner)</span></span>
<span id="cb42-1477"><a href="#cb42-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1478"><a href="#cb42-1478" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate horizon-2 forecasts for ALL historical data</span></span>
<span id="cb42-1479"><a href="#cb42-1479" aria-hidden="true" tabindex="-1"></a>forecast_all <span class="op">=</span> generate_all_horizon2_forecasts(df_historical, best_params)</span>
<span id="cb42-1480"><a href="#cb42-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1481"><a href="#cb42-1481" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly Ï for ALL months</span></span>
<span id="cb42-1482"><a href="#cb42-1482" aria-hidden="true" tabindex="-1"></a>monthly_stats_all <span class="op">=</span> calculate_all_monthly_rho(forecast_all)</span>
<span id="cb42-1483"><a href="#cb42-1483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1484"><a href="#cb42-1484" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine bracket using LAST 12 MONTHS (6/12 rule)</span></span>
<span id="cb42-1485"><a href="#cb42-1485" aria-hidden="true" tabindex="-1"></a>X, last_12_stats, monthly_stats_with_bracket <span class="op">=</span> determine_bracket_from_last_12_months(monthly_stats_all)</span>
<span id="cb42-1486"><a href="#cb42-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1487"><a href="#cb42-1487" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb42-1488"><a href="#cb42-1488" aria-hidden="true" tabindex="-1"></a>visualize_bracket_analysis(monthly_stats_with_bracket, last_12_stats, X)</span>
<span id="cb42-1489"><a href="#cb42-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1490"><a href="#cb42-1490" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1491"><a href="#cb42-1491" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"STEP 3.2 COMPLETE!"</span>)</span>
<span id="cb42-1492"><a href="#cb42-1492" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-1493"><a href="#cb42-1493" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rebate Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1494"><a href="#cb42-1494" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Determined by: Last 12 months (6/12 qualify)"</span>)</span>
<span id="cb42-1495"><a href="#cb42-1495" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Applied to: All </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> historical months"</span>)</span>
<span id="cb42-1496"><a href="#cb42-1496" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Result: </span><span class="sc">{</span>monthly_stats_with_bracket[<span class="st">'qualifies'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(monthly_stats_all)<span class="sc">}</span><span class="ss"> months qualify overall"</span>)</span>
<span id="cb42-1497"><a href="#cb42-1497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1498"><a href="#cb42-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1499"><a href="#cb42-1499" aria-hidden="true" tabindex="-1"></a>**Note:**</span>
<span id="cb42-1500"><a href="#cb42-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1501"><a href="#cb42-1501" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1502"><a href="#cb42-1502" aria-hidden="true" tabindex="-1"></a><span class="in">By making a comparison with the graph that compares the weekly sales per year and per month, can be easily understandable why some months are performing very well on rolling windows (like November and December). What we mean by this, is that if we take a look on November and December of 2010 and 2011 are having very similar pattern, so the model can easily make a very accurate forecasting.</span></span>
<span id="cb42-1503"><a href="#cb42-1503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1504"><a href="#cb42-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1505"><a href="#cb42-1505" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1506"><a href="#cb42-1506" aria-hidden="true" tabindex="-1"></a><span class="in">On the opposite scenario, if we compare months like January and June, with the previous years, we can observe a different pattern, which leads to relatively poor forecasts</span></span>
<span id="cb42-1507"><a href="#cb42-1507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1508"><a href="#cb42-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1509"><a href="#cb42-1509" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 3.3 -- New Strategy to improve the forecastings</span></span>
<span id="cb42-1510"><a href="#cb42-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1511"><a href="#cb42-1511" aria-hidden="true" tabindex="-1"></a>We are thinking of different strategies that can improve the results. Most of them are based on intuitevely reasons, some of them might not make sense statistically, but they can improve significantly the results and add more months on the rebate change.</span>
<span id="cb42-1512"><a href="#cb42-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1513"><a href="#cb42-1513" aria-hidden="true" tabindex="-1"></a>Before, explaining them let us introduce some results from the above graph, that lead us to these ideas.</span>
<span id="cb42-1514"><a href="#cb42-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1515"><a href="#cb42-1515" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Our current results, show a under forecasting on average (mean is around -0.8%)</span>
<span id="cb42-1516"><a href="#cb42-1516" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Range from -2.8% to 4.21%</span>
<span id="cb42-1517"><a href="#cb42-1517" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Some months are just outside of the bracket (e.g. -1.8%,-2.3%,-2.5%)</span>
<span id="cb42-1518"><a href="#cb42-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1519"><a href="#cb42-1519" aria-hidden="true" tabindex="-1"></a>Based on the above results, we are thinking of the following strategies:</span>
<span id="cb42-1520"><a href="#cb42-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1521"><a href="#cb42-1521" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Bias correction â†’ Since we are mainly under forecasting by mean of around -0.8% we can just add 0.8% to all forecasts.</span>
<span id="cb42-1522"><a href="#cb42-1522" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Variance reduction â†’ Reduce forecast variance by dampening toward the mean</span>
<span id="cb42-1523"><a href="#cb42-1523" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Adaptive monthly adjustment â†’ Based on the history of each month reduce or add the forecast, however this approach seems not to be feasible since we dont have a lot of data on a monthly basis.</span>
<span id="cb42-1524"><a href="#cb42-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1525"><a href="#cb42-1525" aria-hidden="true" tabindex="-1"></a>**Note:**</span>
<span id="cb42-1526"><a href="#cb42-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1527"><a href="#cb42-1527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1528"><a href="#cb42-1528" aria-hidden="true" tabindex="-1"></a><span class="in">In most of the cases dampening factor is used when we are dealing with trend, however we have already saw that the time series that we are dealing of does not have trend at all(as we proved with the statistical tests). So even though, dampnening is mainly use when we are dealing with trend components, we would like to try this approach to check for any further improvements. We are reminding that dampening factor in very simple words, just reduces or increases the forecasting towards to the mean of our data</span></span>
<span id="cb42-1529"><a href="#cb42-1529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1530"><a href="#cb42-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1531"><a href="#cb42-1531" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding the Dampening Strategy</span></span>
<span id="cb42-1532"><a href="#cb42-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1533"><a href="#cb42-1533" aria-hidden="true" tabindex="-1"></a>**Important Clarification: Why dampening when Î²=0 (no trend)?**</span>
<span id="cb42-1534"><a href="#cb42-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1535"><a href="#cb42-1535" aria-hidden="true" tabindex="-1"></a>Our statistical tests confirmed there is **no trend** in the data (Î²=0). However, dampening is still beneficial because:</span>
<span id="cb42-1536"><a href="#cb42-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1537"><a href="#cb42-1537" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Dampening â‰  Trend Adjustment**</span>
<span id="cb42-1538"><a href="#cb42-1538" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>**Trend (Î²)**: Controls long-term directional change (growth/decline over time)</span>
<span id="cb42-1539"><a href="#cb42-1539" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>**Dampening (d)**: Reduces forecast variance by pulling predictions toward the mean</span>
<span id="cb42-1540"><a href="#cb42-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1541"><a href="#cb42-1541" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**The Problem We're Solving**</span>
<span id="cb42-1542"><a href="#cb42-1542" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Even without trend, our forecasts have **high variance**</span>
<span id="cb42-1543"><a href="#cb42-1543" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Some months we over-forecast (+4.2%), some we under-forecast (-2.8%)</span>
<span id="cb42-1544"><a href="#cb42-1544" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>This volatility pushes Ï values outside the Â±X% bracket</span>
<span id="cb42-1545"><a href="#cb42-1545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1546"><a href="#cb42-1546" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**How Dampening Helps**</span>
<span id="cb42-1547"><a href="#cb42-1547" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Reduces extreme forecasts (both high and low)</span>
<span id="cb42-1548"><a href="#cb42-1548" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Pulls forecasts toward the historical mean</span>
<span id="cb42-1549"><a href="#cb42-1549" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Result: More stable monthly Ï values â†’ More months qualify</span>
<span id="cb42-1550"><a href="#cb42-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1551"><a href="#cb42-1551" aria-hidden="true" tabindex="-1"></a>**Analogy**: </span>
<span id="cb42-1552"><a href="#cb42-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1553"><a href="#cb42-1553" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Setting Î²=0 says: "The business isn't growing or shrinking"</span>
<span id="cb42-1554"><a href="#cb42-1554" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Dampening says: "Let's make our forecasts less aggressive/extreme"</span>
<span id="cb42-1555"><a href="#cb42-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1556"><a href="#cb42-1556" aria-hidden="true" tabindex="-1"></a>These are **independent decisions** solving **different problems**!</span>
<span id="cb42-1557"><a href="#cb42-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1560"><a href="#cb42-1560" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1561"><a href="#cb42-1561" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_conservative_strategy(forecast_df, damping_factor<span class="op">=</span><span class="fl">0.10</span>):</span>
<span id="cb42-1562"><a href="#cb42-1562" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1563"><a href="#cb42-1563" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply conservative forecasting strategy by dampening toward historical mean.</span></span>
<span id="cb42-1564"><a href="#cb42-1564" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1565"><a href="#cb42-1565" aria-hidden="true" tabindex="-1"></a><span class="co">    Strategy: Reduce forecast variance by pulling extreme forecasts toward the mean.</span></span>
<span id="cb42-1566"><a href="#cb42-1566" aria-hidden="true" tabindex="-1"></a><span class="co">    This helps keep monthly Ï values closer to 0%, increasing rebate qualification.</span></span>
<span id="cb42-1567"><a href="#cb42-1567" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1568"><a href="#cb42-1568" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1569"><a href="#cb42-1569" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1570"><a href="#cb42-1570" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df : DataFrame with columns ['Date', 'Actual', 'Forecast_H2']</span></span>
<span id="cb42-1571"><a href="#cb42-1571" aria-hidden="true" tabindex="-1"></a><span class="co">    damping_factor : float, weight toward mean (0.10 = 10% dampening)</span></span>
<span id="cb42-1572"><a href="#cb42-1572" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1573"><a href="#cb42-1573" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1574"><a href="#cb42-1574" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1575"><a href="#cb42-1575" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df_modified : DataFrame with new 'Forecast_Modified' column</span></span>
<span id="cb42-1576"><a href="#cb42-1576" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1577"><a href="#cb42-1577" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1578"><a href="#cb42-1578" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1579"><a href="#cb42-1579" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"APPLYING CONSERVATIVE FORECASTING STRATEGY"</span>)</span>
<span id="cb42-1580"><a href="#cb42-1580" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1581"><a href="#cb42-1581" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1582"><a href="#cb42-1582" aria-hidden="true" tabindex="-1"></a>    forecast_df_modified <span class="op">=</span> forecast_df.copy()</span>
<span id="cb42-1583"><a href="#cb42-1583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1584"><a href="#cb42-1584" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate historical mean</span></span>
<span id="cb42-1585"><a href="#cb42-1585" aria-hidden="true" tabindex="-1"></a>    historical_mean <span class="op">=</span> forecast_df[<span class="st">'Actual'</span>].mean()</span>
<span id="cb42-1586"><a href="#cb42-1586" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1587"><a href="#cb42-1587" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Strategy: Conservative Forecasting"</span>)</span>
<span id="cb42-1588"><a href="#cb42-1588" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Method: Dampen forecasts </span><span class="sc">{</span>damping_factor<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% toward historical mean"</span>)</span>
<span id="cb42-1589"><a href="#cb42-1589" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Historical mean: $</span><span class="sc">{</span>historical_mean<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-1590"><a href="#cb42-1590" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Damping factor: </span><span class="sc">{</span>damping_factor<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-1591"><a href="#cb42-1591" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1592"><a href="#cb42-1592" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply strategy: modified = (1-d)*original + d*mean</span></span>
<span id="cb42-1593"><a href="#cb42-1593" aria-hidden="true" tabindex="-1"></a>    forecast_df_modified[<span class="st">'Forecast_Modified'</span>] <span class="op">=</span> (</span>
<span id="cb42-1594"><a href="#cb42-1594" aria-hidden="true" tabindex="-1"></a>        forecast_df[<span class="st">'Forecast_H2'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> damping_factor) <span class="op">+</span> </span>
<span id="cb42-1595"><a href="#cb42-1595" aria-hidden="true" tabindex="-1"></a>        historical_mean <span class="op">*</span> damping_factor</span>
<span id="cb42-1596"><a href="#cb42-1596" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-1597"><a href="#cb42-1597" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1598"><a href="#cb42-1598" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Strategy applied to </span><span class="sc">{</span><span class="bu">len</span>(forecast_df_modified)<span class="sc">}</span><span class="ss"> weekly forecasts"</span>)</span>
<span id="cb42-1599"><a href="#cb42-1599" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1600"><a href="#cb42-1600" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> forecast_df_modified, historical_mean</span>
<span id="cb42-1601"><a href="#cb42-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1602"><a href="#cb42-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1605"><a href="#cb42-1605" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1606"><a href="#cb42-1606" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_monthly_rho_with_strategy(forecast_df_modified):</span>
<span id="cb42-1607"><a href="#cb42-1607" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1608"><a href="#cb42-1608" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate monthly Ï using the MODIFIED forecasts.</span></span>
<span id="cb42-1609"><a href="#cb42-1609" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1610"><a href="#cb42-1610" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1611"><a href="#cb42-1611" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1612"><a href="#cb42-1612" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df_modified : DataFrame with 'Forecast_Modified' column</span></span>
<span id="cb42-1613"><a href="#cb42-1613" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1614"><a href="#cb42-1614" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1615"><a href="#cb42-1615" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1616"><a href="#cb42-1616" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_modified : DataFrame with monthly Ï based on modified forecasts</span></span>
<span id="cb42-1617"><a href="#cb42-1617" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1618"><a href="#cb42-1618" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1619"><a href="#cb42-1619" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1620"><a href="#cb42-1620" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CALCULATING MONTHLY Ï WITH MODIFIED FORECASTS"</span>)</span>
<span id="cb42-1621"><a href="#cb42-1621" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1622"><a href="#cb42-1622" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1623"><a href="#cb42-1623" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by month and sum</span></span>
<span id="cb42-1624"><a href="#cb42-1624" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> forecast_df_modified.groupby(<span class="st">'YearMonth'</span>).agg({</span>
<span id="cb42-1625"><a href="#cb42-1625" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Actual'</span>: <span class="st">'sum'</span>,</span>
<span id="cb42-1626"><a href="#cb42-1626" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_H2'</span>: <span class="st">'sum'</span>,  <span class="co"># Keep original for comparison</span></span>
<span id="cb42-1627"><a href="#cb42-1627" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Forecast_Modified'</span>: <span class="st">'sum'</span></span>
<span id="cb42-1628"><a href="#cb42-1628" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb42-1629"><a href="#cb42-1629" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1630"><a href="#cb42-1630" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Ï for MODIFIED forecasts</span></span>
<span id="cb42-1631"><a href="#cb42-1631" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_modified'</span>] <span class="op">=</span> (</span>
<span id="cb42-1632"><a href="#cb42-1632" aria-hidden="true" tabindex="-1"></a>        (monthly_stats[<span class="st">'Forecast_Modified'</span>] <span class="op">-</span> monthly_stats[<span class="st">'Actual'</span>]) <span class="op">/</span> </span>
<span id="cb42-1633"><a href="#cb42-1633" aria-hidden="true" tabindex="-1"></a>        monthly_stats[<span class="st">'Actual'</span>]</span>
<span id="cb42-1634"><a href="#cb42-1634" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-1635"><a href="#cb42-1635" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_modified_pct'</span>] <span class="op">=</span> monthly_stats[<span class="st">'rho_modified'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-1636"><a href="#cb42-1636" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1637"><a href="#cb42-1637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep original Ï for comparison</span></span>
<span id="cb42-1638"><a href="#cb42-1638" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_original'</span>] <span class="op">=</span> (</span>
<span id="cb42-1639"><a href="#cb42-1639" aria-hidden="true" tabindex="-1"></a>        (monthly_stats[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> monthly_stats[<span class="st">'Actual'</span>]) <span class="op">/</span> </span>
<span id="cb42-1640"><a href="#cb42-1640" aria-hidden="true" tabindex="-1"></a>        monthly_stats[<span class="st">'Actual'</span>]</span>
<span id="cb42-1641"><a href="#cb42-1641" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-1642"><a href="#cb42-1642" aria-hidden="true" tabindex="-1"></a>    monthly_stats[<span class="st">'rho_original_pct'</span>] <span class="op">=</span> monthly_stats[<span class="st">'rho_original'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-1643"><a href="#cb42-1643" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1644"><a href="#cb42-1644" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count weeks per month</span></span>
<span id="cb42-1645"><a href="#cb42-1645" aria-hidden="true" tabindex="-1"></a>    weeks_per_month <span class="op">=</span> forecast_df_modified.groupby(<span class="st">'YearMonth'</span>).size().reset_index(name<span class="op">=</span><span class="st">'num_weeks'</span>)</span>
<span id="cb42-1646"><a href="#cb42-1646" aria-hidden="true" tabindex="-1"></a>    monthly_stats <span class="op">=</span> monthly_stats.merge(weeks_per_month, on<span class="op">=</span><span class="st">'YearMonth'</span>)</span>
<span id="cb42-1647"><a href="#cb42-1647" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1648"><a href="#cb42-1648" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Calculated Ï for </span><span class="sc">{</span><span class="bu">len</span>(monthly_stats)<span class="sc">}</span><span class="ss"> months with modified forecasts"</span>)</span>
<span id="cb42-1649"><a href="#cb42-1649" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1650"><a href="#cb42-1650" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_stats</span>
<span id="cb42-1651"><a href="#cb42-1651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1652"><a href="#cb42-1652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1655"><a href="#cb42-1655" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1656"><a href="#cb42-1656" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_strategy_performance(monthly_stats_modified, forecast_df_modified, X):</span>
<span id="cb42-1657"><a href="#cb42-1657" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1658"><a href="#cb42-1658" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate the strategy on last 12 months.</span></span>
<span id="cb42-1659"><a href="#cb42-1659" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1660"><a href="#cb42-1660" aria-hidden="true" tabindex="-1"></a><span class="co">    This answers:</span></span>
<span id="cb42-1661"><a href="#cb42-1661" aria-hidden="true" tabindex="-1"></a><span class="co">    - Question 3a: How many MORE months qualify?</span></span>
<span id="cb42-1662"><a href="#cb42-1662" aria-hidden="true" tabindex="-1"></a><span class="co">    - Question 3b: How much accuracy do we lose?</span></span>
<span id="cb42-1663"><a href="#cb42-1663" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1664"><a href="#cb42-1664" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-1665"><a href="#cb42-1665" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-1666"><a href="#cb42-1666" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_modified : DataFrame with modified monthly Ï</span></span>
<span id="cb42-1667"><a href="#cb42-1667" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_df_modified : DataFrame with modified forecasts</span></span>
<span id="cb42-1668"><a href="#cb42-1668" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float, the bracket percentage</span></span>
<span id="cb42-1669"><a href="#cb42-1669" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-1670"><a href="#cb42-1670" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-1671"><a href="#cb42-1671" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-1672"><a href="#cb42-1672" aria-hidden="true" tabindex="-1"></a><span class="co">    evaluation : dict with all metrics</span></span>
<span id="cb42-1673"><a href="#cb42-1673" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1674"><a href="#cb42-1674" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1675"><a href="#cb42-1675" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1676"><a href="#cb42-1676" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"EVALUATING STRATEGY PERFORMANCE"</span>)</span>
<span id="cb42-1677"><a href="#cb42-1677" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1678"><a href="#cb42-1678" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1679"><a href="#cb42-1679" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get last 12 months</span></span>
<span id="cb42-1680"><a href="#cb42-1680" aria-hidden="true" tabindex="-1"></a>    last_12_original <span class="op">=</span> monthly_stats_modified.tail(<span class="dv">12</span>).copy()</span>
<span id="cb42-1681"><a href="#cb42-1681" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1682"><a href="#cb42-1682" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply bracket to both original and modified</span></span>
<span id="cb42-1683"><a href="#cb42-1683" aria-hidden="true" tabindex="-1"></a>    last_12_original[<span class="st">'qualifies_original'</span>] <span class="op">=</span> last_12_original[<span class="st">'rho_original_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb42-1684"><a href="#cb42-1684" aria-hidden="true" tabindex="-1"></a>    last_12_original[<span class="st">'qualifies_modified'</span>] <span class="op">=</span> last_12_original[<span class="st">'rho_modified_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb42-1685"><a href="#cb42-1685" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1686"><a href="#cb42-1686" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count qualifying months</span></span>
<span id="cb42-1687"><a href="#cb42-1687" aria-hidden="true" tabindex="-1"></a>    original_qualifying <span class="op">=</span> last_12_original[<span class="st">'qualifies_original'</span>].<span class="bu">sum</span>()</span>
<span id="cb42-1688"><a href="#cb42-1688" aria-hidden="true" tabindex="-1"></a>    modified_qualifying <span class="op">=</span> last_12_original[<span class="st">'qualifies_modified'</span>].<span class="bu">sum</span>()</span>
<span id="cb42-1689"><a href="#cb42-1689" aria-hidden="true" tabindex="-1"></a>    additional_months <span class="op">=</span> modified_qualifying <span class="op">-</span> original_qualifying</span>
<span id="cb42-1690"><a href="#cb42-1690" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1691"><a href="#cb42-1691" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1692"><a href="#cb42-1692" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"QUESTION 3a: HOW MANY MORE MONTHS QUALIFY?"</span>)</span>
<span id="cb42-1693"><a href="#cb42-1693" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1694"><a href="#cb42-1694" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1695"><a href="#cb42-1695" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Original forecasts:  </span><span class="sc">{</span>original_qualifying<span class="sc">}</span><span class="ss">/12 months qualify"</span>)</span>
<span id="cb42-1696"><a href="#cb42-1696" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Modified forecasts:  </span><span class="sc">{</span>modified_qualifying<span class="sc">}</span><span class="ss">/12 months qualify"</span>)</span>
<span id="cb42-1697"><a href="#cb42-1697" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Additional months:   </span><span class="sc">{</span>additional_months<span class="sc">:+d}</span><span class="ss"> months"</span>)</span>
<span id="cb42-1698"><a href="#cb42-1698" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1699"><a href="#cb42-1699" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> additional_months <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb42-1700"><a href="#cb42-1700" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> SUCCESS: Strategy adds </span><span class="sc">{</span>additional_months<span class="sc">}</span><span class="ss"> qualifying month(s)!"</span>)</span>
<span id="cb42-1701"><a href="#cb42-1701" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> additional_months <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb42-1702"><a href="#cb42-1702" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> NEUTRAL: Strategy maintains same qualification rate"</span>)</span>
<span id="cb42-1703"><a href="#cb42-1703" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb42-1704"><a href="#cb42-1704" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> WARNING: Strategy loses </span><span class="sc">{</span><span class="bu">abs</span>(additional_months)<span class="sc">}</span><span class="ss"> qualifying month(s)"</span>)</span>
<span id="cb42-1705"><a href="#cb42-1705" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1706"><a href="#cb42-1706" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show which months changed status</span></span>
<span id="cb42-1707"><a href="#cb42-1707" aria-hidden="true" tabindex="-1"></a>    status_changes <span class="op">=</span> last_12_original[</span>
<span id="cb42-1708"><a href="#cb42-1708" aria-hidden="true" tabindex="-1"></a>        last_12_original[<span class="st">'qualifies_original'</span>] <span class="op">!=</span> last_12_original[<span class="st">'qualifies_modified'</span>]</span>
<span id="cb42-1709"><a href="#cb42-1709" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb42-1710"><a href="#cb42-1710" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1711"><a href="#cb42-1711" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(status_changes) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb42-1712"><a href="#cb42-1712" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Months that CHANGED qualification status:"</span>)</span>
<span id="cb42-1713"><a href="#cb42-1713" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1714"><a href="#cb42-1714" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> status_changes.iterrows():</span>
<span id="cb42-1715"><a href="#cb42-1715" aria-hidden="true" tabindex="-1"></a>            old_status <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> row[<span class="st">'qualifies_original'</span>] <span class="cf">else</span> <span class="st">"âœ—"</span></span>
<span id="cb42-1716"><a href="#cb42-1716" aria-hidden="true" tabindex="-1"></a>            new_status <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> row[<span class="st">'qualifies_modified'</span>] <span class="cf">else</span> <span class="st">"âœ—"</span></span>
<span id="cb42-1717"><a href="#cb42-1717" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>row[<span class="st">'YearMonth'</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>old_status<span class="sc">}</span><span class="ss"> â†’ </span><span class="sc">{</span>new_status<span class="sc">}</span><span class="ss">  "</span></span>
<span id="cb42-1718"><a href="#cb42-1718" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"(Ï: </span><span class="sc">{</span>row[<span class="st">'rho_original_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">% â†’ </span><span class="sc">{</span>row[<span class="st">'rho_modified_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-1719"><a href="#cb42-1719" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1720"><a href="#cb42-1720" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate accuracy metrics (Question 3b)</span></span>
<span id="cb42-1721"><a href="#cb42-1721" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1722"><a href="#cb42-1722" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"QUESTION 3b: HOW MUCH ACCURACY DO WE LOSE?"</span>)</span>
<span id="cb42-1723"><a href="#cb42-1723" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb42-1724"><a href="#cb42-1724" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1725"><a href="#cb42-1725" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weekly forecast accuracy</span></span>
<span id="cb42-1726"><a href="#cb42-1726" aria-hidden="true" tabindex="-1"></a>    mae_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_H2'</span>]))</span>
<span id="cb42-1727"><a href="#cb42-1727" aria-hidden="true" tabindex="-1"></a>    mae_modified <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_Modified'</span>]))</span>
<span id="cb42-1728"><a href="#cb42-1728" aria-hidden="true" tabindex="-1"></a>    mae_change <span class="op">=</span> mae_modified <span class="op">-</span> mae_original</span>
<span id="cb42-1729"><a href="#cb42-1729" aria-hidden="true" tabindex="-1"></a>    mae_change_pct <span class="op">=</span> (mae_change <span class="op">/</span> mae_original) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-1730"><a href="#cb42-1730" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1731"><a href="#cb42-1731" aria-hidden="true" tabindex="-1"></a>    mape_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb42-1732"><a href="#cb42-1732" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_H2'</span>]) <span class="op">/</span> </span>
<span id="cb42-1733"><a href="#cb42-1733" aria-hidden="true" tabindex="-1"></a>        forecast_df_modified[<span class="st">'Actual'</span>]</span>
<span id="cb42-1734"><a href="#cb42-1734" aria-hidden="true" tabindex="-1"></a>    )) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-1735"><a href="#cb42-1735" aria-hidden="true" tabindex="-1"></a>    mape_modified <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb42-1736"><a href="#cb42-1736" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_Modified'</span>]) <span class="op">/</span> </span>
<span id="cb42-1737"><a href="#cb42-1737" aria-hidden="true" tabindex="-1"></a>        forecast_df_modified[<span class="st">'Actual'</span>]</span>
<span id="cb42-1738"><a href="#cb42-1738" aria-hidden="true" tabindex="-1"></a>    )) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-1739"><a href="#cb42-1739" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1740"><a href="#cb42-1740" aria-hidden="true" tabindex="-1"></a>    rmse_original <span class="op">=</span> np.sqrt(np.mean(</span>
<span id="cb42-1741"><a href="#cb42-1741" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_H2'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb42-1742"><a href="#cb42-1742" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb42-1743"><a href="#cb42-1743" aria-hidden="true" tabindex="-1"></a>    rmse_modified <span class="op">=</span> np.sqrt(np.mean(</span>
<span id="cb42-1744"><a href="#cb42-1744" aria-hidden="true" tabindex="-1"></a>        (forecast_df_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_df_modified[<span class="st">'Forecast_Modified'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb42-1745"><a href="#cb42-1745" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb42-1746"><a href="#cb42-1746" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1747"><a href="#cb42-1747" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Weekly Forecast Accuracy:"</span>)</span>
<span id="cb42-1748"><a href="#cb42-1748" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1749"><a href="#cb42-1749" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Metric'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Original'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Modified'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Change'</span><span class="sc">:&lt;15}</span><span class="ss">"</span>)</span>
<span id="cb42-1750"><a href="#cb42-1750" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1751"><a href="#cb42-1751" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'MAE'</span><span class="sc">:&lt;15}</span><span class="ss"> $</span><span class="sc">{</span>mae_original<span class="sc">:&lt;14,.2f}</span><span class="ss"> $</span><span class="sc">{</span>mae_modified<span class="sc">:&lt;14,.2f}</span><span class="ss"> </span><span class="sc">{</span>mae_change<span class="sc">:+,.2f}</span><span class="ss"> (</span><span class="sc">{</span>mae_change_pct<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-1752"><a href="#cb42-1752" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'MAPE'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span>mape_original<span class="sc">:&lt;14.2f}</span><span class="ss">% </span><span class="sc">{</span>mape_modified<span class="sc">:&lt;14.2f}</span><span class="ss">% </span><span class="sc">{</span>mape_modified<span class="op">-</span>mape_original<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1753"><a href="#cb42-1753" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'RMSE'</span><span class="sc">:&lt;15}</span><span class="ss"> $</span><span class="sc">{</span>rmse_original<span class="sc">:&lt;14,.2f}</span><span class="ss"> $</span><span class="sc">{</span>rmse_modified<span class="sc">:&lt;14,.2f}</span><span class="ss"> </span><span class="sc">{</span>rmse_modified<span class="op">-</span>rmse_original<span class="sc">:+,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-1754"><a href="#cb42-1754" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1755"><a href="#cb42-1755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mae_change_pct <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb42-1756"><a href="#cb42-1756" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> EXCELLENT: Accuracy IMPROVED by </span><span class="sc">{</span><span class="bu">abs</span>(mae_change_pct)<span class="sc">:.2f}</span><span class="ss">%!"</span>)</span>
<span id="cb42-1757"><a href="#cb42-1757" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   This is a WIN-WIN: More rebates + Better accuracy"</span>)</span>
<span id="cb42-1758"><a href="#cb42-1758" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mae_change_pct <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb42-1759"><a href="#cb42-1759" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">â†’ ACCEPTABLE: Small accuracy loss of </span><span class="sc">{</span>mae_change_pct<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1760"><a href="#cb42-1760" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Trade-off is worth it for </span><span class="sc">{</span>additional_months<span class="sc">}</span><span class="ss"> additional month(s)"</span>)</span>
<span id="cb42-1761"><a href="#cb42-1761" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb42-1762"><a href="#cb42-1762" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  CAUTION: Accuracy degraded by </span><span class="sc">{</span>mae_change_pct<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-1763"><a href="#cb42-1763" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1764"><a href="#cb42-1764" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly-level accuracy (for the last 12 months)</span></span>
<span id="cb42-1765"><a href="#cb42-1765" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Monthly Forecast Accuracy (Last 12 Months):"</span>)</span>
<span id="cb42-1766"><a href="#cb42-1766" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-1767"><a href="#cb42-1767" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1768"><a href="#cb42-1768" aria-hidden="true" tabindex="-1"></a>    monthly_mae_original <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb42-1769"><a href="#cb42-1769" aria-hidden="true" tabindex="-1"></a>        last_12_original[<span class="st">'Forecast_H2'</span>] <span class="op">-</span> last_12_original[<span class="st">'Actual'</span>]</span>
<span id="cb42-1770"><a href="#cb42-1770" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb42-1771"><a href="#cb42-1771" aria-hidden="true" tabindex="-1"></a>    monthly_mae_modified <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb42-1772"><a href="#cb42-1772" aria-hidden="true" tabindex="-1"></a>        last_12_original[<span class="st">'Forecast_Modified'</span>] <span class="op">-</span> last_12_original[<span class="st">'Actual'</span>]</span>
<span id="cb42-1773"><a href="#cb42-1773" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb42-1774"><a href="#cb42-1774" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1775"><a href="#cb42-1775" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Monthly MAE (Original):  $</span><span class="sc">{</span>monthly_mae_original<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-1776"><a href="#cb42-1776" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Monthly MAE (Modified):  $</span><span class="sc">{</span>monthly_mae_modified<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-1777"><a href="#cb42-1777" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Change:                  </span><span class="sc">{</span>monthly_mae_modified <span class="op">-</span> monthly_mae_original<span class="sc">:+,.2f}</span><span class="ss"> "</span></span>
<span id="cb42-1778"><a href="#cb42-1778" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"(</span><span class="sc">{</span>(monthly_mae_modified <span class="op">-</span> monthly_mae_original)<span class="op">/</span>monthly_mae_original<span class="op">*</span><span class="dv">100</span><span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-1779"><a href="#cb42-1779" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1780"><a href="#cb42-1780" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return all metrics</span></span>
<span id="cb42-1781"><a href="#cb42-1781" aria-hidden="true" tabindex="-1"></a>    evaluation <span class="op">=</span> {</span>
<span id="cb42-1782"><a href="#cb42-1782" aria-hidden="true" tabindex="-1"></a>        <span class="st">'last_12_stats'</span>: last_12_original,</span>
<span id="cb42-1783"><a href="#cb42-1783" aria-hidden="true" tabindex="-1"></a>        <span class="st">'original_qualifying'</span>: original_qualifying,</span>
<span id="cb42-1784"><a href="#cb42-1784" aria-hidden="true" tabindex="-1"></a>        <span class="st">'modified_qualifying'</span>: modified_qualifying,</span>
<span id="cb42-1785"><a href="#cb42-1785" aria-hidden="true" tabindex="-1"></a>        <span class="st">'additional_months'</span>: additional_months,</span>
<span id="cb42-1786"><a href="#cb42-1786" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_original'</span>: mae_original,</span>
<span id="cb42-1787"><a href="#cb42-1787" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_modified'</span>: mae_modified,</span>
<span id="cb42-1788"><a href="#cb42-1788" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_change'</span>: mae_change,</span>
<span id="cb42-1789"><a href="#cb42-1789" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mae_change_pct'</span>: mae_change_pct,</span>
<span id="cb42-1790"><a href="#cb42-1790" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mape_original'</span>: mape_original,</span>
<span id="cb42-1791"><a href="#cb42-1791" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mape_modified'</span>: mape_modified,</span>
<span id="cb42-1792"><a href="#cb42-1792" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rmse_original'</span>: rmse_original,</span>
<span id="cb42-1793"><a href="#cb42-1793" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rmse_modified'</span>: rmse_modified,</span>
<span id="cb42-1794"><a href="#cb42-1794" aria-hidden="true" tabindex="-1"></a>        <span class="st">'status_changes'</span>: status_changes</span>
<span id="cb42-1795"><a href="#cb42-1795" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-1796"><a href="#cb42-1796" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1797"><a href="#cb42-1797" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> evaluation</span>
<span id="cb42-1798"><a href="#cb42-1798" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-1799"><a href="#cb42-1799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-1802"><a href="#cb42-1802" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-1803"><a href="#cb42-1803" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_strategy_results(last_12_stats, X, evaluation):</span>
<span id="cb42-1804"><a href="#cb42-1804" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-1805"><a href="#cb42-1805" aria-hidden="true" tabindex="-1"></a><span class="co">    Comprehensive visualization of strategy results.</span></span>
<span id="cb42-1806"><a href="#cb42-1806" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-1807"><a href="#cb42-1807" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1808"><a href="#cb42-1808" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">14</span>))</span>
<span id="cb42-1809"><a href="#cb42-1809" aria-hidden="true" tabindex="-1"></a>    gs <span class="op">=</span> fig.add_gridspec(<span class="dv">3</span>, <span class="dv">3</span>, hspace<span class="op">=</span><span class="fl">0.35</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-1810"><a href="#cb42-1810" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1811"><a href="#cb42-1811" aria-hidden="true" tabindex="-1"></a>    month_labels <span class="op">=</span> [<span class="bu">str</span>(m) <span class="cf">for</span> m <span class="kw">in</span> last_12_stats[<span class="st">'YearMonth'</span>]]</span>
<span id="cb42-1812"><a href="#cb42-1812" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1813"><a href="#cb42-1813" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Original vs Modified Ï (MAIN COMPARISON)</span></span>
<span id="cb42-1814"><a href="#cb42-1814" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb42-1815"><a href="#cb42-1815" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1816"><a href="#cb42-1816" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.arange(<span class="bu">len</span>(last_12_stats))</span>
<span id="cb42-1817"><a href="#cb42-1817" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb42-1818"><a href="#cb42-1818" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1819"><a href="#cb42-1819" aria-hidden="true" tabindex="-1"></a>    colors_original <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> q <span class="kw">in</span> last_12_stats[<span class="st">'qualifies_original'</span>]]</span>
<span id="cb42-1820"><a href="#cb42-1820" aria-hidden="true" tabindex="-1"></a>    colors_modified <span class="op">=</span> [<span class="st">'darkgreen'</span> <span class="cf">if</span> q <span class="cf">else</span> <span class="st">'darkred'</span> <span class="cf">for</span> q <span class="kw">in</span> last_12_stats[<span class="st">'qualifies_modified'</span>]]</span>
<span id="cb42-1821"><a href="#cb42-1821" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1822"><a href="#cb42-1822" aria-hidden="true" tabindex="-1"></a>    bars1 <span class="op">=</span> ax1.bar(x <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, last_12_stats[<span class="st">'rho_original_pct'</span>], width,</span>
<span id="cb42-1823"><a href="#cb42-1823" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="st">'Original Forecasts'</span>, color<span class="op">=</span>colors_original, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb42-1824"><a href="#cb42-1824" aria-hidden="true" tabindex="-1"></a>    bars2 <span class="op">=</span> ax1.bar(x <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, last_12_stats[<span class="st">'rho_modified_pct'</span>], width,</span>
<span id="cb42-1825"><a href="#cb42-1825" aria-hidden="true" tabindex="-1"></a>                    label<span class="op">=</span><span class="st">'Modified Forecasts (Conservative)'</span>, color<span class="op">=</span>colors_modified, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb42-1826"><a href="#cb42-1826" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1827"><a href="#cb42-1827" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, label<span class="op">=</span><span class="ss">f'Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-1828"><a href="#cb42-1828" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-1829"><a href="#cb42-1829" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-1830"><a href="#cb42-1830" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1831"><a href="#cb42-1831" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticks(x)</span>
<span id="cb42-1832"><a href="#cb42-1832" aria-hidden="true" tabindex="-1"></a>    ax1.set_xticklabels(month_labels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-1833"><a href="#cb42-1833" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Month (Last 12 Months)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1834"><a href="#cb42-1834" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1835"><a href="#cb42-1835" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="ss">f'Original vs Modified Forecasts - Rebate KPI Comparison</span><span class="ch">\n</span><span class="ss">'</span></span>
<span id="cb42-1836"><a href="#cb42-1836" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f'Original: </span><span class="sc">{</span>evaluation[<span class="st">"original_qualifying"</span>]<span class="sc">}</span><span class="ss">/12 qualify  â†’  '</span></span>
<span id="cb42-1837"><a href="#cb42-1837" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f'Modified: </span><span class="sc">{</span>evaluation[<span class="st">"modified_qualifying"</span>]<span class="sc">}</span><span class="ss">/12 qualify  '</span></span>
<span id="cb42-1838"><a href="#cb42-1838" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f'(</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="sc">:+d}</span><span class="ss"> months)'</span>,</span>
<span id="cb42-1839"><a href="#cb42-1839" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1840"><a href="#cb42-1840" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">12</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb42-1841"><a href="#cb42-1841" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1842"><a href="#cb42-1842" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1843"><a href="#cb42-1843" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: Change in Ï for each month</span></span>
<span id="cb42-1844"><a href="#cb42-1844" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb42-1845"><a href="#cb42-1845" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1846"><a href="#cb42-1846" aria-hidden="true" tabindex="-1"></a>    rho_change <span class="op">=</span> last_12_stats[<span class="st">'rho_modified_pct'</span>] <span class="op">-</span> last_12_stats[<span class="st">'rho_original_pct'</span>]</span>
<span id="cb42-1847"><a href="#cb42-1847" aria-hidden="true" tabindex="-1"></a>    colors_change <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> c <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'orange'</span> <span class="cf">for</span> c <span class="kw">in</span> rho_change]</span>
<span id="cb42-1848"><a href="#cb42-1848" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1849"><a href="#cb42-1849" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax2.bar(x, rho_change, color<span class="op">=</span>colors_change, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-1850"><a href="#cb42-1850" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb42-1851"><a href="#cb42-1851" aria-hidden="true" tabindex="-1"></a>    ax2.set_xticks(x)</span>
<span id="cb42-1852"><a href="#cb42-1852" aria-hidden="true" tabindex="-1"></a>    ax2.set_xticklabels(month_labels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-1853"><a href="#cb42-1853" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Month'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1854"><a href="#cb42-1854" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Î”Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1855"><a href="#cb42-1855" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Change in Ï (Modified - Original)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1856"><a href="#cb42-1856" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1857"><a href="#cb42-1857" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1858"><a href="#cb42-1858" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels</span></span>
<span id="cb42-1859"><a href="#cb42-1859" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bar, val <span class="kw">in</span> <span class="bu">zip</span>(bars, rho_change):</span>
<span id="cb42-1860"><a href="#cb42-1860" aria-hidden="true" tabindex="-1"></a>        height <span class="op">=</span> bar.get_height()</span>
<span id="cb42-1861"><a href="#cb42-1861" aria-hidden="true" tabindex="-1"></a>        ax2.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb42-1862"><a href="#cb42-1862" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:+.1f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1863"><a href="#cb42-1863" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span> <span class="cf">if</span> height <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'top'</span>, </span>
<span id="cb42-1864"><a href="#cb42-1864" aria-hidden="true" tabindex="-1"></a>                fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb42-1865"><a href="#cb42-1865" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1866"><a href="#cb42-1866" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Forecast accuracy comparison</span></span>
<span id="cb42-1867"><a href="#cb42-1867" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb42-1868"><a href="#cb42-1868" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1869"><a href="#cb42-1869" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">'MAE'</span>, <span class="st">'MAPE'</span>, <span class="st">'RMSE'</span>]</span>
<span id="cb42-1870"><a href="#cb42-1870" aria-hidden="true" tabindex="-1"></a>    original_vals <span class="op">=</span> [evaluation[<span class="st">'mae_original'</span>], evaluation[<span class="st">'mape_original'</span>], evaluation[<span class="st">'rmse_original'</span>]]</span>
<span id="cb42-1871"><a href="#cb42-1871" aria-hidden="true" tabindex="-1"></a>    modified_vals <span class="op">=</span> [evaluation[<span class="st">'mae_modified'</span>], evaluation[<span class="st">'mape_modified'</span>], evaluation[<span class="st">'rmse_modified'</span>]]</span>
<span id="cb42-1872"><a href="#cb42-1872" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1873"><a href="#cb42-1873" aria-hidden="true" tabindex="-1"></a>    x_metrics <span class="op">=</span> np.arange(<span class="bu">len</span>(metrics))</span>
<span id="cb42-1874"><a href="#cb42-1874" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb42-1875"><a href="#cb42-1875" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1876"><a href="#cb42-1876" aria-hidden="true" tabindex="-1"></a>    bars1 <span class="op">=</span> ax3.bar(x_metrics <span class="op">-</span> width<span class="op">/</span><span class="dv">2</span>, original_vals, width, label<span class="op">=</span><span class="st">'Original'</span>, </span>
<span id="cb42-1877"><a href="#cb42-1877" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-1878"><a href="#cb42-1878" aria-hidden="true" tabindex="-1"></a>    bars2 <span class="op">=</span> ax3.bar(x_metrics <span class="op">+</span> width<span class="op">/</span><span class="dv">2</span>, modified_vals, width, label<span class="op">=</span><span class="st">'Modified'</span>,</span>
<span id="cb42-1879"><a href="#cb42-1879" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-1880"><a href="#cb42-1880" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1881"><a href="#cb42-1881" aria-hidden="true" tabindex="-1"></a>    ax3.set_xticks(x_metrics)</span>
<span id="cb42-1882"><a href="#cb42-1882" aria-hidden="true" tabindex="-1"></a>    ax3.set_xticklabels(metrics)</span>
<span id="cb42-1883"><a href="#cb42-1883" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Value'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1884"><a href="#cb42-1884" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Forecast Accuracy: Original vs Modified'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1885"><a href="#cb42-1885" aria-hidden="true" tabindex="-1"></a>    ax3.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-1886"><a href="#cb42-1886" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-1887"><a href="#cb42-1887" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1888"><a href="#cb42-1888" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels</span></span>
<span id="cb42-1889"><a href="#cb42-1889" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bars <span class="kw">in</span> [bars1, bars2]:</span>
<span id="cb42-1890"><a href="#cb42-1890" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar <span class="kw">in</span> bars:</span>
<span id="cb42-1891"><a href="#cb42-1891" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> bar.get_height()</span>
<span id="cb42-1892"><a href="#cb42-1892" aria-hidden="true" tabindex="-1"></a>            ax3.text(bar.get_x() <span class="op">+</span> bar.get_width()<span class="op">/</span><span class="fl">2.</span>, height,</span>
<span id="cb42-1893"><a href="#cb42-1893" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f'</span><span class="sc">{</span>height<span class="sc">:.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-1894"><a href="#cb42-1894" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb42-1895"><a href="#cb42-1895" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1896"><a href="#cb42-1896" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Qualification status matrix</span></span>
<span id="cb42-1897"><a href="#cb42-1897" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb42-1898"><a href="#cb42-1898" aria-hidden="true" tabindex="-1"></a>    ax4.axis(<span class="st">'off'</span>)</span>
<span id="cb42-1899"><a href="#cb42-1899" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1900"><a href="#cb42-1900" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count status changes</span></span>
<span id="cb42-1901"><a href="#cb42-1901" aria-hidden="true" tabindex="-1"></a>    stayed_qualified <span class="op">=</span> ((last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb42-1902"><a href="#cb42-1902" aria-hidden="true" tabindex="-1"></a>    stayed_unqualified <span class="op">=</span> ((<span class="op">~</span>last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (<span class="op">~</span>last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb42-1903"><a href="#cb42-1903" aria-hidden="true" tabindex="-1"></a>    became_qualified <span class="op">=</span> ((<span class="op">~</span>last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb42-1904"><a href="#cb42-1904" aria-hidden="true" tabindex="-1"></a>    became_unqualified <span class="op">=</span> ((last_12_stats[<span class="st">'qualifies_original'</span>]) <span class="op">&amp;</span> (<span class="op">~</span>last_12_stats[<span class="st">'qualifies_modified'</span>])).<span class="bu">sum</span>()</span>
<span id="cb42-1905"><a href="#cb42-1905" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1906"><a href="#cb42-1906" aria-hidden="true" tabindex="-1"></a>    status_text <span class="op">=</span> [</span>
<span id="cb42-1907"><a href="#cb42-1907" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Status Change Matrix'</span>, <span class="st">'Count'</span>],</span>
<span id="cb42-1908"><a href="#cb42-1908" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'â”€'</span><span class="op">*</span><span class="dv">30</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">8</span>],</span>
<span id="cb42-1909"><a href="#cb42-1909" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Stayed Qualified âœ“â†’âœ“'</span>, <span class="ss">f'</span><span class="sc">{</span>stayed_qualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb42-1910"><a href="#cb42-1910" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Became Qualified âœ—â†’âœ“'</span>, <span class="ss">f'</span><span class="sc">{</span>became_qualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb42-1911"><a href="#cb42-1911" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Became Unqualified âœ“â†’âœ—'</span>, <span class="ss">f'</span><span class="sc">{</span>became_unqualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb42-1912"><a href="#cb42-1912" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Stayed Unqualified âœ—â†’âœ—'</span>, <span class="ss">f'</span><span class="sc">{</span>stayed_unqualified<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb42-1913"><a href="#cb42-1913" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1914"><a href="#cb42-1914" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Net Change'</span>, <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="sc">:+d}</span><span class="ss">'</span>],</span>
<span id="cb42-1915"><a href="#cb42-1915" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb42-1916"><a href="#cb42-1916" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1917"><a href="#cb42-1917" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax4.table(cellText<span class="op">=</span>status_text, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb42-1918"><a href="#cb42-1918" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="dv">1</span>, <span class="fl">0.7</span>])</span>
<span id="cb42-1919"><a href="#cb42-1919" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb42-1920"><a href="#cb42-1920" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">11</span>)</span>
<span id="cb42-1921"><a href="#cb42-1921" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb42-1922"><a href="#cb42-1922" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1923"><a href="#cb42-1923" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style</span></span>
<span id="cb42-1924"><a href="#cb42-1924" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">7</span>]:</span>
<span id="cb42-1925"><a href="#cb42-1925" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb42-1926"><a href="#cb42-1926" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb42-1927"><a href="#cb42-1927" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb42-1928"><a href="#cb42-1928" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1929"><a href="#cb42-1929" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight gains</span></span>
<span id="cb42-1930"><a href="#cb42-1930" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> became_qualified <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb42-1931"><a href="#cb42-1931" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">3</span>, <span class="dv">0</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb42-1932"><a href="#cb42-1932" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">3</span>, <span class="dv">1</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb42-1933"><a href="#cb42-1933" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1934"><a href="#cb42-1934" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Qualification Status Changes'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb42-1935"><a href="#cb42-1935" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1936"><a href="#cb42-1936" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 5: Distribution comparison</span></span>
<span id="cb42-1937"><a href="#cb42-1937" aria-hidden="true" tabindex="-1"></a>    ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb42-1938"><a href="#cb42-1938" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1939"><a href="#cb42-1939" aria-hidden="true" tabindex="-1"></a>    ax5.hist(last_12_stats[<span class="st">'rho_original_pct'</span>], bins<span class="op">=</span><span class="dv">8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, </span>
<span id="cb42-1940"><a href="#cb42-1940" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Original'</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-1941"><a href="#cb42-1941" aria-hidden="true" tabindex="-1"></a>    ax5.hist(last_12_stats[<span class="st">'rho_modified_pct'</span>], bins<span class="op">=</span><span class="dv">8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb42-1942"><a href="#cb42-1942" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Modified'</span>, color<span class="op">=</span><span class="st">'coral'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-1943"><a href="#cb42-1943" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(<span class="op">-</span>X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb42-1944"><a href="#cb42-1944" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(X, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-1945"><a href="#cb42-1945" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-1946"><a href="#cb42-1946" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1947"><a href="#cb42-1947" aria-hidden="true" tabindex="-1"></a>    ax5.set_xlabel(<span class="st">'Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1948"><a href="#cb42-1948" aria-hidden="true" tabindex="-1"></a>    ax5.set_ylabel(<span class="st">'Count'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1949"><a href="#cb42-1949" aria-hidden="true" tabindex="-1"></a>    ax5.set_title(<span class="st">'Distribution of Ï Values'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-1950"><a href="#cb42-1950" aria-hidden="true" tabindex="-1"></a>    ax5.legend(fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb42-1951"><a href="#cb42-1951" aria-hidden="true" tabindex="-1"></a>    ax5.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-1952"><a href="#cb42-1952" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1953"><a href="#cb42-1953" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 6: Summary statistics</span></span>
<span id="cb42-1954"><a href="#cb42-1954" aria-hidden="true" tabindex="-1"></a>    ax6 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>:])</span>
<span id="cb42-1955"><a href="#cb42-1955" aria-hidden="true" tabindex="-1"></a>    ax6.axis(<span class="st">'off'</span>)</span>
<span id="cb42-1956"><a href="#cb42-1956" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1957"><a href="#cb42-1957" aria-hidden="true" tabindex="-1"></a>    summary_text <span class="op">=</span> [</span>
<span id="cb42-1958"><a href="#cb42-1958" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Metric'</span>, <span class="st">'Original'</span>, <span class="st">'Modified'</span>, <span class="st">'Change'</span>],</span>
<span id="cb42-1959"><a href="#cb42-1959" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'â”€'</span><span class="op">*</span><span class="dv">35</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">12</span>, <span class="st">'â”€'</span><span class="op">*</span><span class="dv">15</span>],</span>
<span id="cb42-1960"><a href="#cb42-1960" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'QUESTION 3a: Rebate Performance'</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1961"><a href="#cb42-1961" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Qualifying Months (/</span><span class="sc">{</span><span class="bu">len</span>(last_12_stats)<span class="sc">}</span><span class="ss">)'</span>, </span>
<span id="cb42-1962"><a href="#cb42-1962" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"original_qualifying"</span>]<span class="sc">}</span><span class="ss">'</span>, </span>
<span id="cb42-1963"><a href="#cb42-1963" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"modified_qualifying"</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb42-1964"><a href="#cb42-1964" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="sc">:+d}</span><span class="ss">'</span>],</span>
<span id="cb42-1965"><a href="#cb42-1965" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Success Rate'</span>, </span>
<span id="cb42-1966"><a href="#cb42-1966" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"original_qualifying"</span>]<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1967"><a href="#cb42-1967" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"modified_qualifying"</span>]<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1968"><a href="#cb42-1968" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"additional_months"</span>]<span class="op">/</span><span class="bu">len</span>(last_12_stats)<span class="op">*</span><span class="dv">100</span><span class="sc">:+.0f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1969"><a href="#cb42-1969" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1970"><a href="#cb42-1970" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'QUESTION 3b: Accuracy Impact'</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1971"><a href="#cb42-1971" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  MAE (Weekly)'</span>, </span>
<span id="cb42-1972"><a href="#cb42-1972" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"mae_original"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-1973"><a href="#cb42-1973" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"mae_modified"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-1974"><a href="#cb42-1974" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mae_change_pct"</span>]<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1975"><a href="#cb42-1975" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  MAPE (Weekly)'</span>,</span>
<span id="cb42-1976"><a href="#cb42-1976" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mape_original"</span>]<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1977"><a href="#cb42-1977" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mape_modified"</span>]<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1978"><a href="#cb42-1978" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>evaluation[<span class="st">"mape_modified"</span>]<span class="op">-</span>evaluation[<span class="st">"mape_original"</span>]<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1979"><a href="#cb42-1979" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  RMSE (Weekly)'</span>,</span>
<span id="cb42-1980"><a href="#cb42-1980" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"rmse_original"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-1981"><a href="#cb42-1981" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"rmse_modified"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-1982"><a href="#cb42-1982" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'$</span><span class="sc">{</span>evaluation[<span class="st">"rmse_modified"</span>]<span class="op">-</span>evaluation[<span class="st">"rmse_original"</span>]<span class="sc">:+,.0f}</span><span class="ss">'</span>],</span>
<span id="cb42-1983"><a href="#cb42-1983" aria-hidden="true" tabindex="-1"></a>        [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1984"><a href="#cb42-1984" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'Statistics (Last 12 Months)'</span>, <span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb42-1985"><a href="#cb42-1985" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Mean Ï'</span>,</span>
<span id="cb42-1986"><a href="#cb42-1986" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1987"><a href="#cb42-1987" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1988"><a href="#cb42-1988" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>mean()<span class="op">-</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1989"><a href="#cb42-1989" aria-hidden="true" tabindex="-1"></a>        [<span class="ss">f'  Std Dev Ï'</span>,</span>
<span id="cb42-1990"><a href="#cb42-1990" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1991"><a href="#cb42-1991" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-1992"><a href="#cb42-1992" aria-hidden="true" tabindex="-1"></a>         <span class="ss">f'</span><span class="sc">{</span>last_12_stats[<span class="st">"rho_modified_pct"</span>]<span class="sc">.</span>std()<span class="op">-</span>last_12_stats[<span class="st">"rho_original_pct"</span>]<span class="sc">.</span>std()<span class="sc">:+.2f}</span><span class="ss">%'</span>],</span>
<span id="cb42-1993"><a href="#cb42-1993" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb42-1994"><a href="#cb42-1994" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-1995"><a href="#cb42-1995" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax6.table(cellText<span class="op">=</span>summary_text, cellLoc<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb42-1996"><a href="#cb42-1996" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb42-1997"><a href="#cb42-1997" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb42-1998"><a href="#cb42-1998" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb42-1999"><a href="#cb42-1999" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="fl">2.2</span>)</span>
<span id="cb42-2000"><a href="#cb42-2000" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2001"><a href="#cb42-2001" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style headers</span></span>
<span id="cb42-2002"><a href="#cb42-2002" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">11</span>]:</span>
<span id="cb42-2003"><a href="#cb42-2003" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb42-2004"><a href="#cb42-2004" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb42-2005"><a href="#cb42-2005" aria-hidden="true" tabindex="-1"></a>            table[(i, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb42-2006"><a href="#cb42-2006" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2007"><a href="#cb42-2007" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight key metrics</span></span>
<span id="cb42-2008"><a href="#cb42-2008" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> evaluation[<span class="st">'additional_months'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb42-2009"><a href="#cb42-2009" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">3</span>, <span class="dv">3</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb42-2010"><a href="#cb42-2010" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">4</span>, <span class="dv">3</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb42-2011"><a href="#cb42-2011" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2012"><a href="#cb42-2012" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> evaluation[<span class="st">'mae_change_pct'</span>] <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb42-2013"><a href="#cb42-2013" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">7</span>, <span class="dv">3</span>)].set_facecolor(<span class="st">'lightgreen'</span>)</span>
<span id="cb42-2014"><a href="#cb42-2014" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2015"><a href="#cb42-2015" aria-hidden="true" tabindex="-1"></a>    ax6.set_title(<span class="st">'Comprehensive Summary: Questions 3a &amp; 3b'</span>, </span>
<span id="cb42-2016"><a href="#cb42-2016" aria-hidden="true" tabindex="-1"></a>                  fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb42-2017"><a href="#cb42-2017" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2018"><a href="#cb42-2018" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Strategy Evaluation: Conservative Forecasting Results'</span>, </span>
<span id="cb42-2019"><a href="#cb42-2019" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">17</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2020"><a href="#cb42-2020" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-2021"><a href="#cb42-2021" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-2022"><a href="#cb42-2022" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-2023"><a href="#cb42-2023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2026"><a href="#cb42-2026" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-2027"><a href="#cb42-2027" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-2028"><a href="#cb42-2028" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.3: STRATEGY TO IMPROVE REBATE CHANCES</span></span>
<span id="cb42-2029"><a href="#cb42-2029" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-2030"><a href="#cb42-2030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2031"><a href="#cb42-2031" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply conservative strategy (10% dampening)</span></span>
<span id="cb42-2032"><a href="#cb42-2032" aria-hidden="true" tabindex="-1"></a>forecast_modified, hist_mean <span class="op">=</span> apply_conservative_strategy(forecast_all, damping_factor<span class="op">=</span><span class="fl">0.10</span>)</span>
<span id="cb42-2033"><a href="#cb42-2033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2034"><a href="#cb42-2034" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly Ï with modified forecasts</span></span>
<span id="cb42-2035"><a href="#cb42-2035" aria-hidden="true" tabindex="-1"></a>monthly_modified <span class="op">=</span> calculate_monthly_rho_with_strategy(forecast_modified)</span>
<span id="cb42-2036"><a href="#cb42-2036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2037"><a href="#cb42-2037" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate strategy (answers both 3a and 3b)</span></span>
<span id="cb42-2038"><a href="#cb42-2038" aria-hidden="true" tabindex="-1"></a>evaluation <span class="op">=</span> evaluate_strategy_performance(monthly_modified, forecast_modified, X)</span>
<span id="cb42-2039"><a href="#cb42-2039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2040"><a href="#cb42-2040" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize comprehensive results</span></span>
<span id="cb42-2041"><a href="#cb42-2041" aria-hidden="true" tabindex="-1"></a>visualize_strategy_results(evaluation[<span class="st">'last_12_stats'</span>], X, evaluation)</span>
<span id="cb42-2042"><a href="#cb42-2042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2043"><a href="#cb42-2043" aria-hidden="true" tabindex="-1"></a><span class="co"># Print final summary</span></span>
<span id="cb42-2044"><a href="#cb42-2044" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-2045"><a href="#cb42-2045" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" STEP 3.3 COMPLETE - FINAL SUMMARY"</span>)</span>
<span id="cb42-2046"><a href="#cb42-2046" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-2047"><a href="#cb42-2047" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Additional Qualifying Months"</span>)</span>
<span id="cb42-2048"><a href="#cb42-2048" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Answer: </span><span class="sc">{</span>evaluation[<span class="st">'additional_months'</span>]<span class="sc">:+d}</span><span class="ss"> months"</span>)</span>
<span id="cb42-2049"><a href="#cb42-2049" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   (From </span><span class="sc">{</span>evaluation[<span class="st">'original_qualifying'</span>]<span class="sc">}</span><span class="ss">/12 to </span><span class="sc">{</span>evaluation[<span class="st">'modified_qualifying'</span>]<span class="sc">}</span><span class="ss">/12)"</span>)</span>
<span id="cb42-2050"><a href="#cb42-2050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2051"><a href="#cb42-2051" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Accuracy Impact"</span>)</span>
<span id="cb42-2052"><a href="#cb42-2052" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"   Answer: MAE changed by </span><span class="sc">{</span>evaluation[<span class="st">'mae_change_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2053"><a href="#cb42-2053" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> evaluation[<span class="st">'mae_change_pct'</span>] <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb42-2054"><a href="#cb42-2054" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Accuracy actually IMPROVED!"</span>)</span>
<span id="cb42-2055"><a href="#cb42-2055" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb42-2056"><a href="#cb42-2056" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Trade-off: Small accuracy loss for better rebate qualification"</span>)</span>
<span id="cb42-2057"><a href="#cb42-2057" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-2058"><a href="#cb42-2058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2059"><a href="#cb42-2059" aria-hidden="true" tabindex="-1"></a>**Note:**</span>
<span id="cb42-2060"><a href="#cb42-2060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2061"><a href="#cb42-2061" aria-hidden="true" tabindex="-1"></a><span class="in">``` </span></span>
<span id="cb42-2062"><a href="#cb42-2062" aria-hidden="true" tabindex="-1"></a><span class="in">We can see from the above graph that we mananged to improve the MAE of our forecastings, but we were not able to add more months on the rebate region. For this case, we will try below to find a more optimal dampening factor that can also helps us towards this direction.</span></span>
<span id="cb42-2063"><a href="#cb42-2063" aria-hidden="true" tabindex="-1"></a><span class="in">```</span> </span>
<span id="cb42-2064"><a href="#cb42-2064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2065"><a href="#cb42-2065" aria-hidden="true" tabindex="-1"></a><span class="fu">## Grid Search to find the optimal dampening factor that can provide a bigger number of rebate months</span></span>
<span id="cb42-2066"><a href="#cb42-2066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2069"><a href="#cb42-2069" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-2070"><a href="#cb42-2070" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-2071"><a href="#cb42-2071" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.3: GRID SEARCH FOR OPTIMAL DAMPENING FACTOR</span></span>
<span id="cb42-2072"><a href="#cb42-2072" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-2073"><a href="#cb42-2073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2074"><a href="#cb42-2074" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grid_search_dampening_factor(forecast_all, monthly_stats_all, X, </span>
<span id="cb42-2075"><a href="#cb42-2075" aria-hidden="true" tabindex="-1"></a>                                 damping_range<span class="op">=</span>np.arange(<span class="fl">0.0</span>, <span class="fl">0.6</span>, <span class="fl">0.01</span>)):</span>
<span id="cb42-2076"><a href="#cb42-2076" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-2077"><a href="#cb42-2077" aria-hidden="true" tabindex="-1"></a><span class="co">    Grid search to find optimal dampening factor that maximizes qualifying months.</span></span>
<span id="cb42-2078"><a href="#cb42-2078" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-2079"><a href="#cb42-2079" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb42-2080"><a href="#cb42-2080" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb42-2081"><a href="#cb42-2081" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_all : DataFrame with all forecasts</span></span>
<span id="cb42-2082"><a href="#cb42-2082" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_stats_all : DataFrame with all monthly stats</span></span>
<span id="cb42-2083"><a href="#cb42-2083" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float, the bracket percentage</span></span>
<span id="cb42-2084"><a href="#cb42-2084" aria-hidden="true" tabindex="-1"></a><span class="co">    damping_range : array, range of dampening factors to test (e.g., 0% to 30%)</span></span>
<span id="cb42-2085"><a href="#cb42-2085" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb42-2086"><a href="#cb42-2086" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-2087"><a href="#cb42-2087" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb42-2088"><a href="#cb42-2088" aria-hidden="true" tabindex="-1"></a><span class="co">    results_df : DataFrame with results for each dampening factor</span></span>
<span id="cb42-2089"><a href="#cb42-2089" aria-hidden="true" tabindex="-1"></a><span class="co">    best_damping : float, optimal dampening factor</span></span>
<span id="cb42-2090"><a href="#cb42-2090" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-2091"><a href="#cb42-2091" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2092"><a href="#cb42-2092" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-2093"><a href="#cb42-2093" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GRID SEARCH: FINDING OPTIMAL DAMPENING FACTOR"</span>)</span>
<span id="cb42-2094"><a href="#cb42-2094" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb42-2095"><a href="#cb42-2095" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2096"><a href="#cb42-2096" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Testing </span><span class="sc">{</span><span class="bu">len</span>(damping_range)<span class="sc">}</span><span class="ss"> dampening factors from </span><span class="sc">{</span>damping_range[<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>damping_range[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-2097"><a href="#cb42-2097" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Goal: Maximize qualifying months in last 12 months"</span>)</span>
<span id="cb42-2098"><a href="#cb42-2098" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Bracket: Â±</span><span class="sc">{</span>X<span class="sc">:.2f}</span><span class="ss">%</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb42-2099"><a href="#cb42-2099" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2100"><a href="#cb42-2100" aria-hidden="true" tabindex="-1"></a>    historical_mean <span class="op">=</span> forecast_all[<span class="st">'Actual'</span>].mean()</span>
<span id="cb42-2101"><a href="#cb42-2101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2102"><a href="#cb42-2102" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb42-2103"><a href="#cb42-2103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2104"><a href="#cb42-2104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test each dampening factor</span></span>
<span id="cb42-2105"><a href="#cb42-2105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> damping <span class="kw">in</span> damping_range:</span>
<span id="cb42-2106"><a href="#cb42-2106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply strategy</span></span>
<span id="cb42-2107"><a href="#cb42-2107" aria-hidden="true" tabindex="-1"></a>        forecast_modified <span class="op">=</span> forecast_all.copy()</span>
<span id="cb42-2108"><a href="#cb42-2108" aria-hidden="true" tabindex="-1"></a>        forecast_modified[<span class="st">'Forecast_Modified'</span>] <span class="op">=</span> (</span>
<span id="cb42-2109"><a href="#cb42-2109" aria-hidden="true" tabindex="-1"></a>            forecast_all[<span class="st">'Forecast_H2'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> damping) <span class="op">+</span> </span>
<span id="cb42-2110"><a href="#cb42-2110" aria-hidden="true" tabindex="-1"></a>            historical_mean <span class="op">*</span> damping</span>
<span id="cb42-2111"><a href="#cb42-2111" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-2112"><a href="#cb42-2112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2113"><a href="#cb42-2113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate monthly Ï with modified forecasts</span></span>
<span id="cb42-2114"><a href="#cb42-2114" aria-hidden="true" tabindex="-1"></a>        monthly_modified <span class="op">=</span> forecast_modified.groupby(<span class="st">'YearMonth'</span>).agg({</span>
<span id="cb42-2115"><a href="#cb42-2115" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Actual'</span>: <span class="st">'sum'</span>,</span>
<span id="cb42-2116"><a href="#cb42-2116" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Forecast_H2'</span>: <span class="st">'sum'</span>,</span>
<span id="cb42-2117"><a href="#cb42-2117" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Forecast_Modified'</span>: <span class="st">'sum'</span></span>
<span id="cb42-2118"><a href="#cb42-2118" aria-hidden="true" tabindex="-1"></a>        }).reset_index()</span>
<span id="cb42-2119"><a href="#cb42-2119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2120"><a href="#cb42-2120" aria-hidden="true" tabindex="-1"></a>        monthly_modified[<span class="st">'rho_modified'</span>] <span class="op">=</span> (</span>
<span id="cb42-2121"><a href="#cb42-2121" aria-hidden="true" tabindex="-1"></a>            (monthly_modified[<span class="st">'Forecast_Modified'</span>] <span class="op">-</span> monthly_modified[<span class="st">'Actual'</span>]) <span class="op">/</span> </span>
<span id="cb42-2122"><a href="#cb42-2122" aria-hidden="true" tabindex="-1"></a>            monthly_modified[<span class="st">'Actual'</span>]</span>
<span id="cb42-2123"><a href="#cb42-2123" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-2124"><a href="#cb42-2124" aria-hidden="true" tabindex="-1"></a>        monthly_modified[<span class="st">'rho_modified_pct'</span>] <span class="op">=</span> monthly_modified[<span class="st">'rho_modified'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-2125"><a href="#cb42-2125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2126"><a href="#cb42-2126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get last 12 months</span></span>
<span id="cb42-2127"><a href="#cb42-2127" aria-hidden="true" tabindex="-1"></a>        last_12 <span class="op">=</span> monthly_modified.tail(<span class="dv">12</span>)</span>
<span id="cb42-2128"><a href="#cb42-2128" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2129"><a href="#cb42-2129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply bracket</span></span>
<span id="cb42-2130"><a href="#cb42-2130" aria-hidden="true" tabindex="-1"></a>        last_12[<span class="st">'qualifies'</span>] <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].<span class="bu">abs</span>() <span class="op">&lt;=</span> X</span>
<span id="cb42-2131"><a href="#cb42-2131" aria-hidden="true" tabindex="-1"></a>        qualifying_count <span class="op">=</span> last_12[<span class="st">'qualifies'</span>].<span class="bu">sum</span>()</span>
<span id="cb42-2132"><a href="#cb42-2132" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2133"><a href="#cb42-2133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate accuracy metrics</span></span>
<span id="cb42-2134"><a href="#cb42-2134" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(forecast_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_modified[<span class="st">'Forecast_Modified'</span>]))</span>
<span id="cb42-2135"><a href="#cb42-2135" aria-hidden="true" tabindex="-1"></a>        mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>(</span>
<span id="cb42-2136"><a href="#cb42-2136" aria-hidden="true" tabindex="-1"></a>            (forecast_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_modified[<span class="st">'Forecast_Modified'</span>]) <span class="op">/</span> </span>
<span id="cb42-2137"><a href="#cb42-2137" aria-hidden="true" tabindex="-1"></a>            forecast_modified[<span class="st">'Actual'</span>]</span>
<span id="cb42-2138"><a href="#cb42-2138" aria-hidden="true" tabindex="-1"></a>        )) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-2139"><a href="#cb42-2139" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> np.sqrt(np.mean(</span>
<span id="cb42-2140"><a href="#cb42-2140" aria-hidden="true" tabindex="-1"></a>            (forecast_modified[<span class="st">'Actual'</span>] <span class="op">-</span> forecast_modified[<span class="st">'Forecast_Modified'</span>])<span class="op">**</span><span class="dv">2</span></span>
<span id="cb42-2141"><a href="#cb42-2141" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb42-2142"><a href="#cb42-2142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2143"><a href="#cb42-2143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate Ï statistics</span></span>
<span id="cb42-2144"><a href="#cb42-2144" aria-hidden="true" tabindex="-1"></a>        mean_rho <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].mean()</span>
<span id="cb42-2145"><a href="#cb42-2145" aria-hidden="true" tabindex="-1"></a>        std_rho <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].std()</span>
<span id="cb42-2146"><a href="#cb42-2146" aria-hidden="true" tabindex="-1"></a>        max_abs_rho <span class="op">=</span> last_12[<span class="st">'rho_modified_pct'</span>].<span class="bu">abs</span>().<span class="bu">max</span>()</span>
<span id="cb42-2147"><a href="#cb42-2147" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-2148"><a href="#cb42-2148" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb42-2149"><a href="#cb42-2149" aria-hidden="true" tabindex="-1"></a>            <span class="st">'damping'</span>: damping,</span>
<span id="cb42-2150"><a href="#cb42-2150" aria-hidden="true" tabindex="-1"></a>            <span class="st">'qualifying_months'</span>: qualifying_count,</span>
<span id="cb42-2151"><a href="#cb42-2151" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mae'</span>: mae,</span>
<span id="cb42-2152"><a href="#cb42-2152" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mape'</span>: mape,</span>
<span id="cb42-2153"><a href="#cb42-2153" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rmse'</span>: rmse,</span>
<span id="cb42-2154"><a href="#cb42-2154" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_rho'</span>: mean_rho,</span>
<span id="cb42-2155"><a href="#cb42-2155" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_rho'</span>: std_rho,</span>
<span id="cb42-2156"><a href="#cb42-2156" aria-hidden="true" tabindex="-1"></a>            <span class="st">'max_abs_rho'</span>: max_abs_rho</span>
<span id="cb42-2157"><a href="#cb42-2157" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb42-2158"><a href="#cb42-2158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2159"><a href="#cb42-2159" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb42-2160"><a href="#cb42-2160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2161"><a href="#cb42-2161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find best dampening factor</span></span>
<span id="cb42-2162"><a href="#cb42-2162" aria-hidden="true" tabindex="-1"></a>    max_qualifying <span class="op">=</span> results_df[<span class="st">'qualifying_months'</span>].<span class="bu">max</span>()</span>
<span id="cb42-2163"><a href="#cb42-2163" aria-hidden="true" tabindex="-1"></a>    best_results <span class="op">=</span> results_df[results_df[<span class="st">'qualifying_months'</span>] <span class="op">==</span> max_qualifying]</span>
<span id="cb42-2164"><a href="#cb42-2164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2165"><a href="#cb42-2165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Among those with max qualifying months, choose the one with best MAE</span></span>
<span id="cb42-2166"><a href="#cb42-2166" aria-hidden="true" tabindex="-1"></a>    best_idx <span class="op">=</span> best_results[<span class="st">'mae'</span>].idxmin()</span>
<span id="cb42-2167"><a href="#cb42-2167" aria-hidden="true" tabindex="-1"></a>    best_damping <span class="op">=</span> results_df.loc[best_idx, <span class="st">'damping'</span>]</span>
<span id="cb42-2168"><a href="#cb42-2168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2169"><a href="#cb42-2169" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" Grid search complete!"</span>)</span>
<span id="cb42-2170"><a href="#cb42-2170" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2171"><a href="#cb42-2171" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"OPTIMAL DAMPENING FACTOR"</span>)</span>
<span id="cb42-2172"><a href="#cb42-2172" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2173"><a href="#cb42-2173" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best damping: </span><span class="sc">{</span>best_damping<span class="sc">:.2f}</span><span class="ss"> (</span><span class="sc">{</span>best_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% toward mean)"</span>)</span>
<span id="cb42-2174"><a href="#cb42-2174" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Qualifying months: </span><span class="sc">{</span><span class="bu">int</span>(results_df.loc[best_idx, <span class="st">'qualifying_months'</span>])<span class="sc">}</span><span class="ss">/12"</span>)</span>
<span id="cb42-2175"><a href="#cb42-2175" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE: $</span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'mae'</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-2176"><a href="#cb42-2176" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAPE: </span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'mape'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2177"><a href="#cb42-2177" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Ï: </span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'mean_rho'</span>]<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2178"><a href="#cb42-2178" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Std Dev Ï: </span><span class="sc">{</span>results_df<span class="sc">.</span>loc[best_idx, <span class="st">'std_rho'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2179"><a href="#cb42-2179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2180"><a href="#cb42-2180" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show baseline for comparison</span></span>
<span id="cb42-2181"><a href="#cb42-2181" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> results_df[results_df[<span class="st">'damping'</span>] <span class="op">==</span> <span class="fl">0.0</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb42-2182"><a href="#cb42-2182" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Baseline (no dampening):"</span>)</span>
<span id="cb42-2183"><a href="#cb42-2183" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Qualifying months: </span><span class="sc">{</span><span class="bu">int</span>(baseline[<span class="st">'qualifying_months'</span>])<span class="sc">}</span><span class="ss">/12"</span>)</span>
<span id="cb42-2184"><a href="#cb42-2184" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE: $</span><span class="sc">{</span>baseline[<span class="st">'mae'</span>]<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-2185"><a href="#cb42-2185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2186"><a href="#cb42-2186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show improvement</span></span>
<span id="cb42-2187"><a href="#cb42-2187" aria-hidden="true" tabindex="-1"></a>    improvement_months <span class="op">=</span> <span class="bu">int</span>(results_df.loc[best_idx, <span class="st">'qualifying_months'</span>]) <span class="op">-</span> <span class="bu">int</span>(baseline[<span class="st">'qualifying_months'</span>])</span>
<span id="cb42-2188"><a href="#cb42-2188" aria-hidden="true" tabindex="-1"></a>    improvement_mae_pct <span class="op">=</span> ((results_df.loc[best_idx, <span class="st">'mae'</span>] <span class="op">-</span> baseline[<span class="st">'mae'</span>]) <span class="op">/</span> baseline[<span class="st">'mae'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-2189"><a href="#cb42-2189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2190"><a href="#cb42-2190" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Improvement:"</span>)</span>
<span id="cb42-2191"><a href="#cb42-2191" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Additional months: </span><span class="sc">{</span>improvement_months<span class="sc">:+d}</span><span class="ss">"</span>)</span>
<span id="cb42-2192"><a href="#cb42-2192" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MAE change: </span><span class="sc">{</span>improvement_mae_pct<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2193"><a href="#cb42-2193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2194"><a href="#cb42-2194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df, best_damping</span>
<span id="cb42-2195"><a href="#cb42-2195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2196"><a href="#cb42-2196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2197"><a href="#cb42-2197" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_grid_search_results(results_df, X, baseline_qualifying<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb42-2198"><a href="#cb42-2198" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-2199"><a href="#cb42-2199" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize grid search results showing trade-off between qualifying months and accuracy.</span></span>
<span id="cb42-2200"><a href="#cb42-2200" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-2201"><a href="#cb42-2201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2202"><a href="#cb42-2202" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">12</span>))</span>
<span id="cb42-2203"><a href="#cb42-2203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2204"><a href="#cb42-2204" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 1: Qualifying months vs dampening</span></span>
<span id="cb42-2205"><a href="#cb42-2205" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb42-2206"><a href="#cb42-2206" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2207"><a href="#cb42-2207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color points by whether they're better than baseline</span></span>
<span id="cb42-2208"><a href="#cb42-2208" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> q <span class="op">&gt;</span> baseline_qualifying <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">if</span> q <span class="op">&lt;</span> baseline_qualifying <span class="cf">else</span> <span class="st">'orange'</span> </span>
<span id="cb42-2209"><a href="#cb42-2209" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> q <span class="kw">in</span> results_df[<span class="st">'qualifying_months'</span>]]</span>
<span id="cb42-2210"><a href="#cb42-2210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2211"><a href="#cb42-2211" aria-hidden="true" tabindex="-1"></a>    ax1.scatter(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'qualifying_months'</span>], </span>
<span id="cb42-2212"><a href="#cb42-2212" aria-hidden="true" tabindex="-1"></a>               c<span class="op">=</span>colors, s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-2213"><a href="#cb42-2213" aria-hidden="true" tabindex="-1"></a>    ax1.axhline(baseline_qualifying, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb42-2214"><a href="#cb42-2214" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Baseline: </span><span class="sc">{</span>baseline_qualifying<span class="sc">}</span><span class="ss">/12'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-2215"><a href="#cb42-2215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2216"><a href="#cb42-2216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark the best point</span></span>
<span id="cb42-2217"><a href="#cb42-2217" aria-hidden="true" tabindex="-1"></a>    best_idx <span class="op">=</span> results_df[<span class="st">'qualifying_months'</span>].idxmax()</span>
<span id="cb42-2218"><a href="#cb42-2218" aria-hidden="true" tabindex="-1"></a>    best_mae_in_best <span class="op">=</span> results_df[results_df[<span class="st">'qualifying_months'</span>] <span class="op">==</span> results_df[<span class="st">'qualifying_months'</span>].<span class="bu">max</span>()][<span class="st">'mae'</span>].idxmin()</span>
<span id="cb42-2219"><a href="#cb42-2219" aria-hidden="true" tabindex="-1"></a>    ax1.scatter(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, </span>
<span id="cb42-2220"><a href="#cb42-2220" aria-hidden="true" tabindex="-1"></a>               results_df.loc[best_mae_in_best, <span class="st">'qualifying_months'</span>],</span>
<span id="cb42-2221"><a href="#cb42-2221" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'*'</span>, s<span class="op">=</span><span class="dv">500</span>, color<span class="op">=</span><span class="st">'gold'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb42-2222"><a href="#cb42-2222" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Optimal'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-2223"><a href="#cb42-2223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2224"><a href="#cb42-2224" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2225"><a href="#cb42-2225" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylabel(<span class="st">'Qualifying Months (out of 12)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2226"><a href="#cb42-2226" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">'Qualifying Months vs Dampening Factor'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2227"><a href="#cb42-2227" aria-hidden="true" tabindex="-1"></a>    ax1.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-2228"><a href="#cb42-2228" aria-hidden="true" tabindex="-1"></a>    ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-2229"><a href="#cb42-2229" aria-hidden="true" tabindex="-1"></a>    ax1.set_ylim([results_df[<span class="st">'qualifying_months'</span>].<span class="bu">min</span>() <span class="op">-</span> <span class="fl">0.5</span>, <span class="fl">12.5</span>])</span>
<span id="cb42-2230"><a href="#cb42-2230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2231"><a href="#cb42-2231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 2: MAE vs dampening</span></span>
<span id="cb42-2232"><a href="#cb42-2232" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb42-2233"><a href="#cb42-2233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2234"><a href="#cb42-2234" aria-hidden="true" tabindex="-1"></a>    baseline_mae <span class="op">=</span> results_df[results_df[<span class="st">'damping'</span>] <span class="op">==</span> <span class="fl">0.0</span>][<span class="st">'mae'</span>].values[<span class="dv">0</span>]</span>
<span id="cb42-2235"><a href="#cb42-2235" aria-hidden="true" tabindex="-1"></a>    colors2 <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> mae <span class="op">&lt;</span> baseline_mae <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> mae <span class="kw">in</span> results_df[<span class="st">'mae'</span>]]</span>
<span id="cb42-2236"><a href="#cb42-2236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2237"><a href="#cb42-2237" aria-hidden="true" tabindex="-1"></a>    ax2.scatter(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'mae'</span>], </span>
<span id="cb42-2238"><a href="#cb42-2238" aria-hidden="true" tabindex="-1"></a>               c<span class="op">=</span>colors2, s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-2239"><a href="#cb42-2239" aria-hidden="true" tabindex="-1"></a>    ax2.axhline(baseline_mae, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb42-2240"><a href="#cb42-2240" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Baseline MAE: $</span><span class="sc">{</span>baseline_mae<span class="sc">:,.0f}</span><span class="ss">'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-2241"><a href="#cb42-2241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2242"><a href="#cb42-2242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark optimal</span></span>
<span id="cb42-2243"><a href="#cb42-2243" aria-hidden="true" tabindex="-1"></a>    ax2.scatter(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb42-2244"><a href="#cb42-2244" aria-hidden="true" tabindex="-1"></a>               results_df.loc[best_mae_in_best, <span class="st">'mae'</span>],</span>
<span id="cb42-2245"><a href="#cb42-2245" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'*'</span>, s<span class="op">=</span><span class="dv">500</span>, color<span class="op">=</span><span class="st">'gold'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb42-2246"><a href="#cb42-2246" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Optimal'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-2247"><a href="#cb42-2247" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2248"><a href="#cb42-2248" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2249"><a href="#cb42-2249" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'MAE ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2250"><a href="#cb42-2250" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Forecast Accuracy (MAE) vs Dampening'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2251"><a href="#cb42-2251" aria-hidden="true" tabindex="-1"></a>    ax2.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-2252"><a href="#cb42-2252" aria-hidden="true" tabindex="-1"></a>    ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-2253"><a href="#cb42-2253" aria-hidden="true" tabindex="-1"></a>    ax2.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb42-2254"><a href="#cb42-2254" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2255"><a href="#cb42-2255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 3: Trade-off curve </span></span>
<span id="cb42-2256"><a href="#cb42-2256" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">2</span>]</span>
<span id="cb42-2257"><a href="#cb42-2257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2258"><a href="#cb42-2258" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create color gradient based on dampening</span></span>
<span id="cb42-2259"><a href="#cb42-2259" aria-hidden="true" tabindex="-1"></a>    scatter <span class="op">=</span> ax3.scatter(results_df[<span class="st">'mae'</span>], results_df[<span class="st">'qualifying_months'</span>],</span>
<span id="cb42-2260"><a href="#cb42-2260" aria-hidden="true" tabindex="-1"></a>                         c<span class="op">=</span>results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, </span>
<span id="cb42-2261"><a href="#cb42-2261" aria-hidden="true" tabindex="-1"></a>                         cmap<span class="op">=</span><span class="st">'viridis'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb42-2262"><a href="#cb42-2262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2263"><a href="#cb42-2263" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark baseline</span></span>
<span id="cb42-2264"><a href="#cb42-2264" aria-hidden="true" tabindex="-1"></a>    baseline_row <span class="op">=</span> results_df[results_df[<span class="st">'damping'</span>] <span class="op">==</span> <span class="fl">0.0</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb42-2265"><a href="#cb42-2265" aria-hidden="true" tabindex="-1"></a>    ax3.scatter(baseline_row[<span class="st">'mae'</span>], baseline_row[<span class="st">'qualifying_months'</span>],</span>
<span id="cb42-2266"><a href="#cb42-2266" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'X'</span>, s<span class="op">=</span><span class="dv">300</span>, color<span class="op">=</span><span class="st">'red'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb42-2267"><a href="#cb42-2267" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Baseline (0%)'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-2268"><a href="#cb42-2268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2269"><a href="#cb42-2269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark optimal</span></span>
<span id="cb42-2270"><a href="#cb42-2270" aria-hidden="true" tabindex="-1"></a>    ax3.scatter(results_df.loc[best_mae_in_best, <span class="st">'mae'</span>],</span>
<span id="cb42-2271"><a href="#cb42-2271" aria-hidden="true" tabindex="-1"></a>               results_df.loc[best_mae_in_best, <span class="st">'qualifying_months'</span>],</span>
<span id="cb42-2272"><a href="#cb42-2272" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span><span class="st">'*'</span>, s<span class="op">=</span><span class="dv">500</span>, color<span class="op">=</span><span class="st">'gold'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb42-2273"><a href="#cb42-2273" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="st">'Optimal'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-2274"><a href="#cb42-2274" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2275"><a href="#cb42-2275" aria-hidden="true" tabindex="-1"></a>    cbar <span class="op">=</span> plt.colorbar(scatter, ax<span class="op">=</span>ax3)</span>
<span id="cb42-2276"><a href="#cb42-2276" aria-hidden="true" tabindex="-1"></a>    cbar.set_label(<span class="st">'Dampening (%)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-2277"><a href="#cb42-2277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2278"><a href="#cb42-2278" aria-hidden="true" tabindex="-1"></a>    ax3.set_xlabel(<span class="st">'MAE ($)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2279"><a href="#cb42-2279" aria-hidden="true" tabindex="-1"></a>    ax3.set_ylabel(<span class="st">'Qualifying Months'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2280"><a href="#cb42-2280" aria-hidden="true" tabindex="-1"></a>    ax3.set_title(<span class="st">'Trade-off: Accuracy vs Rebate Qualification'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2281"><a href="#cb42-2281" aria-hidden="true" tabindex="-1"></a>    ax3.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-2282"><a href="#cb42-2282" aria-hidden="true" tabindex="-1"></a>    ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-2283"><a href="#cb42-2283" aria-hidden="true" tabindex="-1"></a>    ax3.ticklabel_format(style<span class="op">=</span><span class="st">'plain'</span>, axis<span class="op">=</span><span class="st">'x'</span>)</span>
<span id="cb42-2284"><a href="#cb42-2284" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2285"><a href="#cb42-2285" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 4: Mean Ï vs dampening</span></span>
<span id="cb42-2286"><a href="#cb42-2286" aria-hidden="true" tabindex="-1"></a>    ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb42-2287"><a href="#cb42-2287" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2288"><a href="#cb42-2288" aria-hidden="true" tabindex="-1"></a>    ax4.plot(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'mean_rho'</span>], </span>
<span id="cb42-2289"><a href="#cb42-2289" aria-hidden="true" tabindex="-1"></a>            <span class="st">'o-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-2290"><a href="#cb42-2290" aria-hidden="true" tabindex="-1"></a>    ax4.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Perfect (Ï=0)'</span>)</span>
<span id="cb42-2291"><a href="#cb42-2291" aria-hidden="true" tabindex="-1"></a>    ax4.axvline(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, </span>
<span id="cb42-2292"><a href="#cb42-2292" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">'gold'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Optimal'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-2293"><a href="#cb42-2293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2294"><a href="#cb42-2294" aria-hidden="true" tabindex="-1"></a>    ax4.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2295"><a href="#cb42-2295" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Mean Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2296"><a href="#cb42-2296" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'Mean Rebate KPI vs Dampening'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2297"><a href="#cb42-2297" aria-hidden="true" tabindex="-1"></a>    ax4.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-2298"><a href="#cb42-2298" aria-hidden="true" tabindex="-1"></a>    ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-2299"><a href="#cb42-2299" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2300"><a href="#cb42-2300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 5: Std Dev of Ï vs dampening</span></span>
<span id="cb42-2301"><a href="#cb42-2301" aria-hidden="true" tabindex="-1"></a>    ax5 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb42-2302"><a href="#cb42-2302" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2303"><a href="#cb42-2303" aria-hidden="true" tabindex="-1"></a>    ax5.plot(results_df[<span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>, results_df[<span class="st">'std_rho'</span>],</span>
<span id="cb42-2304"><a href="#cb42-2304" aria-hidden="true" tabindex="-1"></a>            <span class="st">'o-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">6</span>, color<span class="op">=</span><span class="st">'coral'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-2305"><a href="#cb42-2305" aria-hidden="true" tabindex="-1"></a>    ax5.axvline(results_df.loc[best_mae_in_best, <span class="st">'damping'</span>]<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb42-2306"><a href="#cb42-2306" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">'gold'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Optimal'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb42-2307"><a href="#cb42-2307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2308"><a href="#cb42-2308" aria-hidden="true" tabindex="-1"></a>    ax5.set_xlabel(<span class="st">'Dampening Factor (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2309"><a href="#cb42-2309" aria-hidden="true" tabindex="-1"></a>    ax5.set_ylabel(<span class="st">'Std Dev of Ï (%)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2310"><a href="#cb42-2310" aria-hidden="true" tabindex="-1"></a>    ax5.set_title(<span class="st">'Variability of Ï vs Dampening'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2311"><a href="#cb42-2311" aria-hidden="true" tabindex="-1"></a>    ax5.legend(fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb42-2312"><a href="#cb42-2312" aria-hidden="true" tabindex="-1"></a>    ax5.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb42-2313"><a href="#cb42-2313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2314"><a href="#cb42-2314" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot 6: Summary table</span></span>
<span id="cb42-2315"><a href="#cb42-2315" aria-hidden="true" tabindex="-1"></a>    ax6 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb42-2316"><a href="#cb42-2316" aria-hidden="true" tabindex="-1"></a>    ax6.axis(<span class="st">'off'</span>)</span>
<span id="cb42-2317"><a href="#cb42-2317" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2318"><a href="#cb42-2318" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get top 5 configurations</span></span>
<span id="cb42-2319"><a href="#cb42-2319" aria-hidden="true" tabindex="-1"></a>    top5 <span class="op">=</span> results_df.nlargest(<span class="dv">5</span>, <span class="st">'qualifying_months'</span>)[[<span class="st">'damping'</span>, <span class="st">'qualifying_months'</span>, <span class="st">'mae'</span>, <span class="st">'mean_rho'</span>, <span class="st">'std_rho'</span>]].copy()</span>
<span id="cb42-2320"><a href="#cb42-2320" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'damping_pct'</span>] <span class="op">=</span> (top5[<span class="st">'damping'</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb42-2321"><a href="#cb42-2321" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'qualifying_months'</span>] <span class="op">=</span> top5[<span class="st">'qualifying_months'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb42-2322"><a href="#cb42-2322" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'mae'</span>] <span class="op">=</span> top5[<span class="st">'mae'</span>].<span class="bu">round</span>(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb42-2323"><a href="#cb42-2323" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'mean_rho'</span>] <span class="op">=</span> top5[<span class="st">'mean_rho'</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb42-2324"><a href="#cb42-2324" aria-hidden="true" tabindex="-1"></a>    top5[<span class="st">'std_rho'</span>] <span class="op">=</span> top5[<span class="st">'std_rho'</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb42-2325"><a href="#cb42-2325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2326"><a href="#cb42-2326" aria-hidden="true" tabindex="-1"></a>    table_data <span class="op">=</span> [[<span class="st">'Rank'</span>, <span class="st">'Damp%'</span>, <span class="st">'Qual/12'</span>, <span class="st">'MAE'</span>, <span class="st">'Mean Ï'</span>, <span class="st">'Std Ï'</span>]]</span>
<span id="cb42-2327"><a href="#cb42-2327" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (idx, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top5.iterrows(), <span class="dv">1</span>):</span>
<span id="cb42-2328"><a href="#cb42-2328" aria-hidden="true" tabindex="-1"></a>        marker <span class="op">=</span> <span class="st">'â­'</span> <span class="cf">if</span> i <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb42-2329"><a href="#cb42-2329" aria-hidden="true" tabindex="-1"></a>        table_data.append([</span>
<span id="cb42-2330"><a href="#cb42-2330" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb42-2331"><a href="#cb42-2331" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"damping_pct"</span>]<span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb42-2332"><a href="#cb42-2332" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"qualifying_months"</span>]<span class="sc">}</span><span class="ss">/12'</span>,</span>
<span id="cb42-2333"><a href="#cb42-2333" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'$</span><span class="sc">{</span>row[<span class="st">"mae"</span>]<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb42-2334"><a href="#cb42-2334" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"mean_rho"</span>]<span class="sc">:+.2f}</span><span class="ss">%'</span>,</span>
<span id="cb42-2335"><a href="#cb42-2335" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"std_rho"</span>]<span class="sc">:.2f}</span><span class="ss">%'</span></span>
<span id="cb42-2336"><a href="#cb42-2336" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb42-2337"><a href="#cb42-2337" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2338"><a href="#cb42-2338" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> ax6.table(cellText<span class="op">=</span>table_data, cellLoc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb42-2339"><a href="#cb42-2339" aria-hidden="true" tabindex="-1"></a>                     loc<span class="op">=</span><span class="st">'center'</span>, bbox<span class="op">=</span>[<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.85</span>, <span class="fl">0.6</span>])</span>
<span id="cb42-2340"><a href="#cb42-2340" aria-hidden="true" tabindex="-1"></a>    table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb42-2341"><a href="#cb42-2341" aria-hidden="true" tabindex="-1"></a>    table.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb42-2342"><a href="#cb42-2342" aria-hidden="true" tabindex="-1"></a>    table.scale(<span class="dv">1</span>, <span class="fl">2.5</span>)</span>
<span id="cb42-2343"><a href="#cb42-2343" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2344"><a href="#cb42-2344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Style header</span></span>
<span id="cb42-2345"><a href="#cb42-2345" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb42-2346"><a href="#cb42-2346" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_facecolor(<span class="st">'#4472C4'</span>)</span>
<span id="cb42-2347"><a href="#cb42-2347" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">0</span>, j)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb42-2348"><a href="#cb42-2348" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2349"><a href="#cb42-2349" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight best</span></span>
<span id="cb42-2350"><a href="#cb42-2350" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>):</span>
<span id="cb42-2351"><a href="#cb42-2351" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">1</span>, j)].set_facecolor(<span class="st">'gold'</span>)</span>
<span id="cb42-2352"><a href="#cb42-2352" aria-hidden="true" tabindex="-1"></a>        table[(<span class="dv">1</span>, j)].set_alpha(<span class="fl">0.5</span>)</span>
<span id="cb42-2353"><a href="#cb42-2353" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2354"><a href="#cb42-2354" aria-hidden="true" tabindex="-1"></a>    ax6.set_title(<span class="st">'Top 5 Dampening Factors'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb42-2355"><a href="#cb42-2355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2356"><a href="#cb42-2356" aria-hidden="true" tabindex="-1"></a>    plt.suptitle(<span class="st">'Grid Search Results: Finding Optimal Dampening Factor'</span>, </span>
<span id="cb42-2357"><a href="#cb42-2357" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">17</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb42-2358"><a href="#cb42-2358" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb42-2359"><a href="#cb42-2359" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb42-2360"><a href="#cb42-2360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2361"><a href="#cb42-2361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2362"><a href="#cb42-2362" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_dampening_comparison_table(results_df, key_values<span class="op">=</span>[<span class="fl">0.00</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.20</span>,<span class="fl">0.25</span>,<span class="fl">0.30</span>,<span class="fl">0.35</span>,<span class="fl">0.40</span>]):</span>
<span id="cb42-2363"><a href="#cb42-2363" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-2364"><a href="#cb42-2364" aria-hidden="true" tabindex="-1"></a><span class="co">    Display a clean comparison table for specific dampening values.</span></span>
<span id="cb42-2365"><a href="#cb42-2365" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-2366"><a href="#cb42-2366" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2367"><a href="#cb42-2367" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-2368"><a href="#cb42-2368" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"DAMPENING FACTOR COMPARISON"</span>)</span>
<span id="cb42-2369"><a href="#cb42-2369" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb42-2370"><a href="#cb42-2370" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2371"><a href="#cb42-2371" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for key values (or closest)</span></span>
<span id="cb42-2372"><a href="#cb42-2372" aria-hidden="true" tabindex="-1"></a>    comparison_rows <span class="op">=</span> []</span>
<span id="cb42-2373"><a href="#cb42-2373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val <span class="kw">in</span> key_values:</span>
<span id="cb42-2374"><a href="#cb42-2374" aria-hidden="true" tabindex="-1"></a>        closest_idx <span class="op">=</span> (results_df[<span class="st">'damping'</span>] <span class="op">-</span> val).<span class="bu">abs</span>().idxmin()</span>
<span id="cb42-2375"><a href="#cb42-2375" aria-hidden="true" tabindex="-1"></a>        comparison_rows.append(results_df.loc[closest_idx])</span>
<span id="cb42-2376"><a href="#cb42-2376" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2377"><a href="#cb42-2377" aria-hidden="true" tabindex="-1"></a>    comparison_df <span class="op">=</span> pd.DataFrame(comparison_rows)</span>
<span id="cb42-2378"><a href="#cb42-2378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2379"><a href="#cb42-2379" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format for display</span></span>
<span id="cb42-2380"><a href="#cb42-2380" aria-hidden="true" tabindex="-1"></a>    display_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb42-2381"><a href="#cb42-2381" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Dampening'</span>: (comparison_df[<span class="st">'damping'</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.0f}</span><span class="ss">%'</span>),</span>
<span id="cb42-2382"><a href="#cb42-2382" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Qualifying (last 12)'</span>: comparison_df[<span class="st">'qualifying_months'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">}</span><span class="ss">/12'</span>),</span>
<span id="cb42-2383"><a href="#cb42-2383" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAE'</span>: comparison_df[<span class="st">'mae'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'$</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">'</span>),</span>
<span id="cb42-2384"><a href="#cb42-2384" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MAPE'</span>: comparison_df[<span class="st">'mape'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">%'</span>),</span>
<span id="cb42-2385"><a href="#cb42-2385" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Mean Ï'</span>: comparison_df[<span class="st">'mean_rho'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:+.2f}</span><span class="ss">%'</span>),</span>
<span id="cb42-2386"><a href="#cb42-2386" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Std Ï'</span>: comparison_df[<span class="st">'std_rho'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">%'</span>),</span>
<span id="cb42-2387"><a href="#cb42-2387" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Max |Ï|'</span>: comparison_df[<span class="st">'max_abs_rho'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">%'</span>)</span>
<span id="cb42-2388"><a href="#cb42-2388" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-2389"><a href="#cb42-2389" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2390"><a href="#cb42-2390" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> display_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb42-2391"><a href="#cb42-2391" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2392"><a href="#cb42-2392" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight the best</span></span>
<span id="cb42-2393"><a href="#cb42-2393" aria-hidden="true" tabindex="-1"></a>    best_qual <span class="op">=</span> comparison_df[<span class="st">'qualifying_months'</span>].<span class="bu">max</span>()</span>
<span id="cb42-2394"><a href="#cb42-2394" aria-hidden="true" tabindex="-1"></a>    best_rows <span class="op">=</span> comparison_df[comparison_df[<span class="st">'qualifying_months'</span>] <span class="op">==</span> best_qual]</span>
<span id="cb42-2395"><a href="#cb42-2395" aria-hidden="true" tabindex="-1"></a>    best_mae_idx <span class="op">=</span> best_rows[<span class="st">'mae'</span>].idxmin()</span>
<span id="cb42-2396"><a href="#cb42-2396" aria-hidden="true" tabindex="-1"></a>    best_damping <span class="op">=</span> comparison_df.loc[best_mae_idx, <span class="st">'damping'</span>]</span>
<span id="cb42-2397"><a href="#cb42-2397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-2398"><a href="#cb42-2398" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2399"><a href="#cb42-2399" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" RECOMMENDED: </span><span class="sc">{</span>best_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">% dampening"</span>)</span>
<span id="cb42-2400"><a href="#cb42-2400" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Maximizes qualifying months (</span><span class="sc">{</span><span class="bu">int</span>(comparison_df.loc[best_mae_idx, <span class="st">'qualifying_months'</span>])<span class="sc">}</span><span class="ss">/12)"</span>)</span>
<span id="cb42-2401"><a href="#cb42-2401" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   While maintaining good accuracy (MAE: $</span><span class="sc">{</span>comparison_df<span class="sc">.</span>loc[best_mae_idx, <span class="st">'mae'</span>]<span class="sc">:,.0f}</span><span class="ss">)"</span>)</span>
<span id="cb42-2402"><a href="#cb42-2402" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2403"><a href="#cb42-2403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-2404"><a href="#cb42-2404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2407"><a href="#cb42-2407" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb42-2408"><a href="#cb42-2408" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-2409"><a href="#cb42-2409" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3.3: GRID SEARCH FOR OPTIMAL DAMPENING</span></span>
<span id="cb42-2410"><a href="#cb42-2410" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================</span></span>
<span id="cb42-2411"><a href="#cb42-2411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2412"><a href="#cb42-2412" aria-hidden="true" tabindex="-1"></a><span class="co"># Run grid search (test dampening from 0% to 30% in 1% increments)</span></span>
<span id="cb42-2413"><a href="#cb42-2413" aria-hidden="true" tabindex="-1"></a>grid_results, optimal_damping <span class="op">=</span> grid_search_dampening_factor(</span>
<span id="cb42-2414"><a href="#cb42-2414" aria-hidden="true" tabindex="-1"></a>    forecast_all, </span>
<span id="cb42-2415"><a href="#cb42-2415" aria-hidden="true" tabindex="-1"></a>    monthly_stats_all, </span>
<span id="cb42-2416"><a href="#cb42-2416" aria-hidden="true" tabindex="-1"></a>    X,</span>
<span id="cb42-2417"><a href="#cb42-2417" aria-hidden="true" tabindex="-1"></a>    damping_range<span class="op">=</span>np.arange(<span class="fl">0.0</span>, <span class="fl">0.31</span>, <span class="fl">0.01</span>)</span>
<span id="cb42-2418"><a href="#cb42-2418" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-2419"><a href="#cb42-2419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2420"><a href="#cb42-2420" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize grid search results</span></span>
<span id="cb42-2421"><a href="#cb42-2421" aria-hidden="true" tabindex="-1"></a>visualize_grid_search_results(grid_results, X, baseline_qualifying<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb42-2422"><a href="#cb42-2422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2423"><a href="#cb42-2423" aria-hidden="true" tabindex="-1"></a><span class="co"># Show comparison table</span></span>
<span id="cb42-2424"><a href="#cb42-2424" aria-hidden="true" tabindex="-1"></a>display_dampening_comparison_table(grid_results, key_values<span class="op">=</span>[<span class="fl">0.00</span>, <span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>])</span>
<span id="cb42-2425"><a href="#cb42-2425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2426"><a href="#cb42-2426" aria-hidden="true" tabindex="-1"></a><span class="co"># Now apply the OPTIMAL dampening factor</span></span>
<span id="cb42-2427"><a href="#cb42-2427" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2428"><a href="#cb42-2428" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"APPLYING OPTIMAL DAMPENING FACTOR: </span><span class="sc">{</span>optimal_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2429"><a href="#cb42-2429" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2430"><a href="#cb42-2430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2431"><a href="#cb42-2431" aria-hidden="true" tabindex="-1"></a>forecast_modified_optimal, hist_mean <span class="op">=</span> apply_conservative_strategy(</span>
<span id="cb42-2432"><a href="#cb42-2432" aria-hidden="true" tabindex="-1"></a>    forecast_all, </span>
<span id="cb42-2433"><a href="#cb42-2433" aria-hidden="true" tabindex="-1"></a>    damping_factor<span class="op">=</span>optimal_damping</span>
<span id="cb42-2434"><a href="#cb42-2434" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-2435"><a href="#cb42-2435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2436"><a href="#cb42-2436" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly Ï with optimal dampening</span></span>
<span id="cb42-2437"><a href="#cb42-2437" aria-hidden="true" tabindex="-1"></a>monthly_modified_optimal <span class="op">=</span> calculate_monthly_rho_with_strategy(forecast_modified_optimal)</span>
<span id="cb42-2438"><a href="#cb42-2438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2439"><a href="#cb42-2439" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate with optimal dampening</span></span>
<span id="cb42-2440"><a href="#cb42-2440" aria-hidden="true" tabindex="-1"></a>evaluation_optimal <span class="op">=</span> evaluate_strategy_performance(</span>
<span id="cb42-2441"><a href="#cb42-2441" aria-hidden="true" tabindex="-1"></a>    monthly_modified_optimal, </span>
<span id="cb42-2442"><a href="#cb42-2442" aria-hidden="true" tabindex="-1"></a>    forecast_modified_optimal, </span>
<span id="cb42-2443"><a href="#cb42-2443" aria-hidden="true" tabindex="-1"></a>    X</span>
<span id="cb42-2444"><a href="#cb42-2444" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-2445"><a href="#cb42-2445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2446"><a href="#cb42-2446" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize final results with optimal dampening</span></span>
<span id="cb42-2447"><a href="#cb42-2447" aria-hidden="true" tabindex="-1"></a>visualize_strategy_results(evaluation_optimal[<span class="st">'last_12_stats'</span>], X, evaluation_optimal)</span>
<span id="cb42-2448"><a href="#cb42-2448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2449"><a href="#cb42-2449" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2450"><a href="#cb42-2450" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OPTIMAL DAMPENING"</span>)</span>
<span id="cb42-2451"><a href="#cb42-2451" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-2452"><a href="#cb42-2452" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Optimal Dampening: </span><span class="sc">{</span>optimal_damping<span class="op">*</span><span class="dv">100</span><span class="sc">:.0f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2453"><a href="#cb42-2453" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>evaluation_optimal[<span class="st">'additional_months'</span>]<span class="sc">:+d}</span><span class="ss"> additional months"</span>)</span>
<span id="cb42-2454"><a href="#cb42-2454" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" MAE changed by </span><span class="sc">{</span>evaluation_optimal[<span class="st">'mae_change_pct'</span>]<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb42-2455"><a href="#cb42-2455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb42-2456"><a href="#cb42-2456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2457"><a href="#cb42-2457" aria-hidden="true" tabindex="-1"></a><span class="fu">## Limitations and Considerations</span></span>
<span id="cb42-2458"><a href="#cb42-2458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2459"><a href="#cb42-2459" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Data Limitations**</span>
<span id="cb42-2460"><a href="#cb42-2460" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Only 2.5 years of historical data (143 weeks)</span>
<span id="cb42-2461"><a href="#cb42-2461" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Limited to 21 months for horizon-2 analysis (need 52 weeks for initialization)</span>
<span id="cb42-2462"><a href="#cb42-2462" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Only analyzing Store 2 - results may not generalize to other stores</span>
<span id="cb42-2463"><a href="#cb42-2463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2464"><a href="#cb42-2464" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Model Assumptions**</span>
<span id="cb42-2465"><a href="#cb42-2465" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Assumes future patterns similar to past (stationarity)</span>
<span id="cb42-2466"><a href="#cb42-2466" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>No incorporation of external factors (promotions, competitors, economy)</span>
<span id="cb42-2467"><a href="#cb42-2467" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Fixed seasonal pattern (52-week cycle)</span>
<span id="cb42-2468"><a href="#cb42-2468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2469"><a href="#cb42-2469" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Strategy Limitations**</span>
<span id="cb42-2470"><a href="#cb42-2470" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Dampening is a post-hoc adjustment, not part of the model</span>
<span id="cb42-2471"><a href="#cb42-2471" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Assumes supplier contract terms remain constant</span>
<span id="cb42-2472"><a href="#cb42-2472" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Historical mean may drift over time</span>
<span id="cb42-2473"><a href="#cb42-2473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2474"><a href="#cb42-2474" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Business Context**</span>
<span id="cb42-2475"><a href="#cb42-2475" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Rebate contract terms (Â±X%) determined historically</span>
<span id="cb42-2476"><a href="#cb42-2476" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Actual supplier may use different evaluation criteria</span>
<span id="cb42-2477"><a href="#cb42-2477" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Does not account for inventory holding costs vs. stockout costs</span>
<span id="cb42-2478"><a href="#cb42-2478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2479"><a href="#cb42-2479" aria-hidden="true" tabindex="-1"></a>---</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>